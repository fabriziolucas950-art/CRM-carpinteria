<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Fabrizio Amoblamientos v1.1</title>
    <!-- React & Babel for standalone use -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Dependencias obligatorias para Recharts -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.js"></script>
    <script src="https://unpkg.com/react-is@18.2.0/umd/react-is.production.min.js"></script>
    <!-- Recharts (Versión Fija Estable) -->
    <script src="https://unpkg.com/recharts@2.1.9/umd/Recharts.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Supabase CDN y Configuración -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Datos copiados de tú proyecto en Supabase
        const supabaseUrl = 'https://yjtljilaxvdescadkzqk.supabase.co';
        const supabaseKey = 'sb_publishable_Ik5EOjfzdK1wVYanYITuuw_bObZw1ak';

        // Inicializamos Supabase y lo guardamos en global para usarlo en React
        window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        console.log("Supabase conectado y listo para usarse");
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-item:hover {
            background: rgba(59, 130, 246, 0.2);
            border-left: 4px solid #3b82f6;
        }

        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.3);
            border-left: 4px solid #3b82f6;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons Helper ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const spanRef = React.useRef(null);

            useEffect(() => {
                if (spanRef.current) {
                    // Al usar innerHTML, ocultamos el <i> del control del árbol de React.
                    // Lucide transformará este <i> en un <svg> pero React sólo se preocupará de desmontar el <span> padre
                    // Esto arregla el crasheo críptico (NotFoundError: Failed to execute 'removeChild')
                    spanRef.current.innerHTML = `<i data-lucide="${name}" class="${className}" style="width: ${size}px; height: ${size}px;"></i>`;
                    lucide.createIcons();
                }
            }, [name, size, className]);

            return <span ref={spanRef} style={{ display: 'contents' }}></span>;
        };

        // --- Layout Components ---
        const Sidebar = ({ currentTab, setTab, isOpen, setIsOpen, onLogout, userRole = 'viewer' }) => {
            const [adminOpen, setAdminOpen] = useState(true);

            const menuItems = [
                { id: 'dashboard', label: 'Inicio', icon: 'layout-grid', roles: ['admin', 'editor', 'viewer'] },
                { id: 'clients', label: 'Clientes', icon: 'users', roles: ['admin', 'editor', 'viewer'] },
                { id: 'quoter', label: 'Cotizador', icon: 'file-text', roles: ['admin', 'editor'] }
            ];

            const adminItems = [
                { id: 'prices', label: 'Lista de Precios', icon: 'tag', roles: ['admin', 'editor'] },
                { id: 'suppliers', label: 'Proveedores', icon: 'truck', roles: ['admin', 'editor'] },
                { id: 'costs', label: 'Costos Operativos', icon: 'trending-down', roles: ['admin', 'editor'] },
                { id: 'statistics', label: 'Estadísticas', icon: 'bar-chart-2', roles: ['admin'] },
                { id: 'users', label: 'Equipo', icon: 'users', roles: ['admin'] }
            ];

            const filteredMain = menuItems.filter(item => item.roles.includes(userRole));
            const filteredAdmin = adminItems.filter(item => item.roles.includes(userRole));

            return (
                <>
                    {/* Backdrop for mobile */}
                    {isOpen && (
                        <div
                            className="fixed inset-0 bg-black/50 z-[80] lg:hidden transition-opacity"
                            onClick={() => setIsOpen(false)}
                        ></div>
                    )}

                    <div className={`w-64 h-screen fixed left-0 top-0 flex flex-col p-4 z-[90] transition-all duration-300 transform 
                        ${isOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`} style={{ background: 'rgba(30, 41, 59, 0.6)', backdropFilter: 'blur(20px)', borderRight: '1px solid rgba(255, 255, 255, 0.05)' }}>

                        <div className="flex justify-between items-center mb-8 px-2 mt-2">
                            <div className="flex items-center gap-3">
                                <div className="bg-slate-100 p-1 rounded-lg flex items-center justify-center border border-white/20" style={{ width: '40px', height: '40px' }}>
                                    <img src="data:image/png;base64,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" alt="Logo" className="w-full h-full object-contain" />
                                </div>
                                <div className="flex flex-col">
                                    <h1 className="font-bold text-lg text-white tracking-tight leading-tight">Fabrizio</h1>
                                    <span className="text-blue-500 text-[13px] font-medium mt-0.5">Admin</span>
                                </div>
                            </div>
                            <button onClick={() => setIsOpen(false)} className="lg:hidden p-1 text-slate-400">
                                <Icon name="x" size={24} />
                            </button>
                        </div>

                        <nav className="flex-grow overflow-y-auto pr-2">
                            <ul className="space-y-1.5 mt-2">
                                {filteredMain.map(item => (
                                    <li key={item.id}>
                                        <button
                                            onClick={() => { setTab(item.id); setIsOpen(false); }}
                                            className={`w-full flex items-center gap-3.5 px-4 py-3.5 rounded-xl transition-all font-medium text-[15px]
                                                ${currentTab === item.id
                                                    ? 'bg-blue-600/20 text-blue-100 shadow-[inset_0_1px_0_rgba(255,255,255,0.1)]'
                                                    : 'text-slate-300 hover:bg-slate-800/50 hover:text-white'}`}
                                        >
                                            <div className="flex items-center gap-3.5 w-full relative">
                                                {currentTab === item.id && (
                                                    <div className="absolute -left-4 top-1/2 -translate-y-1/2 w-1 h-6 bg-blue-400 rounded-r-md"></div>
                                                )}
                                                <Icon name={item.icon} size={20} className={currentTab === item.id ? 'text-blue-400' : 'text-slate-400'} />
                                                {item.label}
                                            </div>
                                        </button>
                                    </li>
                                ))}

                                {filteredAdmin.length > 0 && (
                                    <li className="pt-2">
                                        <button
                                            onClick={() => setAdminOpen(!adminOpen)}
                                            className={`w-full flex items-center justify-between px-4 py-3 rounded-xl transition-all font-medium text-[15px] text-slate-200 
                                                ${adminOpen ? 'bg-slate-800/80 shadow-inner' : 'hover:bg-slate-800/50'}`}
                                        >
                                            <div className="flex items-center gap-3.5">
                                                <Icon name="folder" size={20} className="text-slate-400" />
                                                Administración
                                            </div>
                                            <Icon name={adminOpen ? "chevron-up" : "chevron-down"} size={16} className="text-slate-500" />
                                        </button>

                                        {adminOpen && (
                                            <ul className="mt-1.5 space-y-1 relative before:absolute before:inset-y-0 before:left-[23px] before:w-px before:from-slate-700/50 before:to-transparent before:bg-gradient-to-b pl-2">
                                                {filteredAdmin.map(item => (
                                                    <li key={item.id}>
                                                        <button
                                                            onClick={() => { setTab(item.id); setIsOpen(false); }}
                                                            className={`w-full flex items-center gap-3.5 px-4 py-3 rounded-xl transition-all font-medium text-[14px]
                                                                ${currentTab === item.id
                                                                    ? 'bg-blue-600/10 text-blue-100'
                                                                    : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/30'}`}
                                                        >
                                                            <div className="ml-5 flex items-center gap-3.5">
                                                                <Icon name={item.icon} size={18} className={currentTab === item.id ? 'text-blue-400' : 'text-slate-500'} />
                                                                {item.label}
                                                            </div>
                                                        </button>
                                                    </li>
                                                ))}
                                            </ul>
                                        )}
                                    </li>
                                )}
                            </ul>
                        </nav>

                        <div className="mt-auto pt-6 pb-4">
                            <button
                                onClick={onLogout}
                                className="w-full flex items-center justify-center gap-2 py-3 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors shadow-lg shadow-red-500/20"
                            >
                                <Icon name="log-out" size={20} className="rotate-0 text-white" /> Salir
                            </button>
                        </div>
                    </div>
                </>
            );
        };

        // --- Modules ---

        const Dashboard = ({ tenantId, setTab }) => {
            const [isLoading, setIsLoading] = useState(true);
            const [stats, setStats] = useState({ totalGastos: 0, totalClientes: 0 });
            const [alerts, setAlerts] = useState([]);

            useEffect(() => {
                const loadGlobalStats = async () => {
                    if (!tenantId) return;
                    setIsLoading(true);
                    try {
                        let newAlerts = [];

                        // 1. Total Clientes & Alertas de Deudores
                        const { data: clientesData, count: countClientes, error: errorClientes } = await window.supabaseClient
                            .from('clientes')
                            .select('id, name, budgets:presupuestos(total, paid, status)', { count: 'exact', head: false })
                            .eq('tenant_id', tenantId);

                        // 2. Total Gastos Operativos
                        const { data: gastosData, error: errorGastos } = await window.supabaseClient
                            .from('costos_operativos')
                            .select('monto')
                            .eq('tenant_id', tenantId);

                        // 3. Proveedores & Alertas de Deudas
                        const { data: proveedoresData, error: errorProveedores } = await window.supabaseClient
                            .from('proveedores')
                            .select('id, name, debts')
                            .eq('tenant_id', tenantId);

                        if (errorClientes) console.error("Error clientes:", errorClientes);
                        if (errorGastos) console.error("Error gastos:", errorGastos);
                        if (errorProveedores) console.error("Error proveedores:", errorProveedores);

                        let sumGastos = 0;
                        if (gastosData) {
                            sumGastos = gastosData.reduce((acc, curr) => acc + (Number(curr.monto) || 0), 0);
                        }

                        // Procesar Alertas = Clientes que deben
                        if (clientesData) {
                            clientesData.forEach(c => {
                                if (c.budgets) {
                                    let owed = 0;
                                    c.budgets.forEach(b => {
                                        if (b.status !== 'rechazado') {
                                            const debt = (b.total || 0) - (b.paid || 0);
                                            if (debt > 0) owed += debt;
                                        }
                                    });
                                    if (owed > 0) {
                                        newAlerts.push({
                                            id: `client_${c.id}`,
                                            type: 'client',
                                            title: `Cobro Pendiente: ${c.name}`,
                                            amount: owed,
                                            icon: 'alert-circle',
                                            color: 'text-orange-400',
                                            bg: 'bg-orange-500/20',
                                            border: 'border-orange-500/50',
                                            actionTab: 'clients'
                                        });
                                    }
                                }
                            });
                        }

                        // Procesar Alertas = Deudas a Proveedores
                        if (proveedoresData) {
                            proveedoresData.forEach(p => {
                                if (p.debts && p.debts.length > 0) {
                                    const owedSup = p.debts.reduce((sum, d) => sum + (d.amount || 0), 0);
                                    if (owedSup > 0) {
                                        newAlerts.push({
                                            id: `supplier_${p.id}`,
                                            type: 'supplier',
                                            title: `Pago Atrasado: ${p.name}`,
                                            amount: owedSup,
                                            icon: 'trending-down',
                                            color: 'text-red-400',
                                            bg: 'bg-red-500/20',
                                            border: 'border-red-500/50',
                                            actionTab: 'suppliers'
                                        });
                                    }
                                }
                            });
                        }

                        // Ordenar alertas por monto mayor a menor
                        newAlerts.sort((a, b) => b.amount - a.amount);

                        setStats({
                            totalGastos: sumGastos,
                            totalClientes: countClientes || 0
                        });
                        setAlerts(newAlerts);
                    } catch (err) {
                        console.error("Error global stats:", err);
                    } finally {
                        setIsLoading(false);
                    }
                };

                loadGlobalStats();
            }, [tenantId]);

            return (
                <div className="p-4 md:p-8 pb-20">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                        <div>
                            <h2 className="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">Resumen Principal</h2>
                            <p className="text-slate-400 text-sm mt-1">Vista general del estado de tu negocio.</p>
                        </div>
                    </div>

                    {isLoading ? (
                        <div className="flex justify-center items-center py-20">
                            <span className="animate-spin border-4 border-slate-700 border-t-blue-500 rounded-full w-12 h-12"></span>
                        </div>
                    ) : (
                        <>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">

                                {/* KPI: Gastos Totales */}
                                <div className="glass p-6 rounded-2xl relative overflow-hidden group">
                                    <div className="absolute -right-6 -top-6 text-red-500/10 group-hover:text-red-500/20 transition-colors">
                                        <Icon name="trending-down" size={120} />
                                    </div>
                                    <div className="relative z-10">
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className="p-3 bg-red-500/20 text-red-400 rounded-xl">
                                                <Icon name="receipt" size={24} />
                                            </div>
                                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">Gastos Operativos (Histórico)</h3>
                                        </div>
                                        <p className="text-4xl font-black text-slate-100 flex items-baseline gap-1">
                                            <span className="text-xl text-red-400">$</span>
                                            {stats.totalGastos.toLocaleString()}
                                        </p>
                                        <button onClick={() => setTab('costs')} className="mt-6 text-sm text-blue-400 hover:text-blue-300 font-bold flex items-center gap-1">Ver detalles <Icon name="arrow-right" size={14} /></button>
                                    </div>
                                </div>

                                {/* KPI: Clientes Activos */}
                                <div className="glass p-6 rounded-2xl relative overflow-hidden group">
                                    <div className="absolute -right-6 -top-6 text-blue-500/10 group-hover:text-blue-500/20 transition-colors">
                                        <Icon name="users" size={120} />
                                    </div>
                                    <div className="relative z-10">
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className="p-3 bg-blue-500/20 text-blue-400 rounded-xl">
                                                <Icon name="user-check" size={24} />
                                            </div>
                                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">Clientes Registrados</h3>
                                        </div>
                                        <p className="text-4xl font-black text-slate-100">
                                            {stats.totalClientes}
                                        </p>
                                        <button onClick={() => { setTab('clients'); setTimeout(() => window.dispatchEvent(new CustomEvent('focus-new-client')), 100); }} className="mt-6 text-sm bg-emerald-600/30 hover:bg-emerald-600/50 border border-emerald-500/50 text-emerald-400 hover:text-emerald-300 font-bold flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-colors">
                                            <Icon name="user-plus" size={14} /> Nuevo Cliente
                                        </button>
                                    </div>
                                </div>

                                {/* Acciones Rápidas */}
                                <div className="glass p-6 rounded-2xl flex flex-col justify-center">
                                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Acciones Rápidas</h3>
                                    <div className="space-y-3">
                                        <button onClick={() => setTab('quoter')} className="w-full bg-blue-600/30 hover:bg-blue-600/50 border border-blue-500/50 text-blue-400 p-3 rounded-xl flex justify-between items-center transition-colors font-bold">
                                            <span>Generar Presupuesto</span>
                                            <Icon name="plus-circle" size={18} />
                                        </button>
                                        <button onClick={() => setTab('costs')} className="w-full bg-orange-600/30 hover:bg-orange-600/50 border border-orange-500/50 text-orange-400 p-3 rounded-xl flex justify-between items-center transition-colors font-bold">
                                            <span>Cargar Gasto Operativo</span>
                                            <Icon name="dollar-sign" size={18} />
                                        </button>
                                    </div>
                                </div>

                            </div>

                            {/* Alertas */}
                            <div className="glass p-6 rounded-2xl">
                                <div className="flex items-center gap-3 mb-6">
                                    <Icon name="bell" className="text-yellow-400" />
                                    <h3 className="text-lg font-bold text-slate-100 uppercase tracking-wider">Centro de Alertas ({alerts.length})</h3>
                                </div>

                                {alerts.length === 0 ? (
                                    <div className="text-center py-10 bg-slate-800/30 rounded-xl border border-dashed border-slate-700">
                                        <div className="text-slate-500 mb-2 flex justify-center"><Icon name="check-circle" size={32} /></div>
                                        <p className="text-slate-400 font-medium">Todo al día. No hay alertas pendientes por resolver.</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {alerts.map(alert => (
                                            <div key={alert.id} className={`p-4 rounded-xl border ${alert.bg} ${alert.border} backdrop-blur-sm flex justify-between items-center group`}>
                                                <div className="flex items-center gap-4">
                                                    <div className={`p-2 rounded-lg bg-slate-900/50 ${alert.color}`}>
                                                        <Icon name={alert.icon} size={20} />
                                                    </div>
                                                    <div>
                                                        <span className={`block text-xs font-bold uppercase tracking-wider ${alert.color} mb-1`}>{alert.title}</span>
                                                        <span className="block text-xl font-black text-slate-200">${alert.amount.toLocaleString()}</span>
                                                    </div>
                                                </div>
                                                <button onClick={() => setTab(alert.actionTab)} className={`opacity-0 group-hover:opacity-100 transition-opacity p-2 rounded-lg bg-slate-900/80 ${alert.color} hover:text-white`} title="Resolver">
                                                    <Icon name="arrow-right" size={18} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </>
                    )}
                </div>
            )
        };


        const ClientManager = ({ clients, setClients, tenantId }) => {
            const [newClient, setNewClient] = useState({ name: '', phone: '', address: '', city: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('recent');
            const [expandedClients, setExpandedClients] = useState({});
            const [isLoading, setIsLoading] = useState(false);
            const [editingClient, setEditingClient] = useState(null);
            const [editingBudget, setEditingBudget] = useState(null);
            const [paymentModal, setPaymentModal] = useState(null);
            const newClientNameRef = React.useRef(null);
            const toggleClient = (id) => setExpandedClients(prev => ({ ...prev, [id]: !prev[id] }));

            // Cargar clientes desde Supabase al montar el componente
            useEffect(() => {
                fetchClients();
            }, []);

            // Escuchar evento para enfocar el formulario de nuevo cliente desde el Dashboard
            useEffect(() => {
                const handleFocusNewClient = () => {
                    if (newClientNameRef.current) {
                        newClientNameRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        newClientNameRef.current.focus();
                    }
                };
                window.addEventListener('focus-new-client', handleFocusNewClient);
                return () => window.removeEventListener('focus-new-client', handleFocusNewClient);
            }, []);

            const fetchClients = async () => {
                setIsLoading(true);
                try {
                    const { data, error } = await window.supabaseClient
                        .from('clientes')
                        .select('*, budgets:presupuestos(*)')
                        .order('id', { ascending: false });

                    if (error) throw error;
                    // Los presupuestos ya vienen dentro de la propiedad "budgets" gracias al alias
                    setClients(data || []);
                } catch (error) {
                    console.error('Error al cargar clientes:', error);
                    window.addToast("Error al cargar datos desde Supabase: " + error.message, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const addClient = async () => {
                if (!newClient.name) return;
                setIsLoading(true);

                try {
                    const { data, error } = await window.supabaseClient
                        .from('clientes')
                        .insert([
                            {
                                tenant_id: tenantId,
                                name: newClient.name,
                                phone: newClient.phone,
                                address: newClient.address,
                                city: newClient.city
                            }
                        ])
                        .select(); // Devuelve el registro insertado

                    if (error) throw error;

                    if (data && data.length > 0) {
                        setClients([...clients, data[0]]);
                        setNewClient({ name: '', phone: '', address: '', city: '' });
                    }
                } catch (error) {
                    console.error('Error al agregar cliente:', error);
                    window.addToast("Error al guardar en Supabase: " + error.message, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const deleteClient = async (id) => {
                if (!(await window.confirmAsync('¿Seguro que deseas eliminar este cliente permanentemente?'))) return;

                try {
                    const { error } = await window.supabaseClient
                        .from('clientes')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    setClients(clients.filter(c => c.id !== id));
                } catch (error) {
                    console.error('Error al eliminar cliente:', error);
                    window.addToast("Error al eliminar en Supabase: " + error.message, 'error');
                }
            };

            const handleAddPayment = async (e) => {
                e.preventDefault();
                if (!paymentModal.amount || isNaN(paymentModal.amount)) return;
                setIsLoading(true);
                const { client, budget, amount, method } = paymentModal;
                const numAmount = parseFloat(amount);
                const newPaid = (budget.paid || 0) + numAmount;
                const newHistoryItem = {
                    date: new Date().toISOString(),
                    amount: numAmount,
                    method: method
                };
                const newPaymentHistory = [...(budget.payment_history || []), newHistoryItem];

                try {
                    await window.supabaseClient.from('transacciones_clientes').insert([{
                        tenant_id: tenantId,
                        client_id: client.id,
                        tipo: 'COBRO',
                        monto: numAmount,
                        descripcion: `Pago sobre Presupuesto: ${budget.summary} (${method})`
                    }]);

                    const { error } = await window.supabaseClient
                        .from('presupuestos')
                        .update({ paid: newPaid, payment_history: newPaymentHistory })
                        .eq('id', budget.id);

                    if (error) throw error;

                    const updated = clients.map(c => {
                        if (c.id === client.id) {
                            return {
                                ...c,
                                budgets: c.budgets.map(b =>
                                    b.id === budget.id ? { ...b, paid: newPaid, payment_history: newPaymentHistory } : b
                                )
                            };
                        }
                        return c;
                    });
                    setClients(updated);
                    setPaymentModal(null);
                } catch (error) {
                    console.error('Error adding payment:', error);
                    window.addToast("Error al procesar pago: " + error.message, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const updateClient = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                try {
                    const { error } = await window.supabaseClient
                        .from('clientes')
                        .update({
                            name: editingClient.name,
                            phone: editingClient.phone,
                            address: editingClient.address,
                            city: editingClient.city
                        })
                        .eq('id', editingClient.id);

                    if (error) throw error;

                    setClients(clients.map(c => c.id === editingClient.id ? editingClient : c));
                    setEditingClient(null);
                } catch (error) {
                    console.error("Error updating client", error);
                    window.addToast("Error al actualizar cliente.", 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const updateBudget = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                try {
                    const { error } = await window.supabaseClient
                        .from('presupuestos')
                        .update({
                            date: editingBudget.date,
                            summary: editingBudget.summary,
                            total: parseFloat(editingBudget.total) || 0
                        })
                        .eq('id', editingBudget.id);

                    if (error) throw error;

                    const updatedClients = clients.map(c => {
                        if (c.id === editingBudget.client_id) {
                            return {
                                ...c,
                                budgets: c.budgets.map(b => b.id === editingBudget.id ? {
                                    ...b,
                                    date: editingBudget.date,
                                    summary: editingBudget.summary,
                                    total: parseFloat(editingBudget.total) || 0
                                } : b)
                            };
                        }
                        return c;
                    });
                    setClients(updatedClients);
                    setEditingBudget(null);
                } catch (error) {
                    console.error("Error updating budget", error);
                    window.addToast("Error al actualizar presupuesto.", 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="p-4 md:p-8">
                    <div className="flex flex-col md:flex-row md:items-center justify-between mb-6 md:mb-8 gap-4">
                        <h2 className="text-2xl md:text-3xl font-bold">Mis Clientes</h2>
                        <div className="relative w-full md:w-auto flex gap-2">
                            <div className="relative flex-1 md:w-72">
                                <Icon name="search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                <input
                                    type="text"
                                    placeholder="Buscar clientes..."
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                    className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg pl-10 pr-4 py-2.5 focus:ring-2 ring-blue-500 outline-none text-sm text-slate-200 transition-all placeholder-slate-500 focus:bg-slate-800"
                                />
                            </div>
                            <select
                                value={sortBy}
                                onChange={e => setSortBy(e.target.value)}
                                className="bg-slate-800/50 border border-slate-700/50 rounded-lg px-3 py-2.5 outline-none text-sm text-slate-200 focus:ring-2 ring-blue-500 cursor-pointer"
                            >
                                <option value="recent">Recientes</option>
                                <option value="debt">Con Deuda</option>
                            </select>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-1 glass p-6 rounded-2xl h-fit">
                            <h3 className="text-xl font-semibold mb-6">Nuevo Cliente</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Nombre Completo</label>
                                    <input ref={newClientNameRef} value={newClient.name} onChange={e => setNewClient({ ...newClient, name: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="Juan Perez" />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">WhatsApp</label>
                                    <input value={newClient.phone} onChange={e => setNewClient({ ...newClient, phone: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="+54 9..." />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Dirección / Obra</label>
                                    <input value={newClient.address} onChange={e => setNewClient({ ...newClient, address: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="Calle Falsa 123" />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Localidad</label>
                                    <input
                                        value={newClient.city}
                                        onChange={e => setNewClient({ ...newClient, city: e.target.value })}
                                        className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none"
                                        placeholder="Ej: Junín"
                                    />
                                </div>
                                <button onClick={addClient} disabled={isLoading} className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 p-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2">
                                    <Icon name="user-plus" /> {isLoading ? 'Guardando...' : 'Guardar Cliente'}
                                </button>
                            </div>
                        </div>

                        <div className="lg:col-span-2 space-y-4">
                            {(() => {
                                let filteredClients = clients.filter(c => {
                                    const search = searchTerm.toLowerCase();
                                    return (c.name || '').toLowerCase().includes(search) ||
                                        (c.phone || '').toLowerCase().includes(search) ||
                                        (c.address || '').toLowerCase().includes(search) ||
                                        (c.city || '').toLowerCase().includes(search);
                                });

                                if (sortBy === 'debt') {
                                    filteredClients.sort((a, b) => {
                                        const debtA = (a.budgets || []).reduce((acc, bud) => acc + (bud.total - (bud.paid || 0)), 0);
                                        const debtB = (b.budgets || []).reduce((acc, bud) => acc + (bud.total - (bud.paid || 0)), 0);
                                        return debtB - debtA;
                                    });
                                } else {
                                    filteredClients.sort((a, b) => b.id - a.id);
                                }

                                if (clients.length === 0) {
                                    return <div className="glass p-10 rounded-2xl text-center text-slate-500">No hay clientes registrados</div>;
                                }

                                if (filteredClients.length === 0) {
                                    return <div className="glass p-10 rounded-2xl text-center text-slate-500">Ningún cliente coincide con la búsqueda '{searchTerm}'</div>;
                                }

                                return filteredClients.map(c => {
                                    const totalDebt = (c.budgets || []).reduce((acc, b) => acc + (b.total - (b.paid || 0)), 0);

                                    return (
                                        <div key={c.id} className="glass p-6 rounded-2xl group hover:border-blue-500/50 transition-all space-y-4">
                                            <div className="flex flex-col sm:flex-row sm:items-start justify-between gap-4">
                                                <div className="flex gap-4 items-start">
                                                    <div className="w-12 h-12 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400 font-bold text-xl uppercase shrink-0">
                                                        {c.name ? c.name[0] : '?'}
                                                    </div>
                                                    <div>
                                                        <h4 className="font-semibold text-lg">{c.name || 'Sin nombre'}</h4>
                                                        <div className="flex flex-col sm:flex-row sm:gap-4 text-xs sm:text-sm text-slate-400 mb-2 mt-1">
                                                            <span className="flex items-center gap-1"><Icon name="phone" size={14} /> {c.phone || '-'}</span>
                                                            <span className="flex items-center gap-1"><Icon name="map-pin" size={14} /> {c.address || '-'}</span>
                                                        </div>
                                                        <div className="flex flex-wrap gap-2">
                                                            {c.city && <span className="bg-blue-500/20 text-blue-400 border border-blue-500/30 px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider">{c.city}</span>}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex flex-col items-end gap-3 h-full justify-between">
                                                    {totalDebt > 0 && (
                                                        <div className="bg-orange-500/10 text-orange-400 border border-orange-500/20 px-3 py-1.5 rounded-lg text-xs font-bold font-mono tracking-wider shadow-sm flex items-center gap-2">
                                                            <Icon name="alert-circle" size={14} /> DEUDA: ${totalDebt.toLocaleString()}
                                                        </div>
                                                    )}
                                                    <div className="flex gap-2">
                                                        <button onClick={() => setEditingClient(c)} className="p-2 glass rounded-lg hover:bg-slate-500/20 text-slate-400" title="Editar Cliente"><Icon name="edit" /></button>
                                                        <a href={c.phone ? `https://wa.me/${c.phone.replace(/\D/g, '')}` : '#'} target={c.phone ? "_blank" : "_self"} className="p-2 glass rounded-lg hover:bg-green-500/20 text-green-400" title="WhatsApp"><Icon name="message-circle" /></a>
                                                        <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${c.address || ''} ${c.city || ''}`)}`} target="_blank" className="p-2 glass rounded-lg hover:bg-blue-500/20 text-blue-400" title="Google Maps"><Icon name="map" /></a>
                                                        <button onClick={() => deleteClient(c.id)} className="p-2 glass rounded-lg hover:bg-red-500/20 text-red-400" title="Eliminar Cliente"><Icon name="trash-2" /></button>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Budgets History */}
                                            <div className="border-t border-slate-700/50 pt-3">
                                                <button onClick={() => toggleClient(c.id)} className="flex w-full justify-between items-center mb-3 group/toggle">
                                                    <h5 className="text-[10px] uppercase text-slate-500 group-hover/toggle:text-slate-300 font-bold flex items-center gap-2 tracking-wider transition-colors">
                                                        <Icon name="history" size={12} /> Presupuestos Registrados
                                                    </h5>
                                                    <span className={`text-slate-500 group-hover/toggle:text-slate-300 transition-all duration-200 ${expandedClients[c.id] ? 'rotate-180' : ''}`}>
                                                        <Icon name="chevron-down" size={14} />
                                                    </span>
                                                </button>
                                                {expandedClients[c.id] && (
                                                    <div className="space-y-3">
                                                        {(!c.budgets || c.budgets.length === 0) ? (
                                                            <p className="text-xs text-slate-600 italic">No hay cotizaciones registradas para este cliente.</p>
                                                        ) : (
                                                            c.budgets.slice().reverse().map((b, idx) => {
                                                                const paid = b.paid || 0;
                                                                const balance = b.total - paid;
                                                                const isFullyPaid = balance <= 0;

                                                                const openPaymentModal = () => {
                                                                    setPaymentModal({ client: c, budget: b, amount: "", method: "Efectivo" });
                                                                };

                                                                const updateBudgetStatus = async (newStatus) => {
                                                                    try {
                                                                        const { error } = await window.supabaseClient
                                                                            .from('presupuestos')
                                                                            .update({ status: newStatus })
                                                                            .eq('id', b.id);
                                                                        if (error) throw error;
                                                                        const updated = clients.map(client => client.id === c.id ? {
                                                                            ...client,
                                                                            budgets: client.budgets.map(bud => bud.id === b.id ? { ...bud, status: newStatus } : bud)
                                                                        } : client);
                                                                        setClients(updated);
                                                                    } catch (error) {
                                                                        console.error("Error updating status", error);
                                                                        window.addToast("Error al actualizar estado: " + error.message, 'error');
                                                                    }
                                                                };

                                                                const handleFileUpload = async (event, type) => {
                                                                    const file = event.target.files[0];
                                                                    if (!file) return;

                                                                    const fileExt = file.name.split('.').pop();
                                                                    const fileName = `${tenantId}/${c.id}/${b.id}/${type}_${Date.now()}.${fileExt}`;

                                                                    let note = '';
                                                                    if (type === 'plans') {
                                                                        note = prompt("¿Quién tomó las medidas? (Opcional, Ej: Carlos, Lucas, Cliente):", "");
                                                                        if (note === null) return; // Canceló
                                                                    } else if (type === 'receipts') {
                                                                        note = prompt("Anotación para el comprobante (Opcional, Ej: Seña 50% Transferencia):", "");
                                                                        if (note === null) return; // Canceló
                                                                    }

                                                                    try {
                                                                        window.addToast("Subiendo archivo, espere...", 'info');
                                                                        const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                                                                            .from('archivos_crm')
                                                                            .upload(fileName, file);

                                                                        if (uploadError) throw uploadError;

                                                                        const { data: urlData } = window.supabaseClient.storage.from('archivos_crm').getPublicUrl(fileName);
                                                                        const fileUrl = urlData.publicUrl;

                                                                        const newFileObj = {
                                                                            url: fileUrl,
                                                                            name: file.name,
                                                                            note: note || '',
                                                                            date: new Date().toISOString()
                                                                        };

                                                                        const currentFiles = b[type] || [];
                                                                        const updatedFiles = [...currentFiles, newFileObj];

                                                                        const { error: dbError } = await window.supabaseClient
                                                                            .from('presupuestos')
                                                                            .update({ [type]: updatedFiles })
                                                                            .eq('id', b.id);

                                                                        if (dbError) throw dbError;

                                                                        const updated = clients.map(client => client.id === c.id ? {
                                                                            ...client,
                                                                            budgets: client.budgets.map(bud => bud.id === b.id ? { ...bud, [type]: updatedFiles } : bud)
                                                                        } : client);
                                                                        setClients(updated);
                                                                        window.addToast("¡Archivo subido exitosamente!", 'success');
                                                                    } catch (error) {
                                                                        console.error("Error uploading file", error);
                                                                        window.addToast("Error al subir archivo: " + error.message, 'error');
                                                                    }
                                                                };

                                                                return (
                                                                    <div key={b.id || idx} className={`bg-slate-900/40 p-4 rounded-xl border transition-all ${isFullyPaid ? 'border-emerald-500/30' : 'border-transparent hover:border-slate-700'}`}>
                                                                        <div className="flex justify-between items-start mb-3">
                                                                            <div className="flex-grow">
                                                                                <span className="text-slate-400 text-[10px] block mb-1 font-mono uppercase">
                                                                                    {b.date ? new Date(b.date).toLocaleDateString('es-AR', { timeZone: 'UTC' }) : ''}
                                                                                </span>
                                                                                <span className="text-slate-200 block text-sm leading-tight font-medium">{b.summary}</span>
                                                                            </div>
                                                                            <div className="flex gap-1.5 flex-wrap justify-end">
                                                                                <button onClick={() => setEditingBudget({ ...b, client_id: c.id })} className="flex items-center gap-1.5 bg-slate-600/20 text-slate-400 hover:bg-slate-600/40 px-2 py-1 rounded-md text-[10px] font-bold uppercase transition-colors shrink-0 mt-1" title="Editar Presupuesto">
                                                                                    <Icon name="edit" size={12} /> Editar
                                                                                </button>
                                                                                <button onClick={openPaymentModal} className="flex items-center gap-1.5 bg-blue-600/20 text-blue-400 hover:bg-blue-600/40 px-2 py-1 rounded-md text-[10px] font-bold uppercase transition-colors shrink-0 mt-1">
                                                                                    <Icon name="plus" size={12} /> Pago
                                                                                </button>
                                                                            </div>
                                                                        </div>

                                                                        {/* Actions: Status + Attachments */}
                                                                        <div className="flex items-center gap-2 mb-3 overflow-x-auto pb-1 custom-scrollbar">
                                                                            <button onClick={() => updateBudgetStatus('aprobado')} title="Marcar como Aprobado" className={`shrink-0 flex justify-center items-center gap-1 text-[10px] font-bold uppercase px-3 py-1.5 rounded-md border transition-colors ${b.status === 'aprobado' ? 'bg-emerald-500/20 border-emerald-500/50 text-emerald-400' : 'bg-slate-800/50 border-slate-700/50 text-slate-400 hover:bg-slate-700'}`}><Icon name="check-circle" size={12} /> Aprobado</button>
                                                                            <button onClick={() => updateBudgetStatus('rechazado')} title="Marcar como Rechazado" className={`shrink-0 flex justify-center items-center gap-1 text-[10px] font-bold uppercase px-3 py-1.5 rounded-md border transition-colors ${b.status === 'rechazado' ? 'bg-red-500/20 border-red-500/50 text-red-400' : 'bg-slate-800/50 border-slate-700/50 text-slate-400 hover:bg-slate-700'}`}><Icon name="x-circle" size={12} /> Rechazado</button>
                                                                            <button onClick={() => updateBudgetStatus('terminado')} title="Marcar como Terminado" className={`shrink-0 flex justify-center items-center gap-1 text-[10px] font-bold uppercase px-3 py-1.5 rounded-md border transition-colors ${b.status === 'terminado' ? 'bg-slate-600/50 border-slate-500/50 text-slate-300' : 'bg-slate-800/50 border-slate-700/50 text-slate-400 hover:bg-slate-700'}`}><Icon name="package" size={12} /> Terminado</button>

                                                                            <div className="shrink-0 relative">
                                                                                <input type="file" id={`upload-receipt-${b.id}`} className="hidden" accept="image/*,.pdf" onChange={(e) => handleFileUpload(e, 'receipts')} />
                                                                                <label htmlFor={`upload-receipt-${b.id}`} className="flex items-center justify-center gap-1.5 bg-orange-600/90 hover:bg-orange-500 text-white px-3 py-1.5 rounded-md text-[10px] font-bold uppercase transition-colors cursor-pointer whitespace-nowrap">
                                                                                    Adjuntar Comprobante
                                                                                </label>
                                                                            </div>
                                                                            <div className="shrink-0 relative">
                                                                                <input type="file" id={`upload-plan-${b.id}`} className="hidden" accept="image/*,.pdf" onChange={(e) => handleFileUpload(e, 'plans')} />
                                                                                <label htmlFor={`upload-plan-${b.id}`} className="flex items-center justify-center gap-1.5 bg-orange-600/90 hover:bg-orange-500 text-white px-3 py-1.5 rounded-md text-[10px] font-bold uppercase transition-colors cursor-pointer whitespace-nowrap">
                                                                                    Adj. Planos
                                                                                </label>
                                                                            </div>
                                                                        </div>

                                                                        <div className="grid grid-cols-3 gap-2 pt-2 border-t border-slate-800 mb-3">
                                                                            <div>
                                                                                <span className="text-[9px] text-slate-500 uppercase block">Total</span>
                                                                                <span className="text-sm font-mono text-slate-300">${b.total.toLocaleString()}</span>
                                                                            </div>
                                                                            <div>
                                                                                <span className="text-[9px] text-slate-500 uppercase block">Entregado</span>
                                                                                <span className="text-sm font-mono text-emerald-400">${paid.toLocaleString()}</span>
                                                                            </div>
                                                                            <div className="text-right">
                                                                                <span className="text-[9px] text-slate-500 uppercase block">Saldo</span>
                                                                                <span className={`text-sm font-mono font-bold ${isFullyPaid ? 'text-emerald-500' : 'text-orange-400'}`}>
                                                                                    {isFullyPaid ? 'PAGADO' : `$${balance.toLocaleString()}`}
                                                                                </span>
                                                                            </div>
                                                                        </div>

                                                                        {/* Payment History Render */}
                                                                        {(b.payment_history && b.payment_history.length > 0) && (
                                                                            <div className="pt-2 border-t border-slate-800 mb-2">
                                                                                <span className="text-[9px] text-slate-500 uppercase block mb-1">Historial de Pagos</span>
                                                                                <ul className="space-y-1">
                                                                                    {b.payment_history.map((ph, phIdx) => (
                                                                                        <li key={phIdx} className="flex justify-between items-center text-[10px] text-slate-400 bg-slate-800/20 px-2 py-1 rounded">
                                                                                            <span>{new Date(ph.date).toLocaleDateString('es-AR', { timeZone: 'UTC' })} - <span className="text-slate-300">{ph.method}</span></span>
                                                                                            <span className="font-mono text-emerald-400">+${ph.amount.toLocaleString()}</span>
                                                                                        </li>
                                                                                    ))}
                                                                                </ul>
                                                                            </div>
                                                                        )}

                                                                        {/* File Uploads Lists */}
                                                                        {((b.receipts && b.receipts.length > 0) || (b.plans && b.plans.length > 0)) && (
                                                                            <div className="pt-3 border-t border-slate-800 flex flex-col gap-3">

                                                                                {(b.receipts && b.receipts.length > 0) && (
                                                                                    <div className="space-y-1">
                                                                                        <span className="text-[9px] text-slate-500 uppercase font-bold tracking-wider">Comprobantes de Pago</span>
                                                                                        <div className="flex flex-col gap-1.5">
                                                                                            {b.receipts.map((r, i) => (
                                                                                                <a key={i} href={r.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-[10px] text-blue-400 hover:text-blue-300 bg-blue-500/10 hover:bg-blue-500/20 p-2 rounded-lg border border-blue-500/20 transition-colors">
                                                                                                    <Icon name="file-text" size={12} className="shrink-0" />
                                                                                                    <span className="truncate">{r.note ? `${r.note}` : `Comprobante ${i + 1}`}</span>
                                                                                                </a>
                                                                                            ))}
                                                                                        </div>
                                                                                    </div>
                                                                                )}

                                                                                {(b.plans && b.plans.length > 0) && (
                                                                                    <div className="space-y-1 mt-1">
                                                                                        <span className="text-[9px] text-slate-500 uppercase font-bold tracking-wider">Planos y Diseños</span>
                                                                                        <div className="flex flex-col gap-1.5">
                                                                                            {b.plans.map((p, i) => (
                                                                                                <a key={i} href={p.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-[10px] text-purple-400 hover:text-purple-300 bg-purple-500/10 hover:bg-purple-500/20 p-2 rounded-lg border border-purple-500/20 transition-colors">
                                                                                                    <Icon name="image" size={12} className="shrink-0" />
                                                                                                    <span className="truncate">{p.note ? `Medidas: ${p.note}` : `Plano ${i + 1}`}</span>
                                                                                                </a>
                                                                                            ))}
                                                                                        </div>
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })
                            })()}
                        </div>
                    </div >

                    {/* Payment Modal */}
                    {
                        paymentModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
                                <div className="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-2xl shadow-2xl relative overflow-hidden flex flex-col">
                                    <div className="p-4 border-b border-slate-700/50 flex justify-between items-center bg-slate-800/50">
                                        <h3 className="font-bold text-lg text-white">Registrar Cobro</h3>
                                        <button type="button" onClick={() => setPaymentModal(null)} className="text-slate-400 hover:text-white transition-colors">
                                            <Icon name="x" size={20} />
                                        </button>
                                    </div>
                                    <form onSubmit={handleAddPayment} className="p-5 space-y-4">
                                        <p className="text-sm text-slate-300">
                                            Abono para: <strong className="text-white">{paymentModal.budget.summary}</strong>
                                        </p>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Monto a cobrar ($)</label>
                                            <input
                                                required
                                                type="number"
                                                min="0"
                                                step="0.01"
                                                value={paymentModal.amount}
                                                onChange={e => setPaymentModal({ ...paymentModal, amount: e.target.value })}
                                                className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none text-slate-200"
                                                placeholder="0.00"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Método de Pago</label>
                                            <select
                                                required
                                                value={paymentModal.method}
                                                onChange={e => setPaymentModal({ ...paymentModal, method: e.target.value })}
                                                className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none text-slate-200"
                                            >
                                                <option value="Efectivo">Efectivo</option>
                                                <option value="Transferencia">Transferencia</option>
                                                <option value="Cheque">Cheque</option>
                                            </select>
                                        </div>
                                        <div className="pt-2">
                                            <button type="submit" disabled={isLoading} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                                                {isLoading ? <span className="animate-spin border-2 border-white/20 border-t-white rounded-full w-5 h-5"></span> : <><Icon name="check" size={18} /> Confirmar Pago</>}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )
                    }

                    {/* Edit Client Modal */}
                    {
                        editingClient && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
                                <div className="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl relative">
                                    <button onClick={() => setEditingClient(null)} className="absolute top-4 right-4 text-slate-400 hover:text-white">
                                        <Icon name="x" size={20} />
                                    </button>
                                    <h3 className="text-xl font-bold mb-4">Editar Cliente</h3>
                                    <form onSubmit={updateClient} className="space-y-4">
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Nombre y Apellido</label>
                                            <input required value={editingClient.name} onChange={e => setEditingClient({ ...editingClient, name: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Teléfono</label>
                                            <input value={editingClient.phone} onChange={e => setEditingClient({ ...editingClient, phone: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Dirección / Obra</label>
                                            <input value={editingClient.address} onChange={e => setEditingClient({ ...editingClient, address: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Localidad</label>
                                            <input value={editingClient.city} onChange={e => setEditingClient({ ...editingClient, city: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none" />
                                        </div>
                                        <button disabled={isLoading} type="submit" className="w-full flex items-center justify-center py-3 rounded-lg text-sm font-bold uppercase tracking-wider bg-blue-600 hover:bg-blue-500 text-white transition-all disabled:opacity-50">
                                            {isLoading ? 'Guardando...' : 'Guardar Cambios'}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        )
                    }

                    {/* Edit Budget Modal */}
                    {
                        editingBudget && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
                                <div className="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl relative">
                                    <button onClick={() => setEditingBudget(null)} className="absolute top-4 right-4 text-slate-400 hover:text-white">
                                        <Icon name="x" size={20} />
                                    </button>
                                    <h3 className="text-xl font-bold mb-4">Editar Presupuesto</h3>
                                    <form onSubmit={updateBudget} className="space-y-4">
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Fecha (YYYY-MM-DD)</label>
                                            <input type="date" required value={editingBudget.date ? editingBudget.date.split('T')[0] : ''} onChange={e => setEditingBudget({ ...editingBudget, date: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none text-slate-200" />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Resumen del Trabajo</label>
                                            <input required value={editingBudget.summary} onChange={e => setEditingBudget({ ...editingBudget, summary: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none text-slate-200" />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Total ($)</label>
                                            <input type="number" required value={editingBudget.total} onChange={e => setEditingBudget({ ...editingBudget, total: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none text-slate-200" min="0" />
                                        </div>
                                        <button disabled={isLoading} type="submit" className="w-full flex items-center justify-center py-3 rounded-lg text-sm font-bold uppercase tracking-wider bg-orange-600 hover:bg-orange-500 text-white transition-all disabled:opacity-50 mt-6">
                                            {isLoading ? 'Guardando...' : 'Aplicar Cambios'}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        )
                    }
                </div >
            );
        };

        const Quoter = ({ clients, setClients, tenantId }) => {
            const [selectedClient, setSelectedClient] = useState(null);
            const [clientSearch, setClientSearch] = useState('');
            const [items, setItems] = useState([{ id: 1, desc: '', qty: 1, price: 0 }]);
            const [vatRate, setVatRate] = useState(0);

            const addItem = () => setItems([...items, { id: Date.now(), desc: '', qty: 1, price: 0 }]);
            const removeItem = (id) => setItems(items.filter(i => i.id !== id));
            const updateItem = (id, field, val) => {
                setItems(items.map(i => i.id === id ? { ...i, [field]: val } : i));
            };

            const subtotal = useMemo(() => items.reduce((acc, i) => acc + i.price, 0), [items]);
            const total = useMemo(() => subtotal * (1 + vatRate), [subtotal, vatRate]);

            const generatePDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // --- Watermark (Fondo difuminado) ---
                const savedLogo = "data:image/png;base64,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";
                if (savedLogo) {
                    try {
                        const imgProps = doc.getImageProperties(savedLogo);
                        const pdfWidth = doc.internal.pageSize.getWidth();
                        const pdfHeight = doc.internal.pageSize.getHeight();

                        const maxWidth = 140;
                        const maxHeight = 140;
                        const ratio = Math.min(maxWidth / imgProps.width, maxHeight / imgProps.height);
                        const finalWidth = imgProps.width * ratio;
                        const finalHeight = imgProps.height * ratio;

                        const x = (pdfWidth - finalWidth) / 2;
                        const y = (pdfHeight - finalHeight) / 2 + 10;

                        let type = 'PNG';
                        if (savedLogo.includes('image/jpeg') || savedLogo.includes('image/jpg')) type = 'JPEG';

                        // Aplicar opacidad para efecto difuminado
                        doc.setGState(new doc.GState({ opacity: 0.12 }));
                        doc.addImage(savedLogo, type, x, y, finalWidth, finalHeight);
                        // Restaurar opacidad 100% para todo lo que va por encima
                        doc.setGState(new doc.GState({ opacity: 1.0 }));
                    } catch (e) {
                        console.error("Error al aplicar marca de agua", e);
                    }
                }

                // --- PDF Design Config ---
                const primaryColor = [30, 64, 175]; // Blue 700
                const accentColor = [100, 116, 139]; // Slate 500

                // Add a top accent bar
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 210, 15, 'F');

                // Entity Header
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text("ADMINISTRACIÓN INTERNA", 200, 10, { align: "right" });

                // Company Name
                doc.setTextColor(...primaryColor);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(24);
                doc.text("FABRIZIO AMOBLAMIENTOS", 14, 35);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(...accentColor);
                doc.text("Carpintería de diseño & Amoblamientos a medida", 14, 42);

                // Document Info
                doc.setDrawColor(200, 200, 200);
                doc.line(14, 50, 196, 50);

                doc.setFontSize(14);
                doc.setTextColor(40);
                doc.setFont("helvetica", "bold");
                doc.text("PRESUPUESTO", 14, 60);

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`N°: ${Date.now().toString().slice(-6)}`, 196, 60, { align: "right" });
                doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 196, 66, { align: "right" });

                // Client Info Box
                if (selectedClient) {
                    doc.setFillColor(248, 250, 252); // Slate 50
                    doc.rect(14, 75, 182, 25, 'F');

                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(30, 41, 59);
                    doc.text("CLIENTE", 20, 83);

                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(11);
                    doc.text(`${selectedClient.name}`, 20, 90);
                    doc.setFontSize(9);
                    doc.setTextColor(...accentColor);
                    doc.text(`Tel: ${selectedClient.phone}  |  Obra: ${selectedClient.address}`, 20, 96);
                }

                // Table
                doc.autoTable({
                    startY: 110,
                    head: [['DESCRIPCIÓN / DETALLE DE OBRA', 'CANT.', 'SUBTOTAL']],
                    body: items.map(i => [i.desc.toUpperCase(), i.qty, `$ ${i.price.toLocaleString()}`]),
                    theme: 'grid',
                    headStyles: {
                        fillColor: primaryColor,
                        fontSize: 10,
                        halign: 'left',
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: { cellWidth: 'auto' },
                        1: { cellWidth: 20, halign: 'center' },
                        2: { cellWidth: 40, halign: 'right', fontStyle: 'bold' }
                    },
                    styles: {
                        fontSize: 9,
                        cellPadding: 5
                    }
                });

                // Total Section
                let finalY = doc.lastAutoTable.finalY + 10;

                if (vatRate > 0) {
                    doc.setFontSize(10);
                    doc.setTextColor(...accentColor);
                    doc.setFont("helvetica", "normal");
                    doc.text("Subtotal:", 140, finalY + 5);
                    doc.text(`$ ${subtotal.toLocaleString()}`, 196, finalY + 5, { align: "right" });

                    doc.text(`IVA (${(vatRate * 100).toFixed(1)}%):`, 140, finalY + 11);
                    doc.text(`$ ${(subtotal * vatRate).toLocaleString()}`, 196, finalY + 11, { align: "right" });

                    finalY += 16;
                }

                doc.setFillColor(241, 245, 249);
                doc.rect(130, finalY, 70, 15, 'F');

                doc.setFontSize(12);
                doc.setTextColor(...primaryColor);
                doc.setFont("helvetica", "bold");
                doc.text("TOTAL FINAL:", 135, finalY + 10);
                doc.text(`$ ${total.toLocaleString()}`, 196, finalY + 10, { align: "right" });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.setFont("helvetica", "italic");
                const footerY = 280;
                doc.text("Presupuesto válido por 10 días. Sujeto a variaciones de costo de materiales.", 105, footerY, { align: "center" });
                doc.text("Gracias por elegir Fabrizio Amoblamientos", 105, footerY + 5, { align: "center" });

                doc.save(`Presupuesto_${selectedClient?.name || 'obra'}.pdf`);
            };

            const shareWA = () => {
                if (!selectedClient) return window.addToast('Seleccione un cliente primero', 'warning');
                const ivaText = vatRate > 0 ? `Subtotal: $${subtotal.toLocaleString()}\nIVA (${(vatRate * 100).toFixed(1)}%): $${(subtotal * vatRate).toLocaleString()}\n` : '';
                const text = `Hola ${selectedClient.name}, adjunto presupuesto de Fabrizio Amoblamientos.\n\nDetalle:\n${items.map(i => `- ${i.desc} (${i.qty}): $${i.price.toLocaleString()}`).join('\n')}\n\n${ivaText}TOTAL FINAL: $${total.toLocaleString()}\n\nQuedo atento a tus comentarios!`;
                window.open(`https://wa.me/${selectedClient.phone.replace(/\D/g, '')}?text=${encodeURIComponent(text)}`);
            };

            const registerInFile = async () => {
                if (!selectedClient) return window.addToast('Seleccione un cliente primero', 'warning');
                if (items.some(i => !i.desc)) return window.addToast('Complete las descripciones de los items', 'warning');

                const summary = items.map(i => `${i.qty}x ${i.desc}`).join(', ').substring(0, 100) + (items.length > 2 ? '...' : '');

                try {
                    const { data, error } = await window.supabaseClient
                        .from('presupuestos')
                        .insert([
                            {
                                tenant_id: tenantId,
                                client_id: selectedClient.id,
                                date: new Date().toISOString(), // Usar ISO para la DB
                                summary: summary,
                                items: items,
                                total: total,
                                paid: 0
                            }
                        ])
                        .select();

                    if (error) throw error;

                    const newBudget = data[0];
                    // Formatear la fecha para la visualización local temporalmente
                    newBudget.date = new Date(newBudget.date).toLocaleString();

                    const updatedClients = clients.map(c => {
                        if (c.id === selectedClient.id) {
                            return {
                                ...c,
                                budgets: [...(c.budgets || []), newBudget]
                            };
                        }
                        return c;
                    });

                    setClients(updatedClients);
                    window.addToast('¡Presupuesto guardado y registrado!', 'success');
                } catch (error) {
                    console.error('Error al guardar presupuesto:', error);
                    window.addToast("Error al guardar presupuesto: " + error.message, 'error');
                }
            };

            return (
                <div className="p-4 md:p-8 pb-20">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                        <h2 className="text-2xl md:text-3xl font-bold">Generador de Presupuestos</h2>
                        <div className="flex flex-wrap gap-2 w-full md:w-auto">
                            <button onClick={registerInFile} className="flex-1 md:flex-none bg-blue-600/30 border border-blue-500/50 hover:bg-blue-600/50 p-2 md:p-3 rounded-lg font-bold flex items-center justify-center gap-2 text-sm text-blue-400">
                                <Icon name="clipboard-check" size={18} /> Registrar en Ficha
                            </button>
                            <button onClick={shareWA} className="flex-1 md:flex-none bg-green-600 hover:bg-green-700 p-2 md:p-3 rounded-lg font-bold flex items-center justify-center gap-2 text-sm">
                                <Icon name="share-2" size={18} /> WhatsApp
                            </button>
                            <button onClick={generatePDF} className="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 p-2 md:p-3 rounded-lg font-bold flex items-center justify-center gap-2 text-sm">
                                <Icon name="download" size={18} /> PDF
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <div className="lg:col-span-1 space-y-6">
                            <div className="glass p-6 rounded-2xl h-fit relative">
                                <h3 className="font-semibold mb-4 text-slate-200">1. Seleccionar Cliente</h3>
                                <div className="relative">
                                    <Icon name="user" className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                                    <input
                                        type="text"
                                        list="client-datalist"
                                        value={clientSearch}
                                        onChange={e => {
                                            const val = e.target.value;
                                            setClientSearch(val);
                                            const found = clients.find(c => c.name.toLowerCase() === val.toLowerCase());
                                            setSelectedClient(found || null);
                                        }}
                                        placeholder="Escribir nombre del cliente..."
                                        className="w-full bg-slate-800 p-2.5 pl-9 rounded-lg outline-none border border-transparent focus:border-blue-500 text-sm text-slate-200 shadow-inner focus:ring-2 focus:ring-blue-500/20"
                                    />
                                    <datalist id="client-datalist">
                                        {clients.map(c => <option key={c.id} value={c.name} />)}
                                    </datalist>
                                </div>
                                {selectedClient && (
                                    <div className="mt-4 text-sm text-slate-300 bg-slate-800/60 p-3 rounded-xl border border-blue-500/20 shadow-sm relative group">
                                        <button onClick={() => { setSelectedClient(null); setClientSearch(''); }} className="absolute top-2 right-2 text-slate-500 hover:text-red-400 bg-slate-800 p-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity" title="Limpiar">
                                            <Icon name="x" size={14} />
                                        </button>
                                        <p className="flex items-center gap-2 mb-1"><Icon name="phone" size={14} className="text-blue-400" /> {selectedClient.phone || 'Sin teléfono'}</p>
                                        <p className="flex items-center gap-2"><Icon name="map-pin" size={14} className="text-orange-400" /> {selectedClient.address || 'Sin dirección'}</p>
                                    </div>
                                )}
                            </div>

                            <div className="glass p-6 rounded-2xl space-y-4">
                                <h3 className="font-semibold text-slate-200">Resumen y Configuración</h3>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-2 font-bold tracking-wider">Tasa de IVA</label>
                                    <div className="flex gap-2">
                                        <button onClick={() => setVatRate(0)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors ${vatRate === 0 ? 'bg-blue-600/40 text-blue-400 border border-blue-500/50' : 'bg-slate-800/50 text-slate-400 border border-transparent hover:bg-slate-800'}`}>0%</button>
                                        <button onClick={() => setVatRate(0.105)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors ${vatRate === 0.105 ? 'bg-blue-600/40 text-blue-400 border border-blue-500/50' : 'bg-slate-800/50 text-slate-400 border border-transparent hover:bg-slate-800'}`}>10.5%</button>
                                        <button onClick={() => setVatRate(0.21)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors ${vatRate === 0.21 ? 'bg-blue-600/40 text-blue-400 border border-blue-500/50' : 'bg-slate-800/50 text-slate-400 border border-transparent hover:bg-slate-800'}`}>21%</button>
                                    </div>
                                </div>
                                <div className="pt-4 border-t border-slate-700/50">
                                    <div className="flex justify-between text-sm text-slate-400 mb-2">
                                        <span>Subtotal:</span>
                                        <span>${subtotal.toLocaleString()}</span>
                                    </div>
                                    {vatRate > 0 && (
                                        <div className="flex justify-between text-sm text-slate-400 mb-2">
                                            <span>IVA ({(vatRate * 100).toFixed(1)}%):</span>
                                            <span>${(subtotal * vatRate).toLocaleString()}</span>
                                        </div>
                                    )}
                                    <div className="flex justify-between text-2xl font-bold text-blue-400 mt-2">
                                        <span className="text-xl">Total:</span>
                                        <span>${total.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-3 glass p-6 rounded-2xl">
                            <h3 className="font-semibold mb-6 flex justify-between items-center">
                                2. Detalle del Presupuesto
                                <button onClick={addItem} className="text-blue-400 hover:text-blue-300 text-sm flex items-center gap-1">
                                    <Icon name="plus-circle" size={16} /> Agregar Fila
                                </button>
                            </h3>

                            <div className="space-y-4">
                                <div className="hidden md:grid grid-cols-12 gap-4 px-2 text-xs uppercase text-slate-500 font-bold">
                                    <div className="col-span-7">Descripción / Material</div>
                                    <div className="col-span-2 text-center">Cant.</div>
                                    <div className="col-span-3 text-right">Precio</div>
                                </div>
                                {items.map(i => (
                                    <div key={i.id} className="grid grid-cols-12 gap-2 md:gap-4 items-center group glass p-3 md:p-0 md:bg-transparent rounded-xl">
                                        <div className="col-span-12 md:col-span-7 flex gap-2 items-center">
                                            <button onClick={() => removeItem(i.id)} className="md:opacity-0 group-hover:opacity-100 text-red-500 transition-all"><Icon name="trash-2" size={16} /></button>
                                            <input value={i.desc} onChange={e => updateItem(i.id, 'desc', e.target.value)} className="w-full bg-slate-800/50 p-2 rounded-lg outline-none border border-transparent focus:border-blue-500 text-sm" placeholder="Ej: Bajo mesada 1.20m melanina" />
                                        </div>
                                        <div className="col-span-4 md:col-span-2 flex flex-col md:block">
                                            <label className="md:hidden text-[10px] text-slate-500 uppercase font-bold mb-1">Cant.</label>
                                            <input type="number" value={i.qty} onChange={e => updateItem(i.id, 'qty', parseFloat(e.target.value))} className="w-full bg-slate-800/50 p-2 rounded-lg text-center outline-none text-sm" />
                                        </div>
                                        <div className="col-span-8 md:col-span-3 flex flex-col md:block">
                                            <label className="md:hidden text-[10px] text-slate-500 uppercase font-bold mb-1 text-right">Precio Total</label>
                                            <input type="number" value={i.price} onChange={e => updateItem(i.id, 'price', parseFloat(e.target.value))} className="w-full bg-slate-800/50 p-2 rounded-lg text-right outline-none font-mono text-blue-400 text-sm" />
                                        </div>
                                    </div>
                                ))}
                                {items.length === 0 && <div className="text-center py-10 text-slate-500">No hay items en el presupuesto</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const SupplierManager = ({ suppliers, setSuppliers, tenantId }) => {
            const [newSupplier, setNewSupplier] = useState({ name: '', phone: '', supplies: '' });
            const [editSupplierModal, setEditSupplierModal] = useState({ isOpen: false, data: { id: null, name: '', phone: '', supplies: '' } });
            const [isLoading, setIsLoading] = useState(false);
            const [transactionModal, setTransactionModal] = useState({ isOpen: false, supplierId: null, type: 'DEUDA' });
            const [transactionData, setTransactionData] = useState({ amount: '', desc: '', date: new Date().toISOString().split('T')[0], dueDate: '', receiptFile: null });
            const [isSubmittingTx, setIsSubmittingTx] = useState(false);
            const [supplierProducts, setSupplierProducts] = useState([]);
            const [selectedProduct, setSelectedProduct] = useState('');
            const [productQuantity, setProductQuantity] = useState(1);
            const [productUnitPrice, setProductUnitPrice] = useState(0);

            // Carga Masiva (Bulk Purchase) States
            const [bulkModal, setBulkModal] = useState({ isOpen: false, supplierId: null });
            const [bulkItems, setBulkItems] = useState([{ id: Date.now(), producto: '', cantidad: 1, precio_unidad: 0, precio_total: 0 }]);
            const [bulkDate, setBulkDate] = useState(new Date().toISOString().split('T')[0]);
            const [bulkDesc, setBulkDesc] = useState('');
            const [bulkReceiptFile, setBulkReceiptFile] = useState(null);

            const [searchTerm, setSearchTerm] = useState('');
            const [sortOption, setSortOption] = useState('recent');

            const getSupplierTotalDebt = (s) => (s.debts || []).reduce((acc, d) => acc + d.amount, 0);

            const getSupplierUrgency = (s) => {
                if (!s.debts) return 0;
                let isUrgent = 0;
                s.debts.forEach(d => {
                    if (d.dueDate && d.amount > 0) {
                        const vto = new Date(d.dueDate);
                        const today = new Date();
                        const diffTime = vto - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays < 0) isUrgent = 2;
                        else if (diffDays <= 7 && isUrgent < 2) isUrgent = 1;
                    }
                });
                return isUrgent;
            };

            const filteredSuppliers = suppliers
                .filter(s => {
                    const matchesSearch = s.name.toLowerCase().includes(searchTerm.toLowerCase()) || (s.supplies || '').toLowerCase().includes(searchTerm.toLowerCase());
                    if (!matchesSearch) return false;

                    if (sortOption === 'debt_desc') {
                        return getSupplierTotalDebt(s) > 0;
                    } else if (sortOption === 'vencid') {
                        return getSupplierUrgency(s) > 0;
                    }
                    return true;
                })
                .sort((a, b) => {
                    if (sortOption === 'debt_desc') {
                        const diff = getSupplierTotalDebt(b) - getSupplierTotalDebt(a);
                        if (diff !== 0) return diff;
                    } else if (sortOption === 'vencid') {
                        const urgDiff = getSupplierUrgency(b) - getSupplierUrgency(a);
                        if (urgDiff !== 0) return urgDiff;
                        const debtDiff = getSupplierTotalDebt(b) - getSupplierTotalDebt(a);
                        if (debtDiff !== 0) return debtDiff;
                    }
                    return b.id - a.id;
                });

            const fetchSupplierProducts = async (supplierId) => {
                try {
                    const { data, error } = await window.supabaseClient
                        .from('insumos_precios')
                        .select('*')
                        .eq('proveedor_id', supplierId)
                        .eq('tenant_id', tenantId);
                    if (error) throw error;
                    setSupplierProducts(data || []);
                } catch (err) {
                    console.error("Error fetching supplier products:", err);
                }
            };

            useEffect(() => {
                if (transactionModal.isOpen && transactionModal.type === 'DEUDA' && transactionModal.supplierId) {
                    fetchSupplierProducts(transactionModal.supplierId);
                } else {
                    setSupplierProducts([]);
                    setSelectedProduct('');
                    setProductQuantity(1);
                    setProductUnitPrice(0);
                }
            }, [transactionModal.isOpen, transactionModal.supplierId, transactionModal.type, tenantId]);

            const handleProductChange = (e) => {
                const prodId = e.target.value;
                setSelectedProduct(prodId);
                if (prodId) {
                    const prod = supplierProducts.find(p => p.id === parseInt(prodId));
                    if (prod) {
                        const price = Number(prod.precio_unidad) || 0;
                        setProductUnitPrice(price);
                        const amount = price * productQuantity;
                        const desc = `Compra: ${prod.producto} x${productQuantity}`;
                        setTransactionData(prev => ({ ...prev, amount: amount.toString(), desc }));
                    }
                } else {
                    setProductUnitPrice(0);
                    setTransactionData(prev => ({ ...prev, amount: '0' }));
                }
            };

            const handleQuantityChange = (e) => {
                const qty = parseInt(e.target.value) || 1;
                setProductQuantity(qty);
                if (selectedProduct) {
                    const prod = supplierProducts.find(p => p.id === parseInt(selectedProduct));
                    if (prod) {
                        const amount = productUnitPrice * qty;
                        const desc = `Compra: ${prod.producto} x${qty}`;
                        setTransactionData(prev => ({ ...prev, amount: amount.toString(), desc }));
                    }
                }
            };

            const handleUnitPriceChange = (e) => {
                const price = parseFloat(e.target.value) || 0;
                setProductUnitPrice(price);
                if (selectedProduct) {
                    const prod = supplierProducts.find(p => p.id === parseInt(selectedProduct));
                    if (prod) {
                        const amount = price * productQuantity;
                        const desc = `Compra: ${prod.producto} x${productQuantity}`;
                        setTransactionData(prev => ({ ...prev, amount: amount.toString(), desc }));
                    }
                }
            };

            const uploadSupplierReceipt = async (file, supplierId) => {
                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${supplierId}-${Date.now()}.${fileExt}`;
                    const filePath = `proveedores/${fileName}`;
                    const { error: uploadError } = await window.supabaseClient.storage.from('archivos_crm').upload(filePath, file);
                    if (uploadError) throw uploadError;
                    const { data: { publicUrl } } = window.supabaseClient.storage.from('archivos_crm').getPublicUrl(filePath);
                    return publicUrl;
                } catch (error) {
                    console.error("Error subiendo comprobante:", error);
                    return null;
                }
            };

            const handleTransactionSubmit = async (e) => {
                e.preventDefault();
                if (!transactionData.amount || isNaN(transactionData.amount)) return;
                setIsSubmittingTx(true);
                try {
                    const s = suppliers.find(sup => sup.id === transactionModal.supplierId);
                    if (!s) throw new Error("Proveedor no encontrado");

                    let receiptUrl = null;
                    if (transactionData.receiptFile) {
                        receiptUrl = await uploadSupplierReceipt(transactionData.receiptFile, s.id);
                    }

                    const numAmount = transactionModal.type === 'PAGO' ? -Math.abs(parseFloat(transactionData.amount)) : Math.abs(parseFloat(transactionData.amount));
                    const d_operacion = transactionData.date;
                    const d_vencimiento = transactionData.dueDate || null;

                    const { data: insertedTx, error: txError } = await window.supabaseClient.from('transacciones_proveedores').insert([{
                        tenant_id: tenantId,
                        supplier_id: s.id,
                        tipo: transactionModal.type,
                        monto: Math.abs(numAmount),
                        descripcion: transactionData.desc || (transactionModal.type === 'DEUDA' ? "Nueva Deuda" : "Pago a Proveedor"),
                        fecha_operacion: d_operacion,
                        fecha_vencimiento: d_vencimiento,
                        comprobante_url: receiptUrl
                    }]).select();

                    if (txError) throw txError;

                    const newDebt = {
                        id: insertedTx[0].id || Date.now(),
                        amount: numAmount,
                        desc: transactionData.desc || transactionModal.type,
                        date: d_operacion,
                        dueDate: d_vencimiento,
                        receiptUrl: receiptUrl
                    };
                    const updatedArray = [...(s.debts || []), newDebt];

                    const { error: updateError } = await window.supabaseClient.from('proveedores').update({ debts: updatedArray }).eq('id', s.id);
                    if (updateError && !updateError.message.includes('column "debts" of relation "proveedores" does not exist')) throw updateError;

                    const updated = suppliers.map(prov => prov.id === s.id ? { ...prov, debts: updatedArray } : prov);
                    setSuppliers(updated);
                    setTransactionModal({ isOpen: false, supplierId: null, type: 'DEUDA' });
                    setTransactionData({ amount: '', desc: '', date: new Date().toISOString().split('T')[0], dueDate: '', receiptFile: null });
                    setSelectedProduct('');
                    setProductQuantity(1);
                    setProductUnitPrice(0);
                } catch (err) {
                    window.addToast("Error al guardar transacción: " + err.message, 'error');
                } finally {
                    setIsSubmittingTx(false);
                }
            };

            const openBulkModal = (supplierId) => {
                setBulkModal({ isOpen: true, supplierId });
                fetchSupplierProducts(supplierId);
                setBulkItems([{ id: Date.now(), producto: '', cantidad: 1, precio_unidad: 0, precio_total: 0 }]);
                setBulkDate(new Date().toISOString().split('T')[0]);
                setBulkDesc('Carga de Factura / Remito');
                setBulkReceiptFile(null);
            };

            const handleCloseBulkModal = () => {
                setBulkModal({ isOpen: false, supplierId: null });
                setSupplierProducts([]);
            };

            const handleBulkItemChange = (id, field, value) => {
                setBulkItems(bulkItems.map(item => {
                    if (item.id === id) {
                        const updated = { ...item, [field]: value };
                        if (field === 'producto') {
                            const prod = supplierProducts.find(p => p.producto === value);
                            if (prod) {
                                updated.precio_unidad = Number(prod.precio_unidad) || 0;
                                updated.precio_total = updated.cantidad * updated.precio_unidad;
                            }
                        }
                        if (field === 'cantidad') {
                            updated.cantidad = Number(value) || 0;
                            updated.precio_total = updated.cantidad * updated.precio_unidad;
                        }
                        if (field === 'precio_unidad') {
                            updated.precio_unidad = Number(value) || 0;
                            updated.precio_total = updated.cantidad * updated.precio_unidad;
                        }
                        return updated;
                    }
                    return item;
                }));
            };

            const handleAddBulkItem = () => setBulkItems([...bulkItems, { id: Date.now(), producto: '', cantidad: 1, precio_unidad: 0, precio_total: 0 }]);
            const handleRemoveBulkItem = (id) => setBulkItems(bulkItems.filter(i => i.id !== id));
            const totalBulkAmount = bulkItems.reduce((acc, item) => acc + item.precio_total, 0);

            const handleBulkSubmit = async (e) => {
                e.preventDefault();
                if (totalBulkAmount <= 0) return;
                setIsSubmittingTx(true);
                try {
                    const s = suppliers.find(sup => sup.id === bulkModal.supplierId);
                    if (!s) throw new Error("Proveedor no encontrado");

                    let receiptUrl = null;
                    if (bulkReceiptFile) {
                        receiptUrl = await uploadSupplierReceipt(bulkReceiptFile, s.id);
                    }

                    const numAmount = Math.abs(parseFloat(totalBulkAmount));
                    const { data: insertedTx, error: txError } = await window.supabaseClient.from('transacciones_proveedores').insert([{
                        tenant_id: tenantId,
                        supplier_id: s.id,
                        tipo: 'DEUDA',
                        monto: numAmount,
                        descripcion: bulkDesc || "Compra Masiva",
                        fecha_operacion: bulkDate,
                        fecha_vencimiento: null,
                        comprobante_url: receiptUrl
                    }]).select();

                    if (txError) throw txError;

                    const newDebt = {
                        id: insertedTx[0].id || Date.now(),
                        amount: numAmount,
                        desc: bulkDesc || "Compra Masiva",
                        date: bulkDate,
                        dueDate: null,
                        receiptUrl: receiptUrl
                    };
                    const updatedArray = [...(s.debts || []), newDebt];

                    const { error: updateError } = await window.supabaseClient.from('proveedores').update({ debts: updatedArray }).eq('id', s.id);
                    if (updateError && !updateError.message.includes('column "debts" of relation')) throw updateError;

                    setSuppliers(suppliers.map(prov => prov.id === s.id ? { ...prov, debts: updatedArray } : prov));
                    handleCloseBulkModal();
                    window.addToast("Compra masiva registrada con éxito", 'success');
                } catch (err) {
                    window.addToast("Error: " + err.message, 'error');
                } finally {
                    setIsSubmittingTx(false);
                }
            };

            useEffect(() => {
                fetchSuppliers();
            }, []);

            const fetchSuppliers = async () => {
                setIsLoading(true);
                try {
                    const { data, error } = await window.supabaseClient
                        .from('proveedores')
                        .select('*')
                        .order('id', { ascending: false });

                    if (error) throw error;
                    setSuppliers(data || []);
                } catch (error) {
                    console.error('Error al cargar proveedores:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            const updateSupplierModal = async () => {
                const { id, name, phone, supplies } = editSupplierModal.data;
                if (!name) return;
                setIsLoading(true);

                try {
                    const { error } = await window.supabaseClient
                        .from('proveedores')
                        .update({ name, phone, supplies })
                        .eq('id', id);

                    if (error) throw error;

                    setSuppliers(suppliers.map(s => s.id === id ? { ...s, name, phone, supplies } : s));
                    setEditSupplierModal({ isOpen: false, data: { id: null, name: '', phone: '', supplies: '' } });
                    window.addToast("Proveedor actualizado con éxito", 'success');
                } catch (error) {
                    console.error('Error al actualizar proveedor:', error);
                    window.addToast("Error al guardar en Supabase: " + error.message, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const addSupplier = async () => {
                if (!newSupplier.name) return;
                setIsLoading(true);

                try {
                    const { data, error } = await window.supabaseClient
                        .from('proveedores')
                        .insert([
                            {
                                tenant_id: tenantId,
                                name: newSupplier.name,
                                phone: newSupplier.phone,
                                supplies: newSupplier.supplies
                            }
                        ])
                        .select();

                    if (error) throw error;

                    if (data && data.length > 0) {
                        setSuppliers([...suppliers, data[0]]);
                        setNewSupplier({ name: '', phone: '', supplies: '' });
                        window.addToast("Proveedor agregado con éxito", 'success');
                    }
                } catch (error) {
                    console.error('Error al guardar proveedor:', error);
                    window.addToast("Error al guardar en Supabase: " + error.message, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="p-4 md:p-8 pb-20">
                    <h2 className="text-2xl md:text-3xl font-bold mb-6 md:mb-8">Agenda de Proveedores</h2>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-1 glass p-6 rounded-2xl h-fit">
                            <h3 className="text-xl font-semibold mb-6 flex items-center gap-2">
                                <Icon name="user-plus" />
                                Nuevo Proveedor
                            </h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Nombre / Empresa</label>
                                    <input value={newSupplier.name} onChange={e => setNewSupplier({ ...newSupplier, name: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="Maderera San José" />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">WhatsApp / Teléfono</label>
                                    <input value={newSupplier.phone} onChange={e => setNewSupplier({ ...newSupplier, phone: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="+54 9..." />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Insumos (Qué trae)</label>
                                    <input value={newSupplier.supplies} onChange={e => setNewSupplier({ ...newSupplier, supplies: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="Placas, Herrajes..." />
                                </div>
                                <button onClick={addSupplier} disabled={isLoading || !newSupplier.name} className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 p-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2">
                                    <Icon name="plus" /> {isLoading ? 'Guardando...' : 'Guardar Proveedor'}
                                </button>
                            </div>
                        </div>

                        <div className="lg:col-span-2 space-y-4">
                            {/* Filtros */}
                            {(suppliers.length > 0 || searchTerm) && (
                                <div className="glass p-4 rounded-2xl flex flex-col xl:flex-row gap-4 justify-between items-center z-10 relative">
                                    <div className="relative w-full xl:w-2/5">
                                        <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                        <input
                                            type="text"
                                            placeholder="Buscar proveedor o insumo..."
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className="w-full bg-slate-800/50 border border-slate-700/50 rounded-xl pl-10 pr-4 py-2 outline-none focus:border-blue-500 text-sm transition-colors text-white"
                                        />
                                    </div>
                                    <div className="flex bg-slate-800/50 p-1.5 rounded-xl w-full xl:w-auto overflow-x-auto scroolbar-hide">
                                        <button onClick={() => setSortOption('recent')} className={`whitespace-nowrap flex-1 px-4 py-2 rounded-lg text-xs font-bold transition-all ${sortOption === 'recent' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                            Recientes
                                        </button>
                                        <button onClick={() => setSortOption('debt_desc')} className={`whitespace-nowrap flex-1 px-4 py-2 rounded-lg text-xs font-bold transition-all ${sortOption === 'debt_desc' ? 'bg-orange-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                            Mayor Deuda
                                        </button>
                                        <button onClick={() => setSortOption('vencid')} className={`whitespace-nowrap flex-1 px-4 py-2 rounded-lg text-xs font-bold transition-all ${sortOption === 'vencid' ? 'bg-red-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                            Vencimientos
                                        </button>
                                    </div>
                                </div>
                            )}

                            {filteredSuppliers.length === 0 ? (
                                <div className="glass p-10 rounded-2xl text-center text-slate-500">No hay proveedores registrados o coincidencias de búsqueda</div>
                            ) : (
                                filteredSuppliers.map(s => {
                                    const totalDebt = (s.debts || []).reduce((acc, d) => acc + d.amount, 0);

                                    const openTransactionModal = (supplierId, type) => {
                                        setTransactionModal({ isOpen: true, supplierId, type });
                                    };

                                    return (
                                        <div key={s.id} className="glass p-6 rounded-2xl group hover:border-blue-500/50 transition-all space-y-4">
                                            <div className="flex items-center justify-between">
                                                <div className="flex gap-4 items-center">
                                                    <div className="w-12 h-12 rounded-full bg-indigo-500/10 flex items-center justify-center text-indigo-400 font-bold text-xl uppercase">
                                                        {s.name[0]}
                                                    </div>
                                                    <div>
                                                        <h4 className="font-semibold text-lg">{s.name}</h4>
                                                        <div className="flex flex-col sm:flex-row sm:gap-4 text-xs sm:text-sm text-slate-400">
                                                            <span className="flex items-center gap-1 text-slate-300 font-medium"><Icon name="package" size={14} /> {s.supplies}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <a href={`tel:${s.phone.replace(/\D/g, '')}`} className="p-2 glass rounded-lg hover:bg-slate-500/20 text-slate-300" title="Llamar"><Icon name="phone" /></a>
                                                    <a href={`https://wa.me/${s.phone.replace(/\D/g, '')}`} target="_blank" className="p-2 glass rounded-lg hover:bg-green-500/20 text-green-400" title="WhatsApp"><Icon name="message-circle" /></a>
                                                    <button onClick={() => {
                                                        setEditSupplierModal({
                                                            isOpen: true,
                                                            data: { id: s.id, name: s.name || '', phone: s.phone || '', supplies: s.supplies || '' }
                                                        });
                                                    }} className="p-2 glass rounded-lg hover:bg-blue-500/20 text-blue-400" title="Editar"><Icon name="edit" /></button>
                                                    <button onClick={async () => {
                                                        if (await window.confirmAsync('¿Eliminar proveedor?')) {
                                                            try {
                                                                await window.supabaseClient.from('proveedores').delete().eq('id', s.id);
                                                                setSuppliers(suppliers.filter(prev => prev.id !== s.id));
                                                            } catch (e) { window.addToast("Error eliminando: " + e.message, 'error'); }
                                                        }
                                                    }} className="p-2 glass rounded-lg hover:bg-red-500/20 text-red-400" title="Eliminar"><Icon name="trash-2" /></button>
                                                </div>
                                            </div>

                                            {/* Financial / Debt Section */}
                                            <div className="border-t border-slate-700/50 pt-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                                <div>
                                                    <span className="text-[10px] uppercase text-slate-500 font-bold block mb-1">Saldo Adeudado</span>
                                                    <span className={`text-2xl font-mono font-bold ${totalDebt > 0 ? 'text-orange-400' : 'text-emerald-500'}`}>
                                                        ${totalDebt.toLocaleString()}
                                                    </span>
                                                </div>
                                                <div className="flex flex-wrap gap-2 w-full md:w-auto">
                                                    <button onClick={() => openBulkModal(s.id)} className="flex-1 md:flex-none bg-blue-600/20 text-blue-400 hover:bg-blue-600/40 px-4 py-2 rounded-lg text-xs font-bold uppercase transition-colors flex items-center justify-center gap-2">
                                                        <Icon name="file-plus" size={14} /> Cargar Compra
                                                    </button>
                                                    <button onClick={() => openTransactionModal(s.id, 'DEUDA')} className="flex-1 md:flex-none bg-orange-500/20 text-orange-400 hover:bg-orange-500/40 px-4 py-2 rounded-lg text-xs font-bold uppercase transition-colors flex items-center justify-center gap-2">
                                                        <Icon name="plus" size={14} /> Deuda Libre
                                                    </button>
                                                    <button onClick={() => openTransactionModal(s.id, 'PAGO')} className="flex-1 md:flex-none bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/40 px-4 py-2 rounded-lg text-xs font-bold uppercase transition-colors flex items-center justify-center gap-2">
                                                        <Icon name="minus" size={14} /> Registrar Pago
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Optional Debt history list if any */}
                                            {(s.debts && s.debts.length > 0) && (
                                                <div className="mt-4 pt-3 border-t border-slate-800">
                                                    <div className="max-h-32 overflow-y-auto space-y-1 pr-2 mt-2">
                                                        {s.debts.slice().reverse().map((d, index) => {
                                                            const isOverdue = d.dueDate && new Date(d.dueDate) < new Date() && d.amount > 0;
                                                            // Split date object safely
                                                            const displayDate = d.date.includes('-') ? d.date.split('-').reverse().join('/') : d.date;
                                                            return (
                                                                <div key={d.id || index} className="flex justify-between items-center text-xs p-2 hover:bg-slate-800/50 rounded-lg group transition-colors">
                                                                    <div className="flex flex-col gap-0.5">
                                                                        <div className="flex items-center gap-2">
                                                                            <span className="text-slate-500 font-mono text-[10px]">{displayDate}</span>
                                                                            <span className="text-slate-300 font-medium">{d.desc}</span>
                                                                            {d.receiptUrl && <a href={d.receiptUrl} target="_blank" rel="noreferrer" className="text-blue-400 hover:text-blue-300 ml-1 bg-blue-500/10 p-1 rounded transition-colors" title="Ver comprobante"><Icon name="paperclip" size={12} /></a>}
                                                                        </div>
                                                                        {d.dueDate && d.amount > 0 && <span className={`text-[9px] font-bold uppercase ${isOverdue ? 'text-red-400 bg-red-400/10' : 'text-orange-400/80 bg-orange-400/10'} px-1.5 py-0.5 rounded w-fit`}>Vto: {d.dueDate.split('-').reverse().join('/')}</span>}
                                                                    </div>
                                                                    <span className={`font-mono font-bold text-sm ${d.amount > 0 ? 'text-orange-400' : 'text-emerald-400'}`}>
                                                                        {d.amount > 0 ? '+' : ''}{d.amount.toLocaleString()}
                                                                    </span>
                                                                </div>
                                                            )
                                                        })}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>

                    {/* Modal Editar Proveedor */}
                    {editSupplierModal.isOpen && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
                            <div className="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-md shadow-2xl space-y-4">
                                <h3 className="text-xl font-bold flex items-center gap-2 text-blue-400 mb-2">
                                    <Icon name="edit" /> Editar Proveedor
                                </h3>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Nombre / Empresa</label>
                                    <input
                                        value={editSupplierModal.data.name}
                                        onChange={e => setEditSupplierModal({ ...editSupplierModal, data: { ...editSupplierModal.data, name: e.target.value } })}
                                        className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">WhatsApp / Teléfono</label>
                                    <input
                                        value={editSupplierModal.data.phone}
                                        onChange={e => setEditSupplierModal({ ...editSupplierModal, data: { ...editSupplierModal.data, phone: e.target.value } })}
                                        className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Insumos (Qué trae)</label>
                                    <input
                                        value={editSupplierModal.data.supplies}
                                        onChange={e => setEditSupplierModal({ ...editSupplierModal, data: { ...editSupplierModal.data, supplies: e.target.value } })}
                                        className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none"
                                    />
                                </div>
                                <div className="flex gap-4 pt-4 border-t border-slate-700/50">
                                    <button onClick={() => setEditSupplierModal({ isOpen: false, data: { id: null, name: '', phone: '', supplies: '' } })} className="flex-1 bg-slate-800 hover:bg-slate-700 p-3 rounded-lg font-bold transition-all text-white">Cancelar</button>
                                    <button onClick={updateSupplierModal} disabled={isLoading || !editSupplierModal.data.name} className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 p-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2 text-white">
                                        <Icon name="save" /> {isLoading ? '...' : 'Guardar Cambios'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Transacción Proveedor */}
                    {transactionModal.isOpen && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
                            <div className="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-md shadow-2xl">
                                <h3 className={`text-xl font-bold mb-4 flex items-center gap-2 ${transactionModal.type === 'DEUDA' ? 'text-orange-400' : 'text-emerald-400'}`}>
                                    <Icon name={transactionModal.type === 'DEUDA' ? 'trending-up' : 'trending-down'} />
                                    {transactionModal.type === 'DEUDA' ? 'Facturación / Nueva Deuda' : 'Pago Emitido'}
                                </h3>
                                <form onSubmit={handleTransactionSubmit} className="space-y-4">
                                    {transactionModal.type === 'DEUDA' && supplierProducts.length > 0 && (
                                        <div className="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 space-y-3 mb-4">
                                            <div>
                                                <label className="text-xs uppercase text-slate-400 block mb-1">Carga Rápida de Insumo</label>
                                                <select
                                                    value={selectedProduct}
                                                    onChange={handleProductChange}
                                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm text-white focus:border-blue-500 outline-none"
                                                >
                                                    <option value="">Seleccionar insumo...</option>
                                                    {supplierProducts.map(p => (
                                                        <option key={p.id} value={p.id}>
                                                            {p.producto} (${(p.precio_unidad || 0).toLocaleString()})
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>
                                            {selectedProduct && (
                                                <div className="flex items-center gap-4 mt-3 bg-slate-800 p-3 rounded-lg border border-slate-700/50">
                                                    <div className="flex-1">
                                                        <label className="text-[10px] uppercase text-slate-400 block mb-1">Precio x U. ($)</label>
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            step="0.01"
                                                            value={productUnitPrice}
                                                            onChange={handleUnitPriceChange}
                                                            className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm text-center font-mono text-blue-400 focus:border-blue-500 outline-none"
                                                        />
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="text-[10px] uppercase text-slate-400 block mb-1">Cantidad</label>
                                                        <input
                                                            type="number"
                                                            min="1"
                                                            value={productQuantity}
                                                            onChange={handleQuantityChange}
                                                            className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm text-center font-mono text-white focus:border-blue-500 outline-none"
                                                        />
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Concepto</label>
                                            <input type="text" value={transactionData.desc} onChange={e => setTransactionData({ ...transactionData, desc: e.target.value })} className="w-full bg-slate-800 border border-transparent rounded-lg p-3 outline-none focus:border-blue-500 text-white text-sm" placeholder={transactionModal.type === 'DEUDA' ? 'Ej: Fact. A-001' : 'Ej: Transf. BBVA'} />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Monto ($)</label>
                                            <div className="relative">
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 font-bold">$</span>
                                                <input type="number" step="0.01" value={transactionData.amount} onChange={e => setTransactionData({ ...transactionData, amount: e.target.value })} className="w-full bg-slate-800 border border-transparent rounded-lg p-3 pl-7 outline-none focus:border-blue-500 font-mono font-bold text-white text-right text-sm" required placeholder="0.00" disabled={transactionModal.type === 'DEUDA' && selectedProduct !== ''} />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Fecha Op.</label>
                                            <input type="date" value={transactionData.date} onChange={e => setTransactionData({ ...transactionData, date: e.target.value })} className="w-full bg-slate-800 border border-transparent rounded-lg p-2.5 outline-none focus:border-blue-500 text-slate-300 text-sm" required />
                                        </div>
                                        {transactionModal.type === 'DEUDA' ? (
                                            <div>
                                                <label className="text-xs uppercase text-slate-400 block mb-1">Vencimiento <span className="text-[9px] opacity-70">(Opcional)</span></label>
                                                <input type="date" value={transactionData.dueDate} onChange={e => setTransactionData({ ...transactionData, dueDate: e.target.value })} className="w-full bg-slate-800 border border-transparent rounded-lg p-2.5 outline-none focus:border-orange-500/50 text-orange-200/80 text-sm" />
                                            </div>
                                        ) : <div></div>}
                                    </div>
                                    <div>
                                        <label className="text-xs uppercase text-slate-400 block mb-1">Comprobante / Archivo <span className="text-[9px] opacity-70">(Opcional)</span></label>
                                        <input type="file" onChange={e => setTransactionData({ ...transactionData, receiptFile: e.target.files[0] })} className="w-full text-sm text-slate-400 file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-bold file:bg-blue-600/20 file:text-blue-400 hover:file:bg-blue-600/30 file:transition-colors bg-slate-800 rounded-lg pr-3" />
                                    </div>
                                    <div className="flex gap-3 pt-4 border-t border-slate-800 mt-6">
                                        <button type="button" onClick={() => setTransactionModal({ isOpen: false, supplierId: null, type: 'DEUDA' })} className="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 p-3 rounded-xl font-bold transition-colors" disabled={isSubmittingTx}>Cancelar</button>
                                        <button type="submit" disabled={isSubmittingTx} className={`flex-1 p-3 rounded-xl font-bold text-white flex justify-center items-center gap-2 transition-colors ${transactionModal.type === 'DEUDA' ? 'bg-orange-600 hover:bg-orange-500' : 'bg-emerald-600 hover:bg-emerald-500'} disabled:opacity-50`}>
                                            {isSubmittingTx ? <><Icon name="loader" size={18} className="animate-spin" /> Guardando...</> : <><Icon name="save" size={18} /> Guardar Movimiento</>}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Modal Carga Masiva (Bulk Purchase) */}
                    {bulkModal.isOpen && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100] overflow-y-auto">
                            <div className="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-2xl shadow-2xl my-auto relative">
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-blue-400">
                                    <Icon name="file-text" />
                                    Carga Masiva de Compra / Remito
                                </h3>
                                <div className="text-sm text-slate-400 mb-6">Agrega múltiples productos a la misma factura para sumarlos al saldo del proveedor.</div>
                                <form onSubmit={handleBulkSubmit} className="space-y-4">
                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700 space-y-3">
                                        {bulkItems.map((item, index) => (
                                            <div key={item.id} className="flex flex-wrap md:flex-nowrap items-end gap-3 pb-3 border-b border-slate-700/50 last:border-0 last:pb-0">
                                                <div className="w-full md:w-auto flex-1">
                                                    <label className="text-[10px] uppercase text-slate-500 block mb-1">Producto</label>
                                                    <select
                                                        value={item.producto}
                                                        onChange={(e) => handleBulkItemChange(item.id, 'producto', e.target.value)}
                                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm text-white focus:border-blue-500 outline-none"
                                                    >
                                                        <option value="">Seleccionar del catálogo...</option>
                                                        {supplierProducts.map(p => (
                                                            <option key={p.id} value={p.producto}>
                                                                {p.producto}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div className="w-20">
                                                    <label className="text-[10px] uppercase text-slate-500 block mb-1">Cant.</label>
                                                    <input
                                                        type="number" min="1"
                                                        value={item.cantidad}
                                                        onChange={(e) => handleBulkItemChange(item.id, 'cantidad', e.target.value)}
                                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm text-center text-white focus:border-blue-500 outline-none"
                                                    />
                                                </div>
                                                <div className="w-24">
                                                    <label className="text-[10px] uppercase text-slate-500 block mb-1">P. Unit ($)</label>
                                                    <input
                                                        type="number" min="0" step="0.01"
                                                        value={item.precio_unidad}
                                                        onChange={(e) => handleBulkItemChange(item.id, 'precio_unidad', e.target.value)}
                                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm text-center font-mono text-blue-400 focus:border-blue-500 outline-none"
                                                    />
                                                </div>
                                                <div className="w-24">
                                                    <label className="text-[10px] uppercase text-slate-500 block mb-1">Subt. ($)</label>
                                                    <input
                                                        type="number" readOnly
                                                        value={item.precio_total}
                                                        className="w-full bg-transparent border border-transparent rounded-lg p-2 text-sm text-center font-bold font-mono text-orange-400 outline-none cursor-not-allowed"
                                                    />
                                                </div>
                                                {bulkItems.length > 1 && (
                                                    <button type="button" onClick={() => handleRemoveBulkItem(item.id)} className="p-2 mb-0.5 text-slate-500 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors">
                                                        <Icon name="trash-2" size={18} />
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                        <div className="pt-2">
                                            <button type="button" onClick={handleAddBulkItem} className="text-sm font-bold text-blue-400 hover:text-blue-300 flex items-center gap-1 transition-colors">
                                                <Icon name="plus-circle" size={16} /> Agregar otra línea
                                            </button>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Concepto Factura (Opcional)</label>
                                            <input type="text" value={bulkDesc} onChange={e => setBulkDesc(e.target.value)} className="w-full bg-slate-800 border border-transparent rounded-lg p-3 outline-none focus:border-blue-500 text-white text-sm" placeholder="Ej: Factura AA-0001" />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Monto Total Factura ($)</label>
                                            <div className="w-full bg-slate-800/80 border border-slate-700 rounded-lg p-3 text-right font-mono font-bold text-orange-400 text-lg cursor-not-allowed">
                                                ${totalBulkAmount.toLocaleString(undefined, { minimumFractionDigits: 2 })}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Fecha Op.</label>
                                            <input type="date" value={bulkDate} onChange={e => setBulkDate(e.target.value)} className="w-full bg-slate-800 border border-transparent rounded-lg p-2.5 outline-none focus:border-blue-500 text-slate-300 text-sm" required />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Archivo de Respaldo <span className="text-[9px] opacity-70">(Opcional)</span></label>
                                            <input type="file" onChange={e => setBulkReceiptFile(e.target.files[0])} className="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-bold file:bg-blue-600/20 file:text-blue-400 hover:file:bg-blue-600/30 file:transition-colors bg-slate-800 rounded-lg pr-3" />
                                        </div>
                                    </div>
                                    <div className="flex gap-3 pt-4 border-t border-slate-800 mt-6">
                                        <button type="button" onClick={handleCloseBulkModal} className="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 p-3 rounded-xl font-bold transition-colors" disabled={isSubmittingTx}>Cancelar</button>
                                        <button type="submit" disabled={isSubmittingTx || totalBulkAmount <= 0} className={`flex-1 p-3 rounded-xl font-bold text-white flex justify-center items-center gap-2 transition-colors bg-blue-600 hover:bg-blue-500 disabled:opacity-50`}>
                                            {isSubmittingTx ? <><Icon name="loader" size={18} className="animate-spin" /> Guardando...</> : <><Icon name="save" size={18} /> Cargar Factura En Cuenta</>}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Login Component (Supabase Auth) ---
        const Login = () => {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [successMsg, setSuccessMsg] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccessMsg('');
                setIsLoading(true);

                try {
                    // Iniciar Sesión (Única opción)
                    const { data, error: authError } = await window.supabaseClient.auth.signInWithPassword({
                        email: email.trim(),
                        password: pass,
                    });
                    if (authError) throw authError;
                    // App.js manejará el estado a través del onAuthStateChange
                } catch (error) {
                    // Traducción básica de errores comunes
                    let msg = error.message;
                    if (msg.includes("Invalid login credentials")) msg = "Credenciales incorrectas";
                    setError(msg);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 p-4">
                    <div className="glass p-8 rounded-2xl w-full max-w-md shadow-2xl border border-slate-700 relative overflow-hidden">

                        {/* Decoración */}
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 to-indigo-500"></div>

                        <div className="text-center mb-8">
                            <div className="bg-blue-600/20 p-4 rounded-full inline-flex mb-4 border border-blue-500/30">
                                <Icon name="log-in" size={32} className="text-blue-400" />
                            </div>
                            <h2 className="text-2xl font-bold text-white tracking-tight">
                                Iniciar Sesión
                            </h2>
                            <p className="text-slate-400 text-sm mt-2">
                                Ingresa tus datos para acceder a tu panel
                            </p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-5">
                            {error && (
                                <div className="bg-red-500/10 text-red-400 p-3 rounded-lg text-sm text-center border border-red-500/20 flex items-center justify-center gap-2">
                                    <Icon name="alert-circle" size={16} /> {error}
                                </div>
                            )}
                            {successMsg && (
                                <div className="bg-emerald-500/10 text-emerald-400 p-3 rounded-lg text-sm text-center border border-emerald-500/20 flex items-center justify-center gap-2">
                                    <Icon name="check-circle" size={16} /> {successMsg}
                                </div>
                            )}

                            <div>
                                <label className="text-[10px] uppercase text-slate-400 block mb-1.5 font-bold tracking-wider">Email</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500 group-focus-within:text-blue-400 transition-colors">
                                        <Icon name="mail" size={18} />
                                    </div>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        autoCapitalize="none"
                                        autoComplete="email"
                                        autoCorrect="off"
                                        className="w-full bg-slate-900 border border-slate-700 rounded-xl pl-10 p-3 focus:ring-2 focus:border-transparent ring-blue-500 outline-none text-white transition-all text-sm"
                                        placeholder="tu@correo.com"
                                        required
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] uppercase text-slate-400 block mb-1.5 font-bold tracking-wider">Contraseña</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500 group-focus-within:text-blue-400 transition-colors">
                                        <Icon name="key" size={18} />
                                    </div>
                                    <input
                                        type="password"
                                        value={pass}
                                        onChange={(e) => setPass(e.target.value)}
                                        className="w-full bg-slate-900 border border-slate-700 rounded-xl pl-10 p-3 focus:ring-2 focus:border-transparent ring-blue-500 outline-none text-white transition-all text-sm"
                                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                        minLength="6"
                                        required
                                    />
                                </div>
                            </div>

                            <button type="submit" disabled={isLoading} className="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-50 p-3 rounded-xl font-bold transition-all shadow-[0_0_20px_rgba(37,99,235,0.3)] hover:shadow-[0_0_25px_rgba(37,99,235,0.5)] flex items-center justify-center gap-2 mt-4">
                                {isLoading ? <span className="animate-pulse">Cargando...</span> : (
                                    <><Icon name="log-in" size={20} /> Entrar</>
                                )}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const OperativeCosts = ({ tenantId }) => {
            const [costs, setCosts] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [filterCategory, setFilterCategory] = useState('ALL'); // ALL, Fijo, Variable

            // Mes Helper: Format YYYY-MM
            const getCurrentMonth = () => {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            };
            const [filterMonth, setFilterMonth] = useState(getCurrentMonth());

            const [formData, setFormData] = useState({
                concepto: '',
                monto: '',
                categoria: 'Fijo',
                fecha: new Date().toISOString().split('T')[0]
            });

            useEffect(() => {
                fetchCosts();
            }, [tenantId]);

            const fetchCosts = async () => {
                setIsLoading(true);
                try {
                    const { data, error } = await window.supabaseClient
                        .from('costos_operativos')
                        .select('*')
                        .order('fecha_gasto', { ascending: false });

                    if (error) throw error;
                    setCosts(data || []);
                } catch (err) {
                    console.error("Error obteniendo costos:", err);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.monto || isNaN(formData.monto)) return;
                setIsSubmitting(true);

                try {
                    const numAmount = Math.abs(parseFloat(formData.monto));
                    const { data, error } = await window.supabaseClient.from('costos_operativos').insert([{
                        tenant_id: tenantId,
                        concepto: formData.concepto,
                        monto: numAmount,
                        categoria: formData.categoria,
                        fecha_gasto: formData.fecha
                    }]).select();

                    if (error) throw error;

                    if (data && data.length > 0) {
                        setCosts([data[0], ...costs].sort((a, b) => new Date(b.fecha_gasto) - new Date(a.fecha_gasto)));
                        setFormData({ ...formData, concepto: '', monto: '' });
                    }
                } catch (err) {
                    window.addToast("Error al guardar egreso: " + err.message, 'error');
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleDelete = async (id) => {
                if (!(await window.confirmAsync("¿Deseas eliminar este registro de gasto de forma permanente?"))) return;
                try {
                    await window.supabaseClient.from('costos_operativos').delete().eq('id', id);
                    setCosts(costs.filter(c => c.id !== id));
                } catch (err) {
                    console.error("Error eliminando:", err);
                }
            };

            // Filtrado Reactivo
            const filteredCosts = costs.filter(c => {
                // Filtro Categoria
                if (filterCategory !== 'ALL' && c.categoria !== filterCategory) return false;

                // Filtro Mes (comparar YYYY-MM)
                if (filterMonth) {
                    const costMonth = c.fecha_gasto.substring(0, 7); // ej: "2026-02-23" -> "2026-02"
                    if (costMonth !== filterMonth) return false;
                }

                return true;
            });

            const totalAmount = filteredCosts.reduce((acc, curr) => acc + Number(curr.monto), 0);

            return (
                <div className="p-4 md:p-8 pb-20">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 md:mb-8">
                        <h2 className="text-2xl md:text-3xl font-bold text-orange-400 flex items-center gap-3">
                            <Icon name="receipt" size={28} /> Costos Operativos
                        </h2>

                        {/* Filtros Globales de la Cabecera */}
                        <div className="flex flex-wrap items-center gap-3 bg-slate-800/50 p-2 rounded-xl border border-slate-700/50">
                            <input
                                type="month"
                                value={filterMonth}
                                onChange={(e) => setFilterMonth(e.target.value)}
                                className="bg-slate-900 border border-slate-700 text-slate-300 rounded-lg px-3 py-1.5 text-sm outline-none focus:border-blue-500"
                            />
                            <div className="h-6 w-px bg-slate-700 mx-1 hidden sm:block"></div>
                            <div className="flex bg-slate-900 rounded-lg p-1 overflow-x-auto">
                                <button onClick={() => setFilterCategory('ALL')} className={`px-3 py-1 rounded text-xs transition-colors font-bold ${filterCategory === 'ALL' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}>Totales</button>
                                <button onClick={() => setFilterCategory('Fijo')} className={`px-3 py-1 rounded text-xs transition-colors font-bold ${filterCategory === 'Fijo' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'}`}>Fijos</button>
                                <button onClick={() => setFilterCategory('Variable')} className={`px-3 py-1 rounded text-xs transition-colors font-bold ${filterCategory === 'Variable' ? 'bg-amber-600 text-white' : 'text-slate-400 hover:text-white'}`}>Variables</button>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

                        {/* Left Column: Form */}
                        <div className="lg:col-span-1 glass p-6 rounded-2xl h-fit sticky top-24">
                            <h3 className="text-xl font-semibold mb-6 flex items-center gap-2 text-red-400"><Icon name="minus-circle" /> Registrar Egreso</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Categoría</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button type="button" onClick={() => setFormData({ ...formData, categoria: 'Fijo' })} className={`py-2 px-3 rounded-lg text-sm font-bold border transition-all ${formData.categoria === 'Fijo' ? 'bg-purple-600/20 border-purple-500 text-purple-300' : 'bg-slate-800 border-transparent text-slate-400 hover:bg-slate-700'}`}>Fijo</button>
                                        <button type="button" onClick={() => setFormData({ ...formData, categoria: 'Variable' })} className={`py-2 px-3 rounded-lg text-sm font-bold border transition-all ${formData.categoria === 'Variable' ? 'bg-amber-600/20 border-amber-500 text-amber-300' : 'bg-slate-800 border-transparent text-slate-400 hover:bg-slate-700'}`}>Variable</button>
                                    </div>
                                    <p className="text-[10px] text-slate-500 mt-1">{formData.categoria === 'Fijo' ? 'Luz, Alquileres, Sueldos fijos.' : 'Reparaciones, Viáticos imprevistos, etc.'}</p>
                                </div>

                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Concepto / Motivo</label>
                                    <input required value={formData.concepto} onChange={e => setFormData({ ...formData, concepto: e.target.value })} className="w-full bg-slate-800 border border-transparent focus:border-red-500 rounded-lg p-2.5 outline-none text-sm text-slate-200" placeholder="Ej: Arreglo de escuadradora" />
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-xs uppercase text-slate-400 block mb-1">Monto ($)</label>
                                        <input required type="number" step="1" value={formData.monto} onChange={e => setFormData({ ...formData, monto: e.target.value })} className="w-full bg-slate-800 border border-transparent focus:border-red-500 rounded-lg p-2.5 outline-none font-mono font-bold text-red-400 text-sm" placeholder="0" />
                                    </div>
                                    <div>
                                        <label className="text-xs uppercase text-slate-400 block mb-1">Fecha</label>
                                        <input required type="date" value={formData.fecha} onChange={e => setFormData({ ...formData, fecha: e.target.value })} className="w-full bg-slate-800 border border-transparent focus:border-red-500 rounded-lg p-2.5 outline-none text-slate-300 text-sm" />
                                    </div>
                                </div>

                                <button type="submit" disabled={isSubmitting} className="w-full bg-red-600 hover:bg-red-500 disabled:opacity-50 p-3 mt-4 rounded-lg font-bold transition-all flex items-center justify-center gap-2 shadow-lg shadow-red-900/20">
                                    {isSubmitting ? <Icon name="loader" size={18} className="animate-spin" /> : <Icon name="check" size={18} />} Guardar Gasto
                                </button>
                            </form>
                        </div>

                        {/* Right Column: Viewer */}
                        <div className="lg:col-span-2 space-y-6">

                            {/* KPI Board */}
                            <div className="glass p-5 rounded-2xl border-l-4 border-l-red-500 flex justify-between items-center">
                                <div>
                                    <h4 className="text-slate-400 text-sm font-semibold uppercase tracking-wider mb-1">Gasto Operativo</h4>
                                    <p className="text-xs text-slate-500">Según los filtros aplicados en cabecera</p>
                                </div>
                                <span className={`text-3xl lg:text-4xl font-mono font-bold ${totalAmount > 0 ? 'text-red-400' : 'text-slate-500'}`}>
                                    ${totalAmount.toLocaleString()}
                                </span>
                            </div>

                            {/* List */}
                            <div className="glass rounded-2xl overflow-hidden">
                                {isLoading ? (
                                    <div className="p-10 text-center text-slate-500 flex flex-col items-center gap-3">
                                        <Icon name="loader" className="animate-spin text-slate-400" /> Cargando gastos...
                                    </div>
                                ) : filteredCosts.length === 0 ? (
                                    <div className="p-10 text-center text-slate-500 flex flex-col items-center gap-3">
                                        <Icon name="inbox" size={32} className="opacity-50" />
                                        <p>No hay gastos registrados para estos filtros.</p>
                                    </div>
                                ) : (
                                    <div className="divide-y divide-slate-800/50">
                                        {filteredCosts.map(c => {
                                            const displayDate = c.fecha_gasto.includes('-') ? c.fecha_gasto.split('-').reverse().join('/') : c.fecha_gasto;
                                            const isFijo = c.categoria === 'Fijo';
                                            return (
                                                <div key={c.id} className="p-4 hover:bg-slate-800/30 transition-colors flex items-center justify-between group">
                                                    <div className="flex items-center gap-4">
                                                        <div className={`p-2.5 rounded-lg ${isFijo ? 'bg-purple-500/10 text-purple-400' : 'bg-amber-500/10 text-amber-400'}`}>
                                                            <Icon name={isFijo ? 'calendar' : 'zap'} size={18} />
                                                        </div>
                                                        <div>
                                                            <div className="flex items-center gap-2">
                                                                <h4 className="font-semibold text-slate-200">{c.concepto}</h4>
                                                                <span className={`text-[9px] uppercase font-bold px-1.5 py-0.5 rounded border ${isFijo ? 'border-purple-500/30 text-purple-400' : 'border-amber-500/30 text-amber-400'}`}>
                                                                    {c.categoria}
                                                                </span>
                                                            </div>
                                                            <span className="text-xs text-slate-500 block mt-0.5">{displayDate}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-4">
                                                        <span className="font-mono font-bold text-red-400 text-lg">
                                                            -${Number(c.monto).toLocaleString()}
                                                        </span>
                                                        <button
                                                            onClick={() => handleDelete(c.id)}
                                                            className="text-slate-600 hover:text-red-500 p-1.5 rounded-lg hover:bg-red-500/10 transition-colors opacity-0 group-hover:opacity-100"
                                                            title="Eliminar Gasto"
                                                        >
                                                            <Icon name="trash-2" size={16} />
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Statistics = ({ tenantId }) => {
            const [stats, setStats] = useState({
                owed: 0,
                collected: 0,
                toPay: 0,
                costs: 0,
                liquidity: 0,
                margin: 0,
                coverage: 0,
                aging: [],
                variations: { owed: 0, collected: 0, costs: 0 }
            });
            const [chartData, setChartData] = useState([]);
            const [costsData, setCostsData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            // Visibility Toggles (Ojitos state)
            const [showOwed, setShowOwed] = useState(true);
            const [showCollected, setShowCollected] = useState(true);
            const [showToPay, setShowToPay] = useState(true);

            // Active Chart State
            const [activeChart, setActiveChart] = useState('FLUJO_CAJA'); // FLUJO_CAJA, ADEUDADO, COBRADO, A_PAGAR, COSTOS, LIQUIDEZ

            // Filtro Global de Mes y Año
            const [selectedMonth, setSelectedMonth] = useState(''); // Formato YYYY-MM

            useEffect(() => {
                if (!tenantId) return;

                const loadDashboardData = async () => {
                    setIsLoading(true);
                    try {
                        const currentMonth = selectedMonth || new Date().toISOString().substring(0, 7);
                        const prevDate = new Date(currentMonth + '-01');
                        prevDate.setMonth(prevDate.getMonth() - 1);
                        const prevMonth = prevDate.toISOString().substring(0, 7);

                        // 1. Fetch Summary Data (Current & Previous)
                        const { data: summaryData } = await window.supabaseClient.from('financial_monthly_summary').select('*').eq('tenant_id', tenantId).in('month', [currentMonth, prevMonth]);
                        const { data: costsSummary } = await window.supabaseClient.from('costs_monthly_summary').select('*').eq('tenant_id', tenantId).in('month', [currentMonth, prevMonth]);
                        const { data: supplierSummary } = await window.supabaseClient.from('supplier_debts_monthly').select('*').eq('tenant_id', tenantId).in('month', [currentMonth, prevMonth]);
                        const { data: agingData } = await window.supabaseClient.from('debt_aging_summary').select('*').eq('tenant_id', tenantId);

                        const curr = summaryData?.find(d => d.month === currentMonth) || { total_cobrado: 0, total_adeudado: 0 };
                        const prev = summaryData?.find(d => d.month === prevMonth) || { total_cobrado: 0, total_adeudado: 0 };
                        const currCosts = costsSummary?.find(d => d.month === currentMonth) || { total_gastos: 0, gastos_fijos: 0, gastos_variables: 0 };
                        const prevCosts = costsSummary?.find(d => d.month === prevMonth) || { total_gastos: 0 };
                        const currSupp = supplierSummary?.find(d => d.month === currentMonth) || { total_a_pagar: 0 };
                        const prevSupp = supplierSummary?.find(d => d.month === prevMonth) || { total_a_pagar: 0 };

                        // 2. Calculate Stats
                        const liquidity = Number(curr.total_cobrado) - (Number(currSupp.total_a_pagar) + Number(currCosts.total_gastos));
                        const margin = (Number(curr.total_cobrado) + Number(curr.total_adeudado)) - (Number(currSupp.total_a_pagar) + Number(currCosts.total_gastos));
                        const coverage = Number(currCosts.total_gastos) > 0 ? (Number(curr.total_adeudado) / Number(currCosts.total_gastos)).toFixed(1) : 0;

                        // 3. Calculate Variations (MoM)
                        const calcVar = (c, p) => p > 0 ? ((c - p) / p * 100).toFixed(0) : 0;

                        setStats({
                            owed: Number(curr.total_adeudado),
                            collected: Number(curr.total_cobrado),
                            toPay: Number(currSupp.total_a_pagar),
                            costs: Number(currCosts.total_gastos),
                            liquidity,
                            margin,
                            coverage,
                            breakEven: Number(currCosts.total_gastos),
                            aging: agingData || [],
                            variations: {
                                owed: calcVar(Number(curr.total_adeudado), Number(prev.total_adeudado)),
                                collected: calcVar(Number(curr.total_cobrado), Number(prev.total_cobrado)),
                                costs: calcVar(Number(currCosts.total_gastos), Number(prevCosts.total_gastos))
                            }
                        });

                        // 4. Chart Data
                        let tcQuery = window.supabaseClient.from('transacciones_clientes').select('*').eq('tenant_id', tenantId).order('created_at');
                        let tpQuery = window.supabaseClient.from('transacciones_proveedores').select('*').eq('tenant_id', tenantId).order('created_at');

                        const { data: transClientes } = await tcQuery;
                        const { data: transProveedores } = await tpQuery;

                        const monthlyData = {};
                        const getMonthYear = (dateString) => {
                            const d = new Date(dateString);
                            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                            return `${months[d.getMonth()]} ${d.getFullYear()}`;
                        };

                        (transClientes || []).forEach(tc => {
                            if (tc.tipo === 'COBRO') {
                                const my = getMonthYear(tc.created_at);
                                if (!monthlyData[my]) monthlyData[my] = { name: my, Entradas: 0, Salidas: 0, Orden: new Date(tc.created_at).getTime() };
                                monthlyData[my].Entradas += Number(tc.monto);
                            }
                        });

                        (transProveedores || []).forEach(tp => {
                            if (tp.tipo === 'PAGO') {
                                const my = getMonthYear(tp.created_at);
                                if (!monthlyData[my]) monthlyData[my] = { name: my, Entradas: 0, Salidas: 0, Orden: new Date(tp.created_at).getTime() };
                                monthlyData[my].Salidas += Math.abs(Number(tp.monto));
                            }
                        });

                        setChartData(Object.values(monthlyData).sort((a, b) => a.Orden - b.Orden));

                        // 5. Costs Chart Data
                        setCostsData(costsSummary?.map(c => ({
                            name: getMonthYear(c.month + '-02'),
                            Fijos: Number(c.gastos_fijos),
                            Variables: Number(c.gastos_variables),
                            Total: Number(c.total_gastos),
                            Orden: new Date(c.month + '-01').getTime()
                        })).sort((a, b) => a.Orden - b.Orden) || []);

                    } catch (e) {
                        console.error("Error loading stats", e);
                    } finally {
                        setIsLoading(false);
                    }
                };

                loadDashboardData();
            }, [tenantId, selectedMonth]);

            // Formato Ayuda
            const filterLabel = selectedMonth ? `(Mes ${selectedMonth})` : '';

            return (
                <div className="p-4 md:p-8 pb-20">
                    <div className="flex flex-col md:flex-row md:justify-between md:items-center mb-6 md:mb-8 gap-4">
                        <h2 className="text-2xl md:text-3xl font-bold text-blue-400 flex items-center gap-3">
                            <Icon name="bar-chart-2" size={28} /> Estadísticas {isLoading && <Icon name="loader" size={24} className="animate-spin text-slate-500" />}
                        </h2>

                        {/* Filtro por Mes (Input Nativo HTML5) */}
                        <div className="flex items-center gap-3 bg-slate-800/80 border border-slate-700 p-2 px-4 rounded-xl shadow-lg">
                            <Icon name="calendar" size={18} className="text-blue-400" />
                            <div className="hidden md:block text-sm font-semibold text-slate-300">Filtrar por Período:</div>
                            <input
                                type="month"
                                value={selectedMonth}
                                onChange={(e) => setSelectedMonth(e.target.value)}
                                className="bg-slate-900 text-white border border-slate-600 rounded-lg p-1.5 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-sm outline-none cursor-pointer"
                                lang="es-AR"
                            />
                            {selectedMonth && (
                                <button onClick={() => setSelectedMonth('')} className="text-xs text-slate-400 hover:text-red-400 transition-colors tooltip" title="Quitar Filtro">
                                    <Icon name="x" size={16} />
                                </button>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        {/* LEFT PANEL: KPIs & Toggles */}
                        <div className="lg:col-span-1 space-y-4">

                            {/* KPI 1: Adeudado */}
                            <div
                                onClick={() => setActiveChart(activeChart === 'ADEUDADO' ? 'FLUJO_CAJA' : 'ADEUDADO')}
                                className={`glass rounded-xl overflow-hidden group relative cursor-pointer transition-all ${activeChart === 'ADEUDADO' ? 'border-2 border-orange-500 shadow-[0_0_15px_rgba(249,115,22,0.3)] bg-slate-800/80' : 'border border-blue-500/20 hover:border-orange-500/50 hover:bg-slate-800/50'}`}
                            >
                                <div className="absolute top-0 right-0 w-24 h-24 bg-orange-500/10 rounded-bl-full -z-10 group-hover:scale-110 transition-transform"></div>
                                <div className="p-5">
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className={`text-sm font-bold uppercase ${activeChart === 'ADEUDADO' ? 'text-orange-400' : 'text-slate-300'}`}>Total Adeudado</h3>
                                        <div className="flex items-center gap-2">
                                            {stats.variations?.owed != 0 && (
                                                <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded-full ${Number(stats.variations?.owed) > 0 ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>
                                                    {Number(stats.variations?.owed) > 0 ? '+' : ''}{stats.variations?.owed}%
                                                </span>
                                            )}
                                            <button onClick={(e) => { e.stopPropagation(); setShowOwed(!showOwed); }} className={`p-1.5 rounded-lg transition-colors z-10 relative ${showOwed ? 'bg-orange-500/20 text-orange-400' : 'bg-slate-800 text-slate-500 hover:bg-slate-700'}`}>
                                                <Icon name={showOwed ? "eye" : "eye-off"} size={16} />
                                            </button>
                                        </div>
                                    </div>
                                    <p className="text-2xl font-mono font-bold text-white mb-1">
                                        {isLoading ? '...' : (showOwed ? `$${(stats.owed || 0).toLocaleString()}` : '****')}
                                    </p>
                                    <p className="text-[10px] text-slate-400 uppercase flex items-center gap-1"><Icon name="users" size={10} /> Deuda de Clientes {filterLabel}</p>
                                </div>
                            </div>

                            {/* KPI 2: Margen Neto Proyectado */}
                            <div
                                onClick={() => setActiveChart('A_PAGAR')}
                                className={`glass rounded-xl overflow-hidden group relative cursor-pointer border transition-all p-5 ${activeChart === 'A_PAGAR' ? 'border-2 border-blue-400 bg-blue-900/40' : 'border-blue-500/20 hover:border-blue-400/50 hover:bg-slate-800/50'}`}
                            >
                                <div className="absolute top-0 right-0 w-24 h-24 bg-blue-500/5 rounded-bl-full -z-10"></div>
                                <h3 className={`text-xs font-bold uppercase mb-1 ${activeChart === 'A_PAGAR' ? 'text-blue-200' : 'text-slate-400'}`}>Margen Neto Proyectado</h3>
                                <p className={`text-xl font-mono font-bold ${(stats.margin || 0) >= 0 ? 'text-blue-400' : 'text-red-400'}`}>
                                    {isLoading ? '...' : `$${(stats.margin || 0).toLocaleString()}`}
                                </p>
                                <div className="mt-2 text-[9px] text-slate-500 uppercase leading-tight">
                                    (Cobrado + Adeudado) - (A Pagar + Gastos)
                                </div>
                            </div>

                            {/* KPI 3: Liquidez Real */}
                            <div
                                onClick={() => setActiveChart('FLUJO_CAJA')}
                                className={`glass rounded-xl overflow-hidden group relative cursor-pointer border transition-all p-5 ${activeChart === 'FLUJO_CAJA' ? 'border-2 border-emerald-500 bg-emerald-500/10' : 'border-emerald-500/30 bg-emerald-500/5 hover:bg-emerald-500/10'}`}
                            >
                                <h3 className={`text-xs font-bold uppercase mb-1 ${activeChart === 'FLUJO_CAJA' ? 'text-emerald-200' : 'text-emerald-400'}`}>Flujo de Caja Neto</h3>
                                <p className={`text-xl font-mono font-bold ${(stats.liquidity || 0) >= 0 ? 'text-emerald-100' : 'text-red-400'}`}>
                                    {isLoading ? '...' : `$${(stats.liquidity || 0).toLocaleString()}`}
                                </p>
                                <p className="text-[9px] text-emerald-500/60 uppercase mt-1">Cobrado - (A Pagar + Gastos)</p>
                            </div>

                            {/* KPI 4: Ratio de Cobertura */}
                            <div
                                onClick={() => setActiveChart('ADEUDADO')}
                                className={`glass rounded-xl overflow-hidden group relative cursor-pointer border transition-all p-5 ${activeChart === 'ADEUDADO' ? 'border-2 border-orange-400 bg-orange-900/20' : 'border-orange-500/20 hover:border-orange-400/50 hover:bg-slate-800/50'}`}
                            >
                                <h3 className={`text-xs font-bold uppercase mb-1 ${activeChart === 'ADEUDADO' ? 'text-orange-200' : 'text-slate-400'}`}>Ratio de Cobertura</h3>
                                <div className="flex items-end gap-2">
                                    <p className="text-xl font-mono font-bold text-white">
                                        {isLoading ? '...' : `${stats.coverage || 0}x`}
                                    </p>
                                    <span className="text-[10px] text-slate-500 mb-1">Meses de Op.</span>
                                </div>
                                <p className="text-[9px] text-slate-500 uppercase mt-1">Adeudado / Gasto Mensual</p>
                            </div>

                            {/* Card 4: Costos */}
                            <div
                                onClick={() => setActiveChart('COSTOS')}
                                className={`glass rounded-xl overflow-hidden group relative mt-4 cursor-pointer transition-all p-5 flex flex-col ${activeChart === 'COSTOS' ? 'border-2 border-blue-400 bg-blue-900/40' : 'border border-blue-500/30 hover:border-blue-400/80 hover:bg-blue-900/30'}`}
                            >
                                <div className="flex justify-between items-center mb-1">
                                    <h3 className={`text-xs font-bold uppercase ${activeChart === 'COSTOS' ? 'text-white' : 'text-blue-300'}`}>Gastos del Mes</h3>
                                    {stats.variations?.costs != 0 && (
                                        <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded-full ${Number(stats.variations?.costs) > 0 ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>
                                            {Number(stats.variations?.costs) > 0 ? '+' : ''}{stats.variations?.costs}%
                                        </span>
                                    )}
                                </div>
                                <p className="text-xl font-mono font-bold text-blue-100">
                                    {isLoading ? '...' : `$${(stats.costs || 0).toLocaleString()}`}
                                </p>
                            </div>

                        </div>

                        {/* RIGHT PANEL: Chart Area */}
                        <div className="lg:col-span-3 glass p-6 rounded-2xl flex flex-col">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-lg font-bold text-slate-200 flex items-center gap-2">
                                    <Icon name={activeChart === 'FLUJO_CAJA' ? "activity" : activeChart === 'COSTOS' ? "bar-chart" : "pie-chart"} />
                                    {
                                        activeChart === 'FLUJO_CAJA' ? 'Flujo de Caja Mensual' :
                                            activeChart === 'ADEUDADO' ? 'Efectividad de Cobro (Histórico)' :
                                                activeChart === 'COBRADO' ? 'Efectividad de Cobro (Histórico)' :
                                                    activeChart === 'A_PAGAR' ? 'Liquidez (Cuentas a Cobrar vs A Pagar)' :
                                                        'Costos Operativos: Fijos vs Variables'
                                    }
                                </h3>
                                {activeChart !== 'FLUJO_CAJA' && (
                                    <button onClick={() => setActiveChart('FLUJO_CAJA')} className="text-xs text-blue-400 hover:text-white bg-blue-500/10 hover:bg-blue-500/30 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1 font-bold">
                                        <Icon name="corner-up-left" size={14} /> Volver al flujo
                                    </button>
                                )}
                            </div>
                            <div className="flex-grow flex items-center justify-center min-h-[400px]">
                                {isLoading ? (
                                    <div className="text-slate-400 text-center relative w-full h-full flex flex-col items-center justify-center">
                                        <Icon name="loader" size={48} className="mx-auto mb-4 animate-[spin_2s_linear_infinite] opacity-50" />
                                        <span className="animate-pulse">Calculando gráficas Recharts...</span>
                                    </div>
                                ) : (!window.Recharts || !window.Recharts.ResponsiveContainer) ? (
                                    <div className="text-center text-slate-500">
                                        <Icon name="loader" size={48} className="mx-auto opacity-30 mb-4 animate-[spin_2s_linear_infinite]" />
                                        <span className="block text-sm">Cargando módulos de gráficas...</span>
                                    </div>
                                ) : activeChart === 'FLUJO_CAJA' ? (
                                    chartData.length === 0 ? (
                                        <div className="text-center text-slate-500">
                                            <Icon name="x-circle" size={48} className="mx-auto opacity-30 mb-4" />
                                            <span className="block text-sm">No hay flujos de pagos o cobros recientes.</span>
                                        </div>
                                    ) : (
                                        <window.Recharts.ResponsiveContainer width="100%" height="100%">
                                            <window.Recharts.LineChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>
                                                <window.Recharts.CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                                <window.Recharts.XAxis dataKey="name" stroke="#94a3b8" tick={{ fill: '#94a3b8', fontSize: 12 }} tickLine={false} axisLine={false} />
                                                <window.Recharts.YAxis stroke="#94a3b8" tick={{ fill: '#94a3b8', fontSize: 12 }} tickLine={false} axisLine={false} tickFormatter={(value) => `$${value / 1000}k`} />
                                                <window.Recharts.Tooltip
                                                    contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #475569', borderRadius: '8px', color: '#f8fafc' }}
                                                    itemStyle={{ fontWeight: 'bold' }}
                                                    formatter={(value) => [`$${value.toLocaleString()}`, '']}
                                                />
                                                <window.Recharts.Legend wrapperStyle={{ paddingTop: '20px' }} />
                                                {(showCollected) && <window.Recharts.Line type="monotone" name="Ingresos (Cobrado a Cliente)" dataKey="Entradas" stroke="#10b981" strokeWidth={3} dot={{ r: 4, fill: '#10b981', strokeWidth: 0 }} activeDot={{ r: 6 }} />}
                                                {(showToPay || showOwed) && <window.Recharts.Line type="monotone" name="Egresos (Pagado a Proveedor)" dataKey="Salidas" stroke="#ef4444" strokeWidth={3} dot={{ r: 4, fill: '#ef4444', strokeWidth: 0 }} activeDot={{ r: 6 }} />}
                                            </window.Recharts.LineChart>
                                        </window.Recharts.ResponsiveContainer>
                                    )
                                ) : (activeChart === 'ADEUDADO' || activeChart === 'COBRADO') ? (
                                    <window.Recharts.ResponsiveContainer width="100%" height="100%">
                                        <window.Recharts.PieChart>
                                            <window.Recharts.Pie
                                                data={stats.aging?.length > 0 ? stats.aging : [{ name: 'Sin deuda', value: 1, fill: '#1e293b' }]}
                                                cx="50%" cy="50%"
                                                innerRadius={100} outerRadius={140}
                                                paddingAngle={5}
                                                dataKey="amount"
                                                nameKey="range"
                                                label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                                            >
                                                {
                                                    (stats.aging || []).map((entry, index) => (
                                                        <window.Recharts.Cell
                                                            key={`cell-${index}`}
                                                            fill={entry.range === '0-30 días' ? '#10b981' : entry.range === '31-60 días' ? '#f59e0b' : '#ef4444'}
                                                        />
                                                    ))
                                                }
                                            </window.Recharts.Pie>
                                            <window.Recharts.Tooltip formatter={(value) => `$${value.toLocaleString()}`} contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }} />
                                            <window.Recharts.Legend verticalAlign="bottom" height={36} />
                                        </window.Recharts.PieChart>
                                    </window.Recharts.ResponsiveContainer>
                                ) : activeChart === 'A_PAGAR' ? (
                                    <window.Recharts.ResponsiveContainer width="100%" height="100%">
                                        <window.Recharts.BarChart
                                            data={[
                                                { name: 'Balance Actual', "Te Deben (Clientes)": stats.owed, "Vos Debés (Proveedores)": stats.toPay }
                                            ]}
                                            margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
                                        >
                                            <window.Recharts.CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                            <window.Recharts.XAxis dataKey="name" stroke="#94a3b8" />
                                            <window.Recharts.YAxis stroke="#94a3b8" tickFormatter={(value) => `$${value / 1000}k`} />
                                            <window.Recharts.Tooltip cursor={{ fill: '#334155', opacity: 0.4 }} formatter={(value) => `$${value.toLocaleString()}`} contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }} />
                                            <window.Recharts.Legend />
                                            <window.Recharts.Bar dataKey="Te Deben (Clientes)" fill="#f97316" radius={[4, 4, 0, 0]} barSize={80} />
                                            <window.Recharts.Bar dataKey="Vos Debés (Proveedores)" fill="#ef4444" radius={[4, 4, 0, 0]} barSize={80} />
                                        </window.Recharts.BarChart>
                                    </window.Recharts.ResponsiveContainer>
                                ) : activeChart === 'COSTOS' ? (
                                    costsData.length === 0 ? (
                                        <div className="text-center text-slate-500">
                                            <Icon name="x-circle" size={48} className="mx-auto opacity-30 mb-4" />
                                            <span className="block text-sm">No hay costos registrados recientemente.</span>
                                        </div>
                                    ) : (
                                        <window.Recharts.ResponsiveContainer width="100%" height="100%">
                                            <window.Recharts.BarChart data={costsData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
                                                <window.Recharts.CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                                <window.Recharts.XAxis dataKey="name" stroke="#94a3b8" />
                                                <window.Recharts.YAxis stroke="#94a3b8" tickFormatter={(value) => `$${value / 1000}k`} />
                                                <window.Recharts.Tooltip cursor={{ fill: '#334155', opacity: 0.2 }} formatter={(value) => `$${value.toLocaleString()}`} contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }} />
                                                <window.Recharts.Legend />
                                                <window.Recharts.Bar dataKey="Fijos" fill="#9333ea" radius={[4, 4, 0, 0]} />
                                                <window.Recharts.Bar dataKey="Variables" fill="#d97706" radius={[4, 4, 0, 0]} />
                                                <window.Recharts.ReferenceLine y={stats.breakEven} label="Punto de Equilibrio" stroke="#ef4444" strokeDasharray="3 3" />
                                            </window.Recharts.BarChart>
                                        </window.Recharts.ResponsiveContainer>
                                    )
                                ) : null}
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        const PriceList = ({ tenantId }) => {
            const [items, setItems] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortOrder, setSortOrder] = useState('asc');

            useEffect(() => {
                if (!tenantId) return;
                const fetchData = async () => {
                    setIsLoading(true);
                    try {
                        const [itemsRes, suppliersRes] = await Promise.all([
                            window.supabaseClient
                                .from('insumos_precios')
                                .select('*')
                                .eq('tenant_id', tenantId),
                            window.supabaseClient
                                .from('proveedores')
                                .select('id, name')
                                .eq('tenant_id', tenantId)
                        ]);
                        if (itemsRes.error) throw itemsRes.error;
                        if (suppliersRes.error) throw suppliersRes.error;
                        setItems(itemsRes.data.map(d => ({ ...d, _localId: d.id, proveedor_id: d.proveedor_id || '' })));
                        setSuppliers(suppliersRes.data || []);
                    } catch (err) {
                        console.error("Fetch error", err);
                        window.addToast("Error al cargar datos.", 'error');
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, [tenantId]);

            const handleAddRow = () => {
                const newRow = {
                    id: null,
                    _localId: Date.now().toString(),
                    tenant_id: tenantId,
                    proveedor_id: '',
                    proveedor: '', // Keep for text fallback/UI if needed, but primary is DB
                    producto: '',
                    unidad_compra: '',
                    cantidad: 1,
                    precio_unidad: 0,
                    precio_total: 0
                };
                setItems([...items, newRow]);
            };

            const handleChange = (localId, field, value) => {
                if (field === 'proveedor_id') {
                    const sup = suppliers.find(s => s.id === parseInt(value));
                    setItems(items.map(item => {
                        if (item._localId === localId) {
                            const newItem = { ...item, proveedor_id: value, proveedor: sup ? sup.name : '' };
                            return newItem;
                        }
                        return item;
                    }));
                } else if (field === 'producto') {
                    setItems(items.map(item => {
                        if (item._localId === localId) {
                            const newItem = { ...item, producto: value };
                            // Find the last known unit price for this specific product and supplier
                            const pastItem = items.find(i => i.proveedor_id === item.proveedor_id && i.producto === value && i._localId !== localId && i.precio_unidad > 0);
                            if (pastItem) {
                                newItem.precio_unidad = pastItem.precio_unidad;
                                newItem.precio_total = (Number(item.cantidad) || 1) * Number(pastItem.precio_unidad);
                            }
                            return newItem;
                        }
                        return item;
                    }));
                } else if (field === 'cantidad') {
                    setItems(items.map(item => {
                        if (item._localId === localId) {
                            const qty = Number(value) || 0;
                            return { ...item, cantidad: value, precio_total: qty * (Number(item.precio_unidad) || 0) };
                        }
                        return item;
                    }));
                } else if (field === 'precio_unidad') {
                    setItems(items.map(item => {
                        if (item._localId === localId) {
                            const pU = Number(value) || 0;
                            return { ...item, precio_unidad: value, precio_total: (Number(item.cantidad) || 1) * pU };
                        }
                        return item;
                    }));
                } else {
                    setItems(items.map(item => item._localId === localId ? { ...item, [field]: value } : item));
                }
            };

            const handleDeleteRow = async (localId, dbId) => {
                if (dbId) {
                    if (!(await window.confirmAsync("¿Eliminar este insumo de la base de datos?"))) return;
                    try {
                        const { error } = await window.supabaseClient.from('insumos_precios').delete().eq('id', dbId);
                        if (error) throw error;
                    } catch (err) {
                        console.error(err);
                        window.addToast("Error al eliminar", 'error');
                        return;
                    }
                }
                setItems(items.filter(item => item._localId !== localId));
            };

            const handleSave = async () => {
                setIsSaving(true);
                try {
                    const toUpdate = [];
                    const toInsert = [];

                    items.forEach(item => {
                        const payload = {
                            tenant_id: tenantId,
                            proveedor: item.proveedor,
                            proveedor_id: item.proveedor_id ? parseInt(item.proveedor_id) : null,
                            producto: item.producto,
                            unidad_compra: item.unidad_compra,
                            cantidad: Number(item.cantidad) || 1,
                            precio_unidad: Number(item.precio_unidad) || 0,
                            precio_total: Number(item.precio_total) || 0
                        };
                        if (item.id) {
                            payload.id = item.id;
                            toUpdate.push(payload);
                        } else {
                            toInsert.push(payload);
                        }
                    });

                    if (toUpdate.length > 0) {
                        const { error } = await window.supabaseClient.from('insumos_precios').upsert(toUpdate, { onConflict: 'id' });
                        if (error) throw error;
                    }
                    if (toInsert.length > 0) {
                        const { error } = await window.supabaseClient.from('insumos_precios').insert(toInsert);
                        if (error) throw error;
                    }

                    const { data, error: fetchError } = await window.supabaseClient
                        .from('insumos_precios')
                        .select('*')
                        .eq('tenant_id', tenantId);

                    if (fetchError) throw fetchError;

                    setItems(data.map(d => ({ ...d, _localId: d.id })));
                    window.addToast("Cambios guardados correctamente.", 'success');
                } catch (err) {
                    console.error(err);
                    window.addToast("Error al guardar cambios: " + err.message, 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            const filteredItems = items
                .filter(item => {
                    const search = searchTerm.toLowerCase();
                    return (item.proveedor || '').toLowerCase().includes(search) ||
                        (item.producto || '').toLowerCase().includes(search);
                })
                .sort((a, b) => {
                    if (sortOrder === 'asc') return (a.precio_unidad || 0) - (b.precio_unidad || 0);
                    return (b.precio_unidad || 0) - (a.precio_unidad || 0);
                });

            return (
                <div className="p-4 md:p-8 pb-20">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 className="text-2xl md:text-3xl font-bold text-blue-400 flex items-center gap-3">
                            <Icon name="list" size={28} /> Lista de Precios
                        </h2>
                        <div className="flex gap-2">
                            <button onClick={handleAddRow} className="bg-slate-800 text-slate-300 hover:bg-slate-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
                                <Icon name="plus" size={16} /> Agregar Producto
                            </button>
                            <button onClick={handleSave} disabled={isSaving || isLoading} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors disabled:opacity-50">
                                {isSaving ? <Icon name="loader" className="animate-spin" size={16} /> : <Icon name="save" size={16} />}
                                Guardar Cambios
                            </button>
                        </div>
                    </div>

                    <div className="flex flex-col md:flex-row gap-4 mb-6">
                        <div className="relative flex-grow max-w-md">
                            <Icon name="search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                            <input
                                type="text"
                                placeholder="Buscar por Proveedor o Producto..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="w-full bg-slate-800 border-none rounded-lg pl-10 p-3 focus:ring-2 ring-blue-500 outline-none text-slate-200"
                            />
                        </div>
                        <select
                            value={sortOrder}
                            onChange={e => setSortOrder(e.target.value)}
                            className="bg-slate-800 border-none rounded-lg p-3 text-slate-200 focus:ring-2 ring-blue-500 outline-none cursor-pointer"
                        >
                            <option value="asc">Menor a Mayor (Precio Unit.)</option>
                            <option value="desc">Mayor a Menor (Precio Unit.)</option>
                        </select>
                    </div>

                    <div className="glass rounded-xl overflow-hidden overflow-x-auto border border-slate-700/50">
                        {isLoading ? (
                            <div className="p-8 text-center text-slate-400">
                                <Icon name="loader" size={32} className="animate-spin mx-auto mb-2 opacity-50" />
                                Cargando insumos...
                            </div>
                        ) : (
                            <table className="w-full text-left border-collapse">
                                <thead>
                                    <tr className="bg-slate-800/50 border-b border-slate-700 text-[10px] uppercase text-slate-400 font-bold tracking-wider">
                                        <th className="p-3 whitespace-nowrap">Proveedor</th>
                                        <th className="p-3 whitespace-nowrap">Producto</th>
                                        <th className="p-3 whitespace-nowrap">Unidad Compra</th>
                                        <th className="p-3 text-right whitespace-nowrap">Cantidad</th>
                                        <th className="p-3 text-right whitespace-nowrap">Precio x Unidad</th>
                                        <th className="p-3 text-right whitespace-nowrap">Precio Total</th>
                                        <th className="p-3 text-center w-10"></th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-800/50 text-sm">
                                    {filteredItems.length === 0 ? (
                                        <tr>
                                            <td colSpan="8" className="p-6 text-center text-slate-500 italic">No hay productos en la lista.</td>
                                        </tr>
                                    ) : filteredItems.map((item, idx) => {
                                        return (
                                            <tr key={item._localId || idx} className="hover:bg-slate-800/30 transition-colors group">
                                                <td className="p-2 min-w-[150px]">
                                                    <select value={item.proveedor_id || ''} onChange={e => handleChange(item._localId, 'proveedor_id', e.target.value)} className="w-full bg-transparent border border-transparent hover:border-slate-600 focus:border-blue-500 rounded p-1.5 outline-none text-slate-200 focus:bg-slate-800 transition-colors text-xs appearance-none">
                                                        <option value="">Seleccione Proveedor</option>
                                                        {suppliers.map(s => (
                                                            <option key={s.id} value={s.id}>{s.name}</option>
                                                        ))}
                                                    </select>
                                                </td>
                                                <td className="p-2 min-w-[200px]">
                                                    <input
                                                        type="text"
                                                        value={item.producto}
                                                        onChange={e => handleChange(item._localId, 'producto', e.target.value)}
                                                        className="w-full bg-transparent border border-transparent hover:border-slate-600 focus:border-blue-500 rounded p-1.5 outline-none text-slate-200 focus:bg-slate-800 transition-colors font-medium text-xs disabled:opacity-50"
                                                        placeholder="Melamina Blanca 18mm..."
                                                        disabled={!item.proveedor_id}
                                                    />
                                                </td>
                                                <td className="p-2">
                                                    <input type="text" value={item.unidad_compra} onChange={e => handleChange(item._localId, 'unidad_compra', e.target.value)} className="w-full bg-transparent border border-transparent hover:border-slate-600 focus:border-blue-500 rounded p-1.5 outline-none text-slate-400 focus:bg-slate-800 transition-colors text-[10px]" placeholder="Placa 18mm..." />
                                                </td>
                                                <td className="p-2 w-24">
                                                    <input type="number" step="0.01" min="0" value={item.cantidad} onChange={e => handleChange(item._localId, 'cantidad', e.target.value)} className="w-full bg-transparent border border-transparent hover:border-slate-600 focus:border-blue-500 rounded p-1.5 outline-none text-slate-300 focus:bg-slate-800 transition-colors text-right font-mono text-xs" />
                                                </td>
                                                <td className="p-2 w-32">
                                                    <div className="relative">
                                                        <span className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                                        <input type="number" step="0.01" min="0" value={item.precio_unidad} onChange={e => handleChange(item._localId, 'precio_unidad', e.target.value)} className="w-full bg-transparent border border-transparent hover:border-slate-600 focus:border-blue-500 rounded p-1.5 pl-5 outline-none text-white focus:bg-slate-800 transition-colors text-right font-mono font-bold text-xs" />
                                                    </div>
                                                </td>
                                                <td className="p-2 w-32">
                                                    <div className="relative">
                                                        <span className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                                        <input type="number" step="0.01" min="0" value={item.precio_total} onChange={e => handleChange(item._localId, 'precio_total', e.target.value)} className="w-full bg-transparent border border-transparent hover:border-slate-600 focus:border-blue-500 rounded p-1.5 pl-5 outline-none text-indigo-300 focus:bg-slate-800 transition-colors text-right font-mono font-bold text-xs" />
                                                    </div>
                                                </td>
                                                <td className="p-2 text-center">
                                                    <button onClick={() => handleDeleteRow(item._localId, item.id)} className="p-1.5 text-slate-500 hover:text-red-400 hover:bg-red-500/10 rounded transition-colors opacity-0 group-hover:opacity-100" title="Eliminar Insumo">
                                                        <Icon name="trash-2" size={16} />
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        )}
                    </div>

                    <div className="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center text-[10px] text-slate-500 gap-2">
                        <p className="flex items-center gap-1.5 bg-slate-800/50 p-2 rounded-lg border border-slate-700/50">
                            <Icon name="info" size={14} className="text-blue-400 shrink-0" />
                            <span>El cuadro soporta guardar insumos unitarios o por cantidad total según tus necesidades manuales.</span>
                        </p>
                        <p className="font-bold border border-slate-700/50 px-3 py-1.5 rounded-lg">Total insumos: <span className="text-blue-400">{items.length}</span></p>
                    </div>
                </div>
            );
        };

        // --- User Management Module ---
        const UserManagement = ({ tenantId }) => {
            const [users, setUsers] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isInviting, setIsInviting] = useState(false);
            const [newEmail, setNewEmail] = useState('');
            const [newPass, setNewPass] = useState('');
            const [newRole, setNewRole] = useState('editor');

            const fetchUsers = async () => {
                setIsLoading(true);
                try {
                    const { data, error } = await window.supabaseClient
                        .from('usuarios')
                        .select('*')
                        .eq('tenant_id', tenantId);
                    if (error) throw error;
                    setUsers(data || []);
                } catch (err) {
                    console.error(err);
                    window.addToast("Error al cargar equipo.", 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => {
                if (tenantId) fetchUsers();
            }, [tenantId]);

            const handleCreateUser = async (e) => {
                e.preventDefault();
                if (!newEmail || !newPass) return;
                setIsInviting(true);
                try {
                    // Primero intentamos agregar si el usuario ya existe en Supabase Auth
                    // Esto arregla el bug donde usuarios previamente eliminados no podían volver a agregarse (Pantalla azul)
                    const { data: userExists, error: rpcError } = await window.supabaseClient.rpc('admin_add_user_to_tenant', {
                        target_email: newEmail,
                        target_role: newRole
                    });

                    if (userExists) {
                        window.addToast("Usuario existente agregado al equipo exitosamente.", 'success');
                        setNewEmail('');
                        setNewPass('');
                        fetchUsers();
                        return;
                    }

                    // Si no existía, creamos un nuevo usuario con SignUp
                    const { data, error } = await window.supabaseClient.auth.signUp({
                        email: newEmail,
                        password: newPass,
                        options: {
                            data: {
                                role: newRole,
                                tenant_id: tenantId
                            }
                        }
                    });

                    if (error) throw error;

                    window.addToast("Usuario creado con éxito.", 'success');
                    setNewEmail('');
                    setNewPass('');
                    fetchUsers();
                } catch (err) {
                    console.error(err);
                    window.addToast(err.message || "Error al crear usuario", 'error');
                } finally {
                    setIsInviting(false);
                }
            };

            const handleDeleteUser = async (uid) => {
                if (!(await window.confirmAsync("¿Eliminar este usuario? Perderá acceso inmediatamente."))) return;
                try {
                    const { error } = await window.supabaseClient.from('usuarios').delete().eq('id', uid);
                    if (error) throw error;
                    window.addToast("Usuario eliminado.", 'success');
                    fetchUsers();
                } catch (e) {
                    console.error(e);
                    window.addToast("Error al eliminar.", 'error');
                }
            };

            return (
                <div className="p-4 md:p-8 pb-20 max-w-6xl mx-auto">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                        <div>
                            <h2 className="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-400">Gestión de Equipo</h2>
                            <p className="text-slate-400 text-sm mt-1">Administra los accesos y roles de tu carpintería.</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Listado */}
                        <div className="lg:col-span-2 glass rounded-2xl overflow-hidden shadow-xl border border-slate-700/50">
                            <div className="p-6 border-b border-slate-700/50 bg-slate-800/30">
                                <h3 className="font-bold flex items-center gap-2"><Icon name="users" className="text-blue-400" /> Miembros del Equipo</h3>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead>
                                        <tr className="text-xs uppercase tracking-wider text-slate-500 border-b border-slate-700/50 bg-slate-800/10">
                                            <th className="p-4 font-semibold">Email</th>
                                            <th className="p-4 font-semibold text-center">Rol</th>
                                            <th className="p-4 font-semibold text-right">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-800/50">
                                        {isLoading ? (
                                            <tr><td colSpan="3" className="p-10 text-center"><div className="animate-spin h-6 w-6 border-2 border-blue-500 border-t-transparent rounded-full mx-auto"></div></td></tr>
                                        ) : users.length === 0 ? (
                                            <tr><td colSpan="3" className="p-10 text-center text-slate-500 italic">No hay miembros registrados.</td></tr>
                                        ) : users.map(user => (
                                            <tr key={user.id} className="hover:bg-slate-800/20 transition-colors">
                                                <td className="p-4">
                                                    <div className="flex flex-col">
                                                        <span className="text-sm font-medium text-slate-200">{user.email}</span>
                                                        <span className="text-[10px] text-slate-500">ID: {user.id.slice(0, 8)}...</span>
                                                    </div>
                                                </td>
                                                <td className="p-4 text-center">
                                                    <span className={`px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide border 
                                                        ${user.role === 'admin' ? 'bg-blue-500/20 text-blue-400 border-blue-500/30' :
                                                            user.role === 'editor' ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30' :
                                                                'bg-slate-500/20 text-slate-400 border-slate-500/30'}`}>
                                                        {user.role}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-right">
                                                    <button onClick={() => handleDeleteUser(user.id)} className="p-2 text-slate-400 hover:text-red-400 transition-colors">
                                                        <Icon name="trash-2" size={18} />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Alta de Usuario */}
                        <div className="glass p-6 rounded-2xl shadow-xl h-fit border border-slate-700/50">
                            <h3 className="font-bold text-lg mb-6 flex items-center gap-2 text-blue-400">
                                <Icon name="user-plus" /> Agregar Miembro
                            </h3>
                            <form onSubmit={handleCreateUser} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-tight">Email del Usuario</label>
                                    <div className="relative">
                                        <Icon name="mail" size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                                        <input
                                            type="email"
                                            required
                                            value={newEmail}
                                            onChange={e => setNewEmail(e.target.value)}
                                            className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 pl-10 outline-none focus:border-blue-500 transition-all text-sm"
                                            placeholder="ejemplo@correo.com"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-tight">Contraseña Temporal</label>
                                    <div className="relative">
                                        <Icon name="lock" size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                                        <input
                                            type="password"
                                            required
                                            minLength="6"
                                            value={newPass}
                                            onChange={e => setNewPass(e.target.value)}
                                            className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 pl-10 outline-none focus:border-blue-500 transition-all text-sm"
                                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-tight">Rol Asignado</label>
                                    <select
                                        value={newRole}
                                        onChange={e => setNewRole(e.target.value)}
                                        className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 outline-none focus:border-blue-500 transition-all text-sm appearance-none cursor-pointer"
                                    >
                                        <option value="admin">Administrador (Total)</option>
                                        <option value="editor">Editor (Ventas / Taller)</option>
                                        <option value="viewer">Observador (Sólo Lectura)</option>
                                    </select>
                                </div>

                                <div className="p-4 bg-blue-500/5 rounded-xl border border-blue-500/20">
                                    <p className="text-[10px] text-slate-400 italic">
                                        <Icon name="info" size={12} className="inline mr-1 text-blue-400" />
                                        Si el usuario ya existe en Supabase Auth, se agregará el perfil a tu empresa con el rol seleccionado.
                                    </p>
                                </div>

                                <button
                                    disabled={isInviting}
                                    className="w-full bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2"
                                >
                                    {isInviting ? <div className="animate-spin h-4 w-4 border-2 border-white/30 border-t-white rounded-full"></div> : <Icon name="send" size={18} />}
                                    Crear Usuario
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Tenant Settings ---
        const TenantSettings = ({ tenantId, tenantData, setTenantData }) => {
            const [formData, setFormData] = useState({ name: '', contact_email: '', contact_phone: '', logo_url: '' });
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                if (tenantData) setFormData({
                    name: tenantData.name || '',
                    contact_email: tenantData.contact_email || '',
                    contact_phone: tenantData.contact_phone || '',
                    logo_url: tenantData.logo_url || ''
                });
            }, [tenantData]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                try {
                    const { data, error } = await window.supabaseClient
                        .from('tenants')
                        .update({ ...formData })
                        .eq('id', tenantId)
                        .select()
                        .single();

                    if (error) throw error;
                    setTenantData(data);
                    window.addToast('Configuración actualizada', 'success');
                } catch (err) {
                    console.error(err);
                    window.addToast('Error al actualizar: ' + err.message, 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="p-4 md:p-8 max-w-2xl mx-auto pb-20">
                    <h2 className="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-400 mb-2">Mi Empresa</h2>
                    <p className="text-slate-400 text-sm mb-8">Personaliza la información de tu carpintería.</p>

                    <form onSubmit={handleSubmit} className="glass p-6 rounded-2xl shadow-xl border border-slate-700/50 space-y-6">
                        <div>
                            <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-tight">Nombre de la Empresa</label>
                            <input type="text" value={formData.name} onChange={e => setFormData({ ...formData, name: e.target.value })} required className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 outline-none focus:border-blue-500 transition-all text-sm text-slate-200" />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-tight">Email de Contacto</label>
                                <input type="email" value={formData.contact_email} onChange={e => setFormData({ ...formData, contact_email: e.target.value })} className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 outline-none focus:border-blue-500 transition-all text-sm text-slate-200" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-tight">Teléfono de Contacto</label>
                                <input type="text" value={formData.contact_phone} onChange={e => setFormData({ ...formData, contact_phone: e.target.value })} className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 outline-none focus:border-blue-500 transition-all text-sm text-slate-200" />
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-tight">URL del Logo (Opcional)</label>
                            <input type="url" value={formData.logo_url} onChange={e => setFormData({ ...formData, logo_url: e.target.value })} placeholder="https://ejemplo.com/logo.png" className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 outline-none focus:border-blue-500 transition-all text-sm text-slate-200 mb-2" />
                            {formData.logo_url && <img src={formData.logo_url} alt="Logo preview" className="h-16 mt-2 rounded bg-white/10 p-1 object-contain" />}
                        </div>
                        <button type="submit" disabled={isSaving} className="w-full bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2">
                            {isSaving ? <div className="animate-spin h-5 w-5 border-2 border-white/30 border-t-white rounded-full"></div> : <Icon name="save" size={18} />} Guardar Cambios
                        </button>
                    </form>
                </div>
            );
        };

        window.addToast = (message, type = 'info') => {
            window.dispatchEvent(new CustomEvent('show-toast', { detail: { message, type } }));
        };

        const ToastContainer = () => {
            const [toasts, setToasts] = useState([]);

            useEffect(() => {
                const handleShowToast = (e) => {
                    const { message, type } = e.detail;
                    const id = Date.now() + Math.random().toString(36).substr(2, 9);
                    setToasts(prev => [...prev, { id, message, type }]);
                    setTimeout(() => {
                        setToasts(prev => prev.filter(t => t.id !== id));
                    }, 4000);
                };

                window.addEventListener('show-toast', handleShowToast);
                return () => window.removeEventListener('show-toast', handleShowToast);
            }, []);

            if (toasts.length === 0) return null;

            const getIcon = (type) => {
                switch (type) {
                    case 'success': return 'check-circle';
                    case 'error': return 'alert-circle';
                    case 'warning': return 'alert-triangle';
                    default: return 'info';
                }
            };

            const getColor = (type) => {
                switch (type) {
                    case 'success': return 'bg-emerald-500/90 text-white border-emerald-400';
                    case 'error': return 'bg-red-500/90 text-white border-red-400';
                    case 'warning': return 'bg-orange-500/90 text-white border-orange-400';
                    default: return 'bg-blue-500/90 text-white border-blue-400';
                }
            };

            return (
                <div className="fixed bottom-6 right-6 z-[9999] flex flex-col gap-3 max-w-sm pointer-events-none">
                    {toasts.map(toast => (
                        <div key={toast.id} className={`p-4 rounded-xl border flex items-center gap-3 shadow-xl backdrop-blur-md transition-all animate-fade-in pointer-events-auto ${getColor(toast.type)}`}>
                            <Icon name={getIcon(toast.type)} size={24} className="shrink-0" />
                            <p className="font-bold text-[15px]">{toast.message}</p>
                        </div>
                    ))}
                </div>
            );
        };

        // --- Custom Confirm Dialog ---
        window.confirmAsync = (message) => {
            return new Promise((resolve) => {
                window.dispatchEvent(new CustomEvent('show-confirm', { detail: { message, resolve } }));
            });
        };

        const ConfirmDialog = () => {
            const [isOpen, setIsOpen] = useState(false);
            const [message, setMessage] = useState('');
            const [resolvePromise, setResolvePromise] = useState(null);

            useEffect(() => {
                const handleShow = (e) => {
                    setMessage(e.detail.message);
                    setResolvePromise(() => e.detail.resolve);
                    setIsOpen(true);
                };
                window.addEventListener('show-confirm', handleShow);
                return () => window.removeEventListener('show-confirm', handleShow);
            }, []);

            const handleConfirm = (value) => {
                setIsOpen(false);
                if (resolvePromise) resolvePromise(value);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[9980] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in pointer-events-auto">
                    <div className="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-2xl shadow-2xl p-6 text-center shadow-black overflow-hidden relative">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-500 to-orange-500"></div>
                        <div className="w-16 h-16 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                            <Icon name="alert-triangle" size={32} />
                        </div>
                        <h3 className="text-xl font-bold text-white mb-2">Confirmar Acción</h3>
                        <p className="text-slate-400 mb-8">{message}</p>
                        <div className="flex gap-3">
                            <button onClick={() => handleConfirm(false)} className="flex-1 px-4 py-3 rounded-xl font-bold bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-colors">Cancelar</button>
                            <button onClick={() => handleConfirm(true)} className="flex-1 px-4 py-3 rounded-xl font-bold bg-red-600 text-white hover:bg-red-500 shadow-lg shadow-red-500/20 transition-all">Aceptar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [session, setSession] = useState(null);
            const [tenantId, setTenantId] = useState(null);
            const [tenantData, setTenantData] = useState(null);
            const [userRole, setUserRole] = useState('viewer');
            const [isCheckingSession, setIsCheckingSession] = useState(true);

            const [tab, setTab] = useState('dashboard');
            // Default open on desktop, closed on mobile
            const [sidebarOpen, setSidebarOpen] = useState(window.innerWidth > 1024);
            const [clients, setClients] = useState(() => {
                try {
                    const saved = localStorage.getItem('fabrizio_clients');
                    return saved ? JSON.parse(saved) : [];
                } catch { return []; }
            });
            const [suppliers, setSuppliers] = useState(() => {
                try {
                    const saved = localStorage.getItem('fabrizio_suppliers');
                    return saved ? JSON.parse(saved) : [];
                } catch { return []; }
            });

            useEffect(() => {
                localStorage.setItem('fabrizio_clients', JSON.stringify(clients));
            }, [clients]);

            useEffect(() => {
                localStorage.setItem('fabrizio_suppliers', JSON.stringify(suppliers));
            }, [suppliers]);

            // Subscripción a estado de autenticación de Supabase
            useEffect(() => {
                if (!window.supabaseClient) {
                    setIsCheckingSession(false);
                    return;
                }

                // Estado al cargar por primera vez
                window.supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (!session) setIsCheckingSession(false);
                    else fetchTenantId(session.user.id);
                });

                // Escuchar cambios (login, logout, token refresh)
                const { data: { subscription } } = window.supabaseClient.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if (session) fetchTenantId(session.user.id);
                });

                return () => subscription?.unsubscribe();
            }, []);

            const fetchTenantId = async (uid) => {
                try {
                    const { data, error } = await window.supabaseClient.from('usuarios').select('tenant_id, role').eq('id', uid).single();
                    if (data) {
                        setTenantId(data.tenant_id);
                        setUserRole(data.role || 'viewer');

                        // Cargar datos del tenant
                        const { data: tData } = await window.supabaseClient.from('tenants').select('*').eq('id', data.tenant_id).single();
                        if (tData) setTenantData(tData);

                        setIsCheckingSession(false);
                    } else {
                        // Reintento breve para asegurar que el trigger terminó
                        setTimeout(async () => {
                            const { data: retryData } = await window.supabaseClient.from('usuarios').select('tenant_id, role').eq('id', uid).single();
                            if (retryData) {
                                setTenantId(retryData.tenant_id);
                                setUserRole(retryData.role || 'viewer');
                                const { data: retryTData } = await window.supabaseClient.from('tenants').select('*').eq('id', retryData.tenant_id).single();
                                if (retryTData) setTenantData(retryTData);
                            }
                            setIsCheckingSession(false);
                        }, 1500);
                    }
                } catch (e) {
                    console.error(e);
                    setIsCheckingSession(false);
                }
            };

            const handleLogout = async () => {
                if (await window.confirmAsync('¿Seguro que deseas cerrar sesión?')) {
                    await window.supabaseClient.auth.signOut();
                }
            };

            if (isCheckingSession) {
                return <div className="min-h-screen flex items-center justify-center bg-slate-900 text-slate-400">Verificando sesión...</div>;
            }

            if (!session) {
                return <Login />;
            }

            if (tenantId === null) {
                return <div className="min-h-screen flex items-center justify-center bg-slate-900 text-slate-400">Generando Tenant ID de empresa...</div>;
            }

            return (
                <div className="flex bg-slate-900 min-h-screen relative overflow-x-hidden">
                    <Sidebar currentTab={tab} setTab={setTab} isOpen={sidebarOpen} setIsOpen={setSidebarOpen} onLogout={handleLogout} userRole={userRole} />

                    <main className={`flex-grow transition-all duration-300 min-h-screen ml-0 lg:ml-64`}>
                        {/* Persistent Header with Toggle */}
                        <div className="flex items-center justify-between p-4 glass sticky top-0 z-40">
                            <div className="flex items-center gap-3">
                                <button
                                    onClick={() => setSidebarOpen(!sidebarOpen)}
                                    className="p-2 glass rounded-lg text-white hover:bg-blue-600/20 transition-colors lg:hidden"
                                    title={sidebarOpen ? "Cerrar menú" : "Abrir menú"}
                                >
                                    <Icon name={sidebarOpen ? "chevron-left" : "menu"} size={24} />
                                </button>
                                <div className="flex items-center gap-2">
                                    {tenantData?.logo_url ? (
                                        <img src={tenantData.logo_url} alt="Logo" className="max-h-8 max-w-[120px] object-contain rounded" style={{ height: '32px' }} />
                                    ) : (
                                        <div className="bg-blue-600 p-1.5 rounded-lg">
                                            <Icon name="hammer" size={20} />
                                        </div>
                                    )}
                                    <span className="font-bold tracking-tight text-white hidden sm:inline">{tenantData?.name || 'Fabrizio Admin'}</span>
                                </div>
                            </div>

                            <div className="flex items-center gap-2 text-sm text-slate-400">
                                <Icon name="clock" size={14} />
                                {new Date().toLocaleDateString()}
                            </div>
                        </div>

                        {tab === 'dashboard' && <Dashboard tenantId={tenantId} setTab={setTab} />}
                        {tab === 'clients' && <ClientManager clients={clients} setClients={setClients} tenantId={tenantId} />}
                        {(tab === 'quoter' && ['admin', 'editor'].includes(userRole)) && <Quoter clients={clients} setClients={setClients} tenantId={tenantId} />}
                        {(tab === 'prices' && ['admin', 'editor'].includes(userRole)) && <PriceList tenantId={tenantId} />}
                        {tab === 'suppliers' && <SupplierManager suppliers={suppliers} setSuppliers={setSuppliers} tenantId={tenantId} />}
                        {(tab === 'costs' && ['admin', 'editor'].includes(userRole)) && <OperativeCosts tenantId={tenantId} />}
                        {(tab === 'statistics' && userRole === 'admin') && <Statistics tenantId={tenantId} />}
                        {(tab === 'users' && userRole === 'admin') && <UserManagement tenantId={tenantId} />}
                        {(tab === 'settings' && userRole === 'admin') && <TenantSettings tenantId={tenantId} tenantData={tenantData} setTenantData={setTenantData} />}

                        {/* Fallback for unauthorized access */}
                        {['quoter', 'prices', 'costs', 'statistics', 'users', 'settings'].includes(tab) &&
                            !((['quoter', 'prices', 'costs'].includes(tab) && ['admin', 'editor'].includes(userRole)) ||
                                (['statistics', 'users', 'settings'].includes(tab) && userRole === 'admin')) && (
                                <div className="flex flex-col items-center justify-center h-[calc(100vh-80px)] text-slate-400 gap-4">
                                    <Icon name="lock" size={48} className="text-slate-600" />
                                    <h2 className="text-xl font-bold">Acceso Restringido</h2>
                                    <p>No tienes permisos suficientes para ver esta sección.</p>
                                    <button onClick={() => setTab('dashboard')} className="mt-4 px-6 py-2 bg-blue-600 rounded-xl text-white font-bold">Volver al Inicio</button>
                                </div>
                            )}

                    </main>
                    <ToastContainer />
                    <ConfirmDialog />
                </div>
            );
        };
        // --- Error Boundary Fallback ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                this.setState({ error: error, errorInfo: errorInfo });
                console.error("React Crash capturado:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="bg-slate-900 text-white min-h-screen p-8">
                            <h2 className="text-red-500 text-3xl font-bold mb-4">La aplicación ha crasheado 🚀</h2>
                            <p className="text-slate-300 mb-4">Por favor envía una captura de esta pantalla al soporte técnico:</p>
                            <div className="bg-slate-800 p-4 rounded text-sm font-mono overflow-auto mb-4 border border-red-500/50">
                                <span className="text-red-400 font-bold block">{this.state.error && this.state.error.toString()}</span>
                                <pre className="text-slate-400 mt-2">{this.state.errorInfo && this.state.errorInfo.componentStack}</pre>
                            </div>
                            <button onClick={() => window.location.reload()} className="bg-blue-600 px-4 py-2 rounded font-bold">
                                Recargar Página
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>

</html>