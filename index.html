<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Fabrizio Amoblamientos v1.1</title>
    <!-- React & Babel for standalone use -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Prop-Types (Required for Recharts UMD) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.js"></script>
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Supabase CDN y Configuración -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Datos copiados de tú proyecto en Supabase
        const supabaseUrl = 'https://yjtljilaxvdescadkzqk.supabase.co';
        const supabaseKey = 'sb_publishable_Ik5EOjfzdK1wVYanYITuuw_bObZw1ak';

        // Inicializamos Supabase y lo guardamos en global para usarlo en React
        window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        console.log("Supabase conectado y listo para usarse");
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-item:hover {
            background: rgba(59, 130, 246, 0.2);
            border-left: 4px solid #3b82f6;
        }

        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.3);
            border-left: 4px solid #3b82f6;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons Helper ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const spanRef = React.useRef(null);

            useEffect(() => {
                if (spanRef.current) {
                    // Al usar innerHTML, ocultamos el <i> del control del árbol de React.
                    // Lucide transformará este <i> en un <svg> pero React sólo se preocupará de desmontar el <span> padre
                    // Esto arregla el crasheo críptico (NotFoundError: Failed to execute 'removeChild')
                    spanRef.current.innerHTML = `<i data-lucide="${name}" class="${className}" style="width: ${size}px; height: ${size}px;"></i>`;
                    lucide.createIcons();
                }
            }, [name, size, className]);

            return <span ref={spanRef} style={{ display: 'contents' }}></span>;
        };

        // --- Layout Components ---
        const Sidebar = ({ currentTab, setTab, isOpen, setIsOpen, onLogout }) => (
            <>
                {/* Backdrop for mobile */}
                {isOpen && (
                    <div
                        className="fixed inset-0 bg-black/50 z-40 lg:hidden transition-opacity"
                        onClick={() => setIsOpen(false)}
                    ></div>
                )}

                <div className={`w-64 h-screen glass fixed left-0 top-0 flex flex-col p-4 z-50 transition-all duration-300 transform 
                    ${isOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`}>

                    <div className="flex justify-between items-center mb-10 px-2">
                        <div className="flex items-center gap-3">
                            <div className="bg-slate-100 p-1.5 rounded-lg flex items-center justify-center" style={{ width: '40px', height: '40px' }}>
                                <img src="data:image/png;base64,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" alt="Logo" className="w-full h-full object-contain" />
                            </div>
                            <h1 className="font-bold text-xl tracking-tight">Fabrizio<span className="text-blue-500 text-sm block font-normal">Admin</span></h1>
                        </div>
                        <button onClick={() => setIsOpen(false)} className="lg:hidden p-1 text-slate-400">
                            <Icon name="x" size={24} />
                        </button>
                    </div>

                    <nav className="space-y-2 flex-grow">
                        <button onClick={() => { setTab('clients'); setIsOpen(false); }} className={`sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all ${currentTab === 'clients' ? 'active' : ''}`}>
                            <Icon name="users" /> Clientes
                        </button>
                        <button onClick={() => { setTab('quoter'); setIsOpen(false); }} className={`sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all ${currentTab === 'quoter' ? 'active' : ''}`}>
                            <Icon name="file-text" /> Cotizador
                        </button>
                        <button onClick={() => { setTab('prices'); setIsOpen(false); }} className={`sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all ${currentTab === 'prices' ? 'active' : ''}`}>
                            <Icon name="list" /> Lista de Precios
                        </button>
                        <button onClick={() => { setTab('suppliers'); setIsOpen(false); }} className={`sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all ${currentTab === 'suppliers' ? 'active' : ''}`}>
                            <Icon name="truck" /> Proveedores
                        </button>
                        <button onClick={() => { setTab('costs'); setIsOpen(false); }} className={`sidebar-item w-full flex items-center gap-3 p-3 bg-orange-600/20 text-orange-400 hover:bg-orange-600/30 rounded-lg transition-all ${currentTab === 'costs' ? 'active' : ''}`}>
                            <Icon name="receipt" /> Costos Operativos
                        </button>
                        <button onClick={() => { setTab('statistics'); setIsOpen(false); }} className={`sidebar-item w-full flex items-center gap-3 p-3 bg-orange-600/20 text-orange-400 hover:bg-orange-600/30 rounded-lg transition-all ${currentTab === 'statistics' ? 'active' : ''}`}>
                            <Icon name="pie-chart" /> Estadísticas
                        </button>
                    </nav>

                    <div className="mt-auto border-t border-slate-700 pt-4">
                        <button onClick={onLogout} className="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg text-red-400 hover:bg-red-500/10 transition-colors">
                            <Icon name="log-out" /> Salir
                        </button>
                    </div>
                </div>
            </>
        );

        // --- Modules ---


        const ClientManager = ({ clients, setClients, tenantId }) => {
            const [newClient, setNewClient] = useState({ name: '', phone: '', address: '', city: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('recent');
            const [expandedClients, setExpandedClients] = useState({});
            const [isLoading, setIsLoading] = useState(false);
            const [editingClient, setEditingClient] = useState(null);
            const [editingBudget, setEditingBudget] = useState(null);
            const [paymentModal, setPaymentModal] = useState(null);

            // Cargar clientes desde Supabase al montar el componente
            useEffect(() => {
                fetchClients();
            }, []);

            const fetchClients = async () => {
                setIsLoading(true);
                try {
                    const { data, error } = await window.supabaseClient
                        .from('clientes')
                        .select('*, budgets:presupuestos(*)')
                        .order('id', { ascending: false });

                    if (error) throw error;
                    // Los presupuestos ya vienen dentro de la propiedad "budgets" gracias al alias
                    setClients(data || []);
                } catch (error) {
                    console.error('Error al cargar clientes:', error);
                    alert("Error al cargar datos desde Supabase: " + error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const addClient = async () => {
                if (!newClient.name) return;
                setIsLoading(true);

                try {
                    const { data, error } = await window.supabaseClient
                        .from('clientes')
                        .insert([
                            {
                                tenant_id: tenantId,
                                name: newClient.name,
                                phone: newClient.phone,
                                address: newClient.address,
                                city: newClient.city
                            }
                        ])
                        .select(); // Devuelve el registro insertado

                    if (error) throw error;

                    if (data && data.length > 0) {
                        setClients([...clients, data[0]]);
                        setNewClient({ name: '', phone: '', address: '', city: '' });
                    }
                } catch (error) {
                    console.error('Error al agregar cliente:', error);
                    alert("Error al guardar en Supabase: " + error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const deleteClient = async (id) => {
                if (!confirm('¿Seguro que deseas eliminar este cliente permanentemente?')) return;

                try {
                    const { error } = await window.supabaseClient
                        .from('clientes')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    setClients(clients.filter(c => c.id !== id));
                } catch (error) {
                    console.error('Error al eliminar cliente:', error);
                    alert("Error al eliminar en Supabase: " + error.message);
                }
            };

            const handleAddPayment = async (e) => {
                e.preventDefault();
                if (!paymentModal.amount || isNaN(paymentModal.amount)) return;
                setIsLoading(true);
                const { client, budget, amount, method } = paymentModal;
                const numAmount = parseFloat(amount);
                const newPaid = (budget.paid || 0) + numAmount;
                const newHistoryItem = {
                    date: new Date().toISOString(),
                    amount: numAmount,
                    method: method
                };
                const newPaymentHistory = [...(budget.payment_history || []), newHistoryItem];

                try {
                    await window.supabaseClient.from('transacciones_clientes').insert([{
                        tenant_id: tenantId,
                        client_id: client.id,
                        tipo: 'COBRO',
                        monto: numAmount,
                        descripcion: `Pago sobre Presupuesto: ${budget.summary} (${method})`
                    }]);

                    const { error } = await window.supabaseClient
                        .from('presupuestos')
                        .update({ paid: newPaid, payment_history: newPaymentHistory })
                        .eq('id', budget.id);

                    if (error) throw error;

                    const updated = clients.map(c => {
                        if (c.id === client.id) {
                            return {
                                ...c,
                                budgets: c.budgets.map(b =>
                                    b.id === budget.id ? { ...b, paid: newPaid, payment_history: newPaymentHistory } : b
                                )
                            };
                        }
                        return c;
                    });
                    setClients(updated);
                    setPaymentModal(null);
                } catch (error) {
                    console.error('Error adding payment:', error);
                    alert("Error al procesar pago: " + error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const updateClient = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                try {
                    const { error } = await window.supabaseClient
                        .from('clientes')
                        .update({
                            name: editingClient.name,
                            phone: editingClient.phone,
                            address: editingClient.address,
                            city: editingClient.city
                        })
                        .eq('id', editingClient.id);

                    if (error) throw error;

                    setClients(clients.map(c => c.id === editingClient.id ? editingClient : c));
                    setEditingClient(null);
                } catch (error) {
                    console.error("Error updating client", error);
                    alert("Error al actualizar cliente.");
                } finally {
                    setIsLoading(false);
                }
            };

            const updateBudget = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                try {
                    const { error } = await window.supabaseClient
                        .from('presupuestos')
                        .update({
                            date: editingBudget.date,
                            summary: editingBudget.summary,
                            total: parseFloat(editingBudget.total) || 0
                        })
                        .eq('id', editingBudget.id);

                    if (error) throw error;

                    const updatedClients = clients.map(c => {
                        if (c.id === editingBudget.client_id) {
                            return {
                                ...c,
                                budgets: c.budgets.map(b => b.id === editingBudget.id ? {
                                    ...b,
                                    date: editingBudget.date,
                                    summary: editingBudget.summary,
                                    total: parseFloat(editingBudget.total) || 0
                                } : b)
                            };
                        }
                        return c;
                    });
                    setClients(updatedClients);
                    setEditingBudget(null);
                } catch (error) {
                    console.error("Error updating budget", error);
                    alert("Error al actualizar presupuesto.");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="p-4 md:p-8">
                    <div className="flex flex-col md:flex-row md:items-center justify-between mb-6 md:mb-8 gap-4">
                        <h2 className="text-2xl md:text-3xl font-bold">Mis Clientes</h2>
                        <div className="relative w-full md:w-auto flex gap-2">
                            <div className="relative flex-1 md:w-72">
                                <Icon name="search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                <input
                                    type="text"
                                    placeholder="Buscar clientes..."
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                    className="w-full bg-slate-800/50 border border-slate-700/50 rounded-lg pl-10 pr-4 py-2.5 focus:ring-2 ring-blue-500 outline-none text-sm text-slate-200 transition-all placeholder-slate-500 focus:bg-slate-800"
                                />
                            </div>
                            <select
                                value={sortBy}
                                onChange={e => setSortBy(e.target.value)}
                                className="bg-slate-800/50 border border-slate-700/50 rounded-lg px-3 py-2.5 outline-none text-sm text-slate-200 focus:ring-2 ring-blue-500 cursor-pointer"
                            >
                                <option value="recent">Recientes</option>
                                <option value="debt">Con Deuda</option>
                            </select>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-1 glass p-6 rounded-2xl h-fit">
                            <h3 className="text-xl font-semibold mb-6">Nuevo Cliente</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Nombre Completo</label>
                                    <input value={newClient.name} onChange={e => setNewClient({ ...newClient, name: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="Juan Perez" />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">WhatsApp</label>
                                    <input value={newClient.phone} onChange={e => setNewClient({ ...newClient, phone: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="+54 9..." />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Dirección / Obra</label>
                                    <input value={newClient.address} onChange={e => setNewClient({ ...newClient, address: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="Calle Falsa 123" />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Localidad</label>
                                    <input
                                        value={newClient.city}
                                        onChange={e => setNewClient({ ...newClient, city: e.target.value })}
                                        className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none"
                                        placeholder="Ej: Junín"
                                    />
                                </div>
                                <button onClick={addClient} disabled={isLoading} className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 p-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2">
                                    <Icon name="user-plus" /> {isLoading ? 'Guardando...' : 'Guardar Cliente'}
                                </button>
                            </div>
                        </div>

                        <div className="lg:col-span-2 space-y-4">
                            {(() => {
                                let filteredClients = clients.filter(c => {
                                    const search = searchTerm.toLowerCase();
                                    return (c.name || '').toLowerCase().includes(search) ||
                                        (c.phone || '').toLowerCase().includes(search) ||
                                        (c.address || '').toLowerCase().includes(search) ||
                                        (c.city || '').toLowerCase().includes(search);
                                });

                                if (sortBy === 'debt') {
                                    filteredClients.sort((a, b) => {
                                        const debtA = (a.budgets || []).reduce((acc, bud) => acc + (bud.total - (bud.paid || 0)), 0);
                                        const debtB = (b.budgets || []).reduce((acc, bud) => acc + (bud.total - (bud.paid || 0)), 0);
                                        return debtB - debtA;
                                    });
                                } else {
                                    filteredClients.sort((a, b) => b.id - a.id);
                                }

                                if (clients.length === 0) {
                                    return <div className="glass p-10 rounded-2xl text-center text-slate-500">No hay clientes registrados</div>;
                                }

                                if (filteredClients.length === 0) {
                                    return <div className="glass p-10 rounded-2xl text-center text-slate-500">Ningún cliente coincide con la búsqueda '{searchTerm}'</div>;
                                }

                                return filteredClients.map(c => {
                                    const totalDebt = (c.budgets || []).reduce((acc, b) => acc + (b.total - (b.paid || 0)), 0);

                                    return (
                                        <div key={c.id} className="glass p-6 rounded-2xl group hover:border-blue-500/50 transition-all space-y-4">
                                            <div className="flex flex-col sm:flex-row sm:items-start justify-between gap-4">
                                                <div className="flex gap-4 items-start">
                                                    <div className="w-12 h-12 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400 font-bold text-xl uppercase shrink-0">
                                                        {c.name ? c.name[0] : '?'}
                                                    </div>
                                                    <div>
                                                        <h4 className="font-semibold text-lg">{c.name || 'Sin nombre'}</h4>
                                                        <div className="flex flex-col sm:flex-row sm:gap-4 text-xs sm:text-sm text-slate-400 mb-2 mt-1">
                                                            <span className="flex items-center gap-1"><Icon name="phone" size={14} /> {c.phone || '-'}</span>
                                                            <span className="flex items-center gap-1"><Icon name="map-pin" size={14} /> {c.address || '-'}</span>
                                                        </div>
                                                        <div className="flex flex-wrap gap-2">
                                                            {c.city && <span className="bg-blue-500/20 text-blue-400 border border-blue-500/30 px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider">{c.city}</span>}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex flex-col items-end gap-3 h-full justify-between">
                                                    {totalDebt > 0 && (
                                                        <div className="bg-orange-500/10 text-orange-400 border border-orange-500/20 px-3 py-1.5 rounded-lg text-xs font-bold font-mono tracking-wider shadow-sm flex items-center gap-2">
                                                            <Icon name="alert-circle" size={14} /> DEUDA: ${totalDebt.toLocaleString()}
                                                        </div>
                                                    )}
                                                    <div className="flex gap-2">
                                                        <button onClick={() => setEditingClient(c)} className="p-2 glass rounded-lg hover:bg-slate-500/20 text-slate-400" title="Editar Cliente"><Icon name="edit-2" /></button>
                                                        <a href={c.phone ? `https://wa.me/${c.phone.replace(/\D/g, '')}` : '#'} target={c.phone ? "_blank" : "_self"} className="p-2 glass rounded-lg hover:bg-green-500/20 text-green-400" title="WhatsApp"><Icon name="message-circle" /></a>
                                                        <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${c.address || ''} ${c.city || ''}`)}`} target="_blank" className="p-2 glass rounded-lg hover:bg-blue-500/20 text-blue-400" title="Google Maps"><Icon name="map" /></a>
                                                        <button onClick={() => deleteClient(c.id)} className="p-2 glass rounded-lg hover:bg-red-500/20 text-red-400" title="Eliminar Cliente"><Icon name="trash-2" /></button>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Budgets History */}
                                            <div className="border-t border-slate-700/50 pt-3">
                                                <div className="flex justify-between items-center mb-3">
                                                    <h5 className="text-[10px] uppercase text-slate-500 font-bold flex items-center gap-2 tracking-wider">
                                                        <Icon name="history" size={12} /> Presupuestos Registrados
                                                    </h5>
                                                </div>
                                                <div className="space-y-3">
                                                    {(!c.budgets || c.budgets.length === 0) ? (
                                                        <p className="text-xs text-slate-600 italic">No hay cotizaciones registradas para este cliente.</p>
                                                    ) : (
                                                        c.budgets.slice().reverse().map((b, idx) => {
                                                            const paid = b.paid || 0;
                                                            const balance = b.total - paid;
                                                            const isFullyPaid = balance <= 0;

                                                            const openPaymentModal = () => {
                                                                setPaymentModal({ client: c, budget: b, amount: "", method: "Efectivo" });
                                                            };

                                                            const updateBudgetStatus = async (newStatus) => {
                                                                try {
                                                                    const { error } = await window.supabaseClient
                                                                        .from('presupuestos')
                                                                        .update({ status: newStatus })
                                                                        .eq('id', b.id);
                                                                    if (error) throw error;
                                                                    const updated = clients.map(client => client.id === c.id ? {
                                                                        ...client,
                                                                        budgets: client.budgets.map(bud => bud.id === b.id ? { ...bud, status: newStatus } : bud)
                                                                    } : client);
                                                                    setClients(updated);
                                                                } catch (error) {
                                                                    console.error("Error updating status", error);
                                                                    alert("Error al actualizar estado: " + error.message);
                                                                }
                                                            };

                                                            const handleFileUpload = async (event, type) => {
                                                                const file = event.target.files[0];
                                                                if (!file) return;

                                                                const fileExt = file.name.split('.').pop();
                                                                const fileName = `${tenantId}/${c.id}/${b.id}/${type}_${Date.now()}.${fileExt}`;

                                                                let note = '';
                                                                if (type === 'plans') {
                                                                    note = prompt("¿Quién tomó las medidas? (Opcional, Ej: Carlos, Lucas, Cliente):", "");
                                                                    if (note === null) return; // Canceló
                                                                } else if (type === 'receipts') {
                                                                    note = prompt("Anotación para el comprobante (Opcional, Ej: Seña 50% Transferencia):", "");
                                                                    if (note === null) return; // Canceló
                                                                }

                                                                try {
                                                                    alert("Subiendo archivo a la nube, por favor espere...");
                                                                    const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                                                                        .from('archivos_crm')
                                                                        .upload(fileName, file);

                                                                    if (uploadError) throw uploadError;

                                                                    const { data: urlData } = window.supabaseClient.storage.from('archivos_crm').getPublicUrl(fileName);
                                                                    const fileUrl = urlData.publicUrl;

                                                                    const newFileObj = {
                                                                        url: fileUrl,
                                                                        name: file.name,
                                                                        note: note || '',
                                                                        date: new Date().toISOString()
                                                                    };

                                                                    const currentFiles = b[type] || [];
                                                                    const updatedFiles = [...currentFiles, newFileObj];

                                                                    const { error: dbError } = await window.supabaseClient
                                                                        .from('presupuestos')
                                                                        .update({ [type]: updatedFiles })
                                                                        .eq('id', b.id);

                                                                    if (dbError) throw dbError;

                                                                    const updated = clients.map(client => client.id === c.id ? {
                                                                        ...client,
                                                                        budgets: client.budgets.map(bud => bud.id === b.id ? { ...bud, [type]: updatedFiles } : bud)
                                                                    } : client);
                                                                    setClients(updated);
                                                                    alert("¡Archivo subido exitosamente!");
                                                                } catch (error) {
                                                                    console.error("Error uploading file", error);
                                                                    alert("Error al subir archivo: " + error.message);
                                                                }
                                                            };

                                                            return (
                                                                <div key={b.id || idx} className={`bg-slate-900/40 p-4 rounded-xl border transition-all ${isFullyPaid ? 'border-emerald-500/30' : 'border-transparent hover:border-slate-700'}`}>
                                                                    <div className="flex justify-between items-start mb-3">
                                                                        <div className="flex-grow">
                                                                            <span className="text-slate-400 text-[10px] block mb-1 font-mono uppercase">
                                                                                {b.date ? new Date(b.date).toLocaleDateString('es-AR', { timeZone: 'UTC' }) : ''}
                                                                            </span>
                                                                            <span className="text-slate-200 block text-sm leading-tight font-medium">{b.summary}</span>
                                                                        </div>
                                                                        <div className="flex gap-1.5 flex-wrap justify-end">
                                                                            <button onClick={() => setEditingBudget({ ...b, client_id: c.id })} className="flex items-center gap-1.5 bg-slate-600/20 text-slate-400 hover:bg-slate-600/40 px-2 py-1 rounded-md text-[10px] font-bold uppercase transition-colors shrink-0 mt-1" title="Editar Presupuesto">
                                                                                <Icon name="edit-2" size={12} /> Editar
                                                                            </button>
                                                                            <button onClick={openPaymentModal} className="flex items-center gap-1.5 bg-blue-600/20 text-blue-400 hover:bg-blue-600/40 px-2 py-1 rounded-md text-[10px] font-bold uppercase transition-colors shrink-0 mt-1">
                                                                                <Icon name="plus" size={12} /> Pago
                                                                            </button>
                                                                        </div>
                                                                    </div>

                                                                    {/* Actions: Status + Attachments */}
                                                                    <div className="flex items-center gap-2 mb-3 overflow-x-auto pb-1 custom-scrollbar">
                                                                        <button onClick={() => updateBudgetStatus('aprobado')} title="Marcar como Aprobado" className={`shrink-0 flex justify-center items-center gap-1 text-[10px] font-bold uppercase px-3 py-1.5 rounded-md border transition-colors ${b.status === 'aprobado' ? 'bg-emerald-500/20 border-emerald-500/50 text-emerald-400' : 'bg-slate-800/50 border-slate-700/50 text-slate-400 hover:bg-slate-700'}`}><Icon name="check-circle" size={12} /> Aprobado</button>
                                                                        <button onClick={() => updateBudgetStatus('rechazado')} title="Marcar como Rechazado" className={`shrink-0 flex justify-center items-center gap-1 text-[10px] font-bold uppercase px-3 py-1.5 rounded-md border transition-colors ${b.status === 'rechazado' ? 'bg-red-500/20 border-red-500/50 text-red-400' : 'bg-slate-800/50 border-slate-700/50 text-slate-400 hover:bg-slate-700'}`}><Icon name="x-circle" size={12} /> Rechazado</button>
                                                                        <button onClick={() => updateBudgetStatus('terminado')} title="Marcar como Terminado" className={`shrink-0 flex justify-center items-center gap-1 text-[10px] font-bold uppercase px-3 py-1.5 rounded-md border transition-colors ${b.status === 'terminado' ? 'bg-slate-600/50 border-slate-500/50 text-slate-300' : 'bg-slate-800/50 border-slate-700/50 text-slate-400 hover:bg-slate-700'}`}><Icon name="package" size={12} /> Terminado</button>

                                                                        <div className="shrink-0 relative">
                                                                            <input type="file" id={`upload-receipt-${b.id}`} className="hidden" accept="image/*,.pdf" onChange={(e) => handleFileUpload(e, 'receipts')} />
                                                                            <label htmlFor={`upload-receipt-${b.id}`} className="flex items-center justify-center gap-1.5 bg-orange-600/90 hover:bg-orange-500 text-white px-3 py-1.5 rounded-md text-[10px] font-bold uppercase transition-colors cursor-pointer whitespace-nowrap">
                                                                                Adjuntar Comprobante
                                                                            </label>
                                                                        </div>
                                                                        <div className="shrink-0 relative">
                                                                            <input type="file" id={`upload-plan-${b.id}`} className="hidden" accept="image/*,.pdf" onChange={(e) => handleFileUpload(e, 'plans')} />
                                                                            <label htmlFor={`upload-plan-${b.id}`} className="flex items-center justify-center gap-1.5 bg-orange-600/90 hover:bg-orange-500 text-white px-3 py-1.5 rounded-md text-[10px] font-bold uppercase transition-colors cursor-pointer whitespace-nowrap">
                                                                                Adj. Planos
                                                                            </label>
                                                                        </div>
                                                                    </div>

                                                                    <div className="grid grid-cols-3 gap-2 pt-2 border-t border-slate-800 mb-3">
                                                                        <div>
                                                                            <span className="text-[9px] text-slate-500 uppercase block">Total</span>
                                                                            <span className="text-sm font-mono text-slate-300">${b.total.toLocaleString()}</span>
                                                                        </div>
                                                                        <div>
                                                                            <span className="text-[9px] text-slate-500 uppercase block">Entregado</span>
                                                                            <span className="text-sm font-mono text-emerald-400">${paid.toLocaleString()}</span>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <span className="text-[9px] text-slate-500 uppercase block">Saldo</span>
                                                                            <span className={`text-sm font-mono font-bold ${isFullyPaid ? 'text-emerald-500' : 'text-orange-400'}`}>
                                                                                {isFullyPaid ? 'PAGADO' : `$${balance.toLocaleString()}`}
                                                                            </span>
                                                                        </div>
                                                                    </div>

                                                                    {/* Payment History Render */}
                                                                    {(b.payment_history && b.payment_history.length > 0) && (
                                                                        <div className="pt-2 border-t border-slate-800 mb-2">
                                                                            <span className="text-[9px] text-slate-500 uppercase block mb-1">Historial de Pagos</span>
                                                                            <ul className="space-y-1">
                                                                                {b.payment_history.map((ph, phIdx) => (
                                                                                    <li key={phIdx} className="flex justify-between items-center text-[10px] text-slate-400 bg-slate-800/20 px-2 py-1 rounded">
                                                                                        <span>{new Date(ph.date).toLocaleDateString('es-AR', { timeZone: 'UTC' })} - <span className="text-slate-300">{ph.method}</span></span>
                                                                                        <span className="font-mono text-emerald-400">+${ph.amount.toLocaleString()}</span>
                                                                                    </li>
                                                                                ))}
                                                                            </ul>
                                                                        </div>
                                                                    )}

                                                                    {/* File Uploads Lists */}
                                                                    {((b.receipts && b.receipts.length > 0) || (b.plans && b.plans.length > 0)) && (
                                                                        <div className="pt-3 border-t border-slate-800 flex flex-col gap-3">

                                                                            {(b.receipts && b.receipts.length > 0) && (
                                                                                <div className="space-y-1">
                                                                                    <span className="text-[9px] text-slate-500 uppercase font-bold tracking-wider">Comprobantes de Pago</span>
                                                                                    <div className="flex flex-col gap-1.5">
                                                                                        {b.receipts.map((r, i) => (
                                                                                            <a key={i} href={r.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-[10px] text-blue-400 hover:text-blue-300 bg-blue-500/10 hover:bg-blue-500/20 p-2 rounded-lg border border-blue-500/20 transition-colors">
                                                                                                <Icon name="file-text" size={12} className="shrink-0" />
                                                                                                <span className="truncate">{r.note ? `${r.note}` : `Comprobante ${i + 1}`}</span>
                                                                                            </a>
                                                                                        ))}
                                                                                    </div>
                                                                                </div>
                                                                            )}

                                                                            {(b.plans && b.plans.length > 0) && (
                                                                                <div className="space-y-1 mt-1">
                                                                                    <span className="text-[9px] text-slate-500 uppercase font-bold tracking-wider">Planos y Diseños</span>
                                                                                    <div className="flex flex-col gap-1.5">
                                                                                        {b.plans.map((p, i) => (
                                                                                            <a key={i} href={p.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-[10px] text-purple-400 hover:text-purple-300 bg-purple-500/10 hover:bg-purple-500/20 p-2 rounded-lg border border-purple-500/20 transition-colors">
                                                                                                <Icon name="image" size={12} className="shrink-0" />
                                                                                                <span className="truncate">{p.note ? `Medidas: ${p.note}` : `Plano ${i + 1}`}</span>
                                                                                            </a>
                                                                                        ))}
                                                                                    </div>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        })
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            })()}
                        </div>
                    </div >

                    {/* Payment Modal */}
                    {
                        paymentModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                                <div className="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-2xl shadow-2xl relative overflow-hidden flex flex-col">
                                    <div className="p-4 border-b border-slate-700/50 flex justify-between items-center bg-slate-800/50">
                                        <h3 className="font-bold text-lg text-white">Registrar Cobro</h3>
                                        <button type="button" onClick={() => setPaymentModal(null)} className="text-slate-400 hover:text-white transition-colors">
                                            <Icon name="x" size={20} />
                                        </button>
                                    </div>
                                    <form onSubmit={handleAddPayment} className="p-5 space-y-4">
                                        <p className="text-sm text-slate-300">
                                            Abono para: <strong className="text-white">{paymentModal.budget.summary}</strong>
                                        </p>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Monto a cobrar ($)</label>
                                            <input
                                                required
                                                type="number"
                                                min="0"
                                                step="0.01"
                                                value={paymentModal.amount}
                                                onChange={e => setPaymentModal({ ...paymentModal, amount: e.target.value })}
                                                className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none text-slate-200"
                                                placeholder="0.00"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Método de Pago</label>
                                            <select
                                                required
                                                value={paymentModal.method}
                                                onChange={e => setPaymentModal({ ...paymentModal, method: e.target.value })}
                                                className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none text-slate-200"
                                            >
                                                <option value="Efectivo">Efectivo</option>
                                                <option value="Transferencia">Transferencia</option>
                                                <option value="Cheque">Cheque</option>
                                            </select>
                                        </div>
                                        <div className="pt-2">
                                            <button type="submit" disabled={isLoading} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                                                {isLoading ? <span className="animate-spin border-2 border-white/20 border-t-white rounded-full w-5 h-5"></span> : <><Icon name="check" size={18} /> Confirmar Pago</>}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )
                    }

                    {/* Edit Client Modal */}
                    {
                        editingClient && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                                <div className="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl relative">
                                    <button onClick={() => setEditingClient(null)} className="absolute top-4 right-4 text-slate-400 hover:text-white">
                                        <Icon name="x" size={20} />
                                    </button>
                                    <h3 className="text-xl font-bold mb-4">Editar Cliente</h3>
                                    <form onSubmit={updateClient} className="space-y-4">
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Nombre y Apellido</label>
                                            <input required value={editingClient.name} onChange={e => setEditingClient({ ...editingClient, name: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Teléfono</label>
                                            <input value={editingClient.phone} onChange={e => setEditingClient({ ...editingClient, phone: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Dirección / Obra</label>
                                            <input value={editingClient.address} onChange={e => setEditingClient({ ...editingClient, address: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Localidad</label>
                                            <input value={editingClient.city} onChange={e => setEditingClient({ ...editingClient, city: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none" />
                                        </div>
                                        <button disabled={isLoading} type="submit" className="w-full flex items-center justify-center py-3 rounded-lg text-sm font-bold uppercase tracking-wider bg-blue-600 hover:bg-blue-500 text-white transition-all disabled:opacity-50">
                                            {isLoading ? 'Guardando...' : 'Guardar Cambios'}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        )
                    }

                    {/* Edit Budget Modal */}
                    {
                        editingBudget && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                                <div className="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl relative">
                                    <button onClick={() => setEditingBudget(null)} className="absolute top-4 right-4 text-slate-400 hover:text-white">
                                        <Icon name="x" size={20} />
                                    </button>
                                    <h3 className="text-xl font-bold mb-4">Editar Presupuesto</h3>
                                    <form onSubmit={updateBudget} className="space-y-4">
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Fecha (YYYY-MM-DD)</label>
                                            <input type="date" required value={editingBudget.date ? editingBudget.date.split('T')[0] : ''} onChange={e => setEditingBudget({ ...editingBudget, date: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none text-slate-200" />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Resumen del Trabajo</label>
                                            <input required value={editingBudget.summary} onChange={e => setEditingBudget({ ...editingBudget, summary: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none text-slate-200" />
                                        </div>
                                        <div>
                                            <label className="text-xs uppercase text-slate-400 block mb-1">Total ($)</label>
                                            <input type="number" required value={editingBudget.total} onChange={e => setEditingBudget({ ...editingBudget, total: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-3 focus:ring-2 ring-blue-500 outline-none text-slate-200" min="0" />
                                        </div>
                                        <button disabled={isLoading} type="submit" className="w-full flex items-center justify-center py-3 rounded-lg text-sm font-bold uppercase tracking-wider bg-orange-600 hover:bg-orange-500 text-white transition-all disabled:opacity-50 mt-6">
                                            {isLoading ? 'Guardando...' : 'Aplicar Cambios'}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        )
                    }
                </div >
            );
        };

        const Quoter = ({ clients, setClients, tenantId }) => {
            const [selectedClient, setSelectedClient] = useState(null);
            const [items, setItems] = useState([{ id: 1, desc: '', qty: 1, price: 0 }]);

            const addItem = () => setItems([...items, { id: Date.now(), desc: '', qty: 1, price: 0 }]);
            const removeItem = (id) => setItems(items.filter(i => i.id !== id));
            const updateItem = (id, field, val) => {
                setItems(items.map(i => i.id === id ? { ...i, [field]: val } : i));
            };

            const total = useMemo(() => items.reduce((acc, i) => acc + i.price, 0), [items]);

            const generatePDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // --- Watermark (Fondo difuminado) ---
                const savedLogo = 'data:image/png;base64,' + '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';
                if (savedLogo) {
                    try {
                        const imgProps = doc.getImageProperties(savedLogo);
                        const pdfWidth = doc.internal.pageSize.getWidth();
                        const pdfHeight = doc.internal.pageSize.getHeight();

                        const maxWidth = 140;
                        const maxHeight = 140;
                        const ratio = Math.min(maxWidth / imgProps.width, maxHeight / imgProps.height);
                        const finalWidth = imgProps.width * ratio;
                        const finalHeight = imgProps.height * ratio;

                        const x = (pdfWidth - finalWidth) / 2;
                        const y = (pdfHeight - finalHeight) / 2 + 10;

                        let type = 'PNG';
                        if (savedLogo.includes('image/jpeg') || savedLogo.includes('image/jpg')) type = 'JPEG';

                        // Aplicar opacidad para efecto difuminado
                        doc.setGState(new doc.GState({ opacity: 0.12 }));
                        doc.addImage(savedLogo, type, x, y, finalWidth, finalHeight);
                        // Restaurar opacidad 100% para todo lo que va por encima
                        doc.setGState(new doc.GState({ opacity: 1.0 }));
                    } catch (e) {
                        console.error("Error al aplicar marca de agua", e);
                    }
                }

                // --- PDF Design Config ---
                const primaryColor = [30, 64, 175]; // Blue 700
                const accentColor = [100, 116, 139]; // Slate 500

                // Add a top accent bar
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 210, 15, 'F');

                // Entity Header
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text("ADMINISTRACIÓN INTERNA", 200, 10, { align: "right" });

                // Company Name
                doc.setTextColor(...primaryColor);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(24);
                doc.text("FABRIZIO AMOBLAMIENTOS", 14, 35);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(...accentColor);
                doc.text("Carpintería de diseño & Amoblamientos a medida", 14, 42);

                // Document Info
                doc.setDrawColor(200, 200, 200);
                doc.line(14, 50, 196, 50);

                doc.setFontSize(14);
                doc.setTextColor(40);
                doc.setFont("helvetica", "bold");
                doc.text("PRESUPUESTO", 14, 60);

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`N°: ${Date.now().toString().slice(-6)}`, 196, 60, { align: "right" });
                doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 196, 66, { align: "right" });

                // Client Info Box
                if (selectedClient) {
                    doc.setFillColor(248, 250, 252); // Slate 50
                    doc.rect(14, 75, 182, 25, 'F');

                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(30, 41, 59);
                    doc.text("CLIENTE", 20, 83);

                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(11);
                    doc.text(`${selectedClient.name}`, 20, 90);
                    doc.setFontSize(9);
                    doc.setTextColor(...accentColor);
                    doc.text(`Tel: ${selectedClient.phone}  |  Obra: ${selectedClient.address}`, 20, 96);
                }

                // Table
                doc.autoTable({
                    startY: 110,
                    head: [['DESCRIPCIÓN / DETALLE DE OBRA', 'CANT.', 'SUBTOTAL']],
                    body: items.map(i => [i.desc.toUpperCase(), i.qty, `$ ${i.price.toLocaleString()}`]),
                    theme: 'grid',
                    headStyles: {
                        fillColor: primaryColor,
                        fontSize: 10,
                        halign: 'left',
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: { cellWidth: 'auto' },
                        1: { cellWidth: 20, halign: 'center' },
                        2: { cellWidth: 40, halign: 'right', fontStyle: 'bold' }
                    },
                    styles: {
                        fontSize: 9,
                        cellPadding: 5
                    }
                });

                // Total Section
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFillColor(241, 245, 249);
                doc.rect(140, finalY, 56, 15, 'F');

                doc.setFontSize(12);
                doc.setTextColor(...primaryColor);
                doc.setFont("helvetica", "bold");
                doc.text("TOTAL:", 145, finalY + 10);
                doc.text(`$ ${total.toLocaleString()}`, 190, finalY + 10, { align: "right" });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.setFont("helvetica", "italic");
                const footerY = 280;
                doc.text("Presupuesto válido por 10 días. Sujeto a variaciones de costo de materiales.", 105, footerY, { align: "center" });
                doc.text("Gracias por elegir Fabrizio Amoblamientos", 105, footerY + 5, { align: "center" });

                doc.save(`Presupuesto_${selectedClient?.name || 'obra'}.pdf`);
            };

            const shareWA = () => {
                if (!selectedClient) return alert('Seleccione un cliente primero');
                const text = `Hola ${selectedClient.name}, adjunto presupuesto de Fabrizio Amoblamientos.\n\nDetalle:\n${items.map(i => `- ${i.desc} (${i.qty}): $${i.price}`).join('\n')}\n\nTOTAL: $${total}\n\nQuedo atento a tus comentarios!`;
                window.open(`https://wa.me/${selectedClient.phone.replace(/\D/g, '')}?text=${encodeURIComponent(text)}`);
            };

            const registerInFile = async () => {
                if (!selectedClient) return alert('Seleccione un cliente primero');
                if (items.some(i => !i.desc)) return alert('Complete las descripciones de los items');

                const summary = items.map(i => `${i.qty}x ${i.desc}`).join(', ').substring(0, 100) + (items.length > 2 ? '...' : '');

                try {
                    const { data, error } = await window.supabaseClient
                        .from('presupuestos')
                        .insert([
                            {
                                tenant_id: tenantId,
                                client_id: selectedClient.id,
                                date: new Date().toISOString(), // Usar ISO para la DB
                                summary: summary,
                                items: items,
                                total: total,
                                paid: 0
                            }
                        ])
                        .select();

                    if (error) throw error;

                    const newBudget = data[0];
                    // Formatear la fecha para la visualización local temporalmente
                    newBudget.date = new Date(newBudget.date).toLocaleString();

                    const updatedClients = clients.map(c => {
                        if (c.id === selectedClient.id) {
                            return {
                                ...c,
                                budgets: [...(c.budgets || []), newBudget]
                            };
                        }
                        return c;
                    });

                    setClients(updatedClients);
                    alert('¡Presupuesto guardado en Supabase y registrado en la ficha del cliente!');
                } catch (error) {
                    console.error('Error al guardar presupuesto:', error);
                    alert("Error al guardar presupuesto: " + error.message);
                }
            };

            return (
                <div className="p-4 md:p-8 pb-20">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                        <h2 className="text-2xl md:text-3xl font-bold">Generador de Presupuestos</h2>
                        <div className="flex flex-wrap gap-2 w-full md:w-auto">
                            <button onClick={registerInFile} className="flex-1 md:flex-none bg-blue-600/30 border border-blue-500/50 hover:bg-blue-600/50 p-2 md:p-3 rounded-lg font-bold flex items-center justify-center gap-2 text-sm text-blue-400">
                                <Icon name="clipboard-check" size={18} /> Registrar en Ficha
                            </button>
                            <button onClick={shareWA} className="flex-1 md:flex-none bg-green-600 hover:bg-green-700 p-2 md:p-3 rounded-lg font-bold flex items-center justify-center gap-2 text-sm">
                                <Icon name="share-2" size={18} /> WhatsApp
                            </button>
                            <button onClick={generatePDF} className="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 p-2 md:p-3 rounded-lg font-bold flex items-center justify-center gap-2 text-sm">
                                <Icon name="download" size={18} /> PDF
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <div className="lg:col-span-1 space-y-6">
                            <div className="glass p-6 rounded-2xl">
                                <h3 className="font-semibold mb-4">1. Seleccionar Cliente</h3>
                                <select onChange={e => setSelectedClient(clients.find(c => c.id == e.target.value))} className="w-full bg-slate-800 p-2 rounded-lg outline-none">
                                    <option value="">-- Seleccionar --</option>
                                    {clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                                {selectedClient && (
                                    <div className="mt-4 text-sm text-slate-400">
                                        <p>{selectedClient.phone}</p>
                                        <p>{selectedClient.address}</p>
                                    </div>
                                )}
                            </div>

                            <div className="glass p-6 rounded-2xl">
                                <h3 className="font-semibold mb-2">Resumen</h3>
                                <div className="flex justify-between text-2xl font-bold text-blue-400">
                                    <span>Total:</span>
                                    <span>${total.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-3 glass p-6 rounded-2xl">
                            <h3 className="font-semibold mb-6 flex justify-between items-center">
                                2. Detalle del Presupuesto
                                <button onClick={addItem} className="text-blue-400 hover:text-blue-300 text-sm flex items-center gap-1">
                                    <Icon name="plus-circle" size={16} /> Agregar Fila
                                </button>
                            </h3>

                            <div className="space-y-4">
                                <div className="hidden md:grid grid-cols-12 gap-4 px-2 text-xs uppercase text-slate-500 font-bold">
                                    <div className="col-span-7">Descripción / Material</div>
                                    <div className="col-span-2 text-center">Cant.</div>
                                    <div className="col-span-3 text-right">Precio</div>
                                </div>
                                {items.map(i => (
                                    <div key={i.id} className="grid grid-cols-12 gap-2 md:gap-4 items-center group glass p-3 md:p-0 md:bg-transparent rounded-xl">
                                        <div className="col-span-12 md:col-span-7 flex gap-2 items-center">
                                            <button onClick={() => removeItem(i.id)} className="md:opacity-0 group-hover:opacity-100 text-red-500 transition-all"><Icon name="trash-2" size={16} /></button>
                                            <input value={i.desc} onChange={e => updateItem(i.id, 'desc', e.target.value)} className="w-full bg-slate-800/50 p-2 rounded-lg outline-none border border-transparent focus:border-blue-500 text-sm" placeholder="Ej: Bajo mesada 1.20m melanina" />
                                        </div>
                                        <div className="col-span-4 md:col-span-2 flex flex-col md:block">
                                            <label className="md:hidden text-[10px] text-slate-500 uppercase font-bold mb-1">Cant.</label>
                                            <input type="number" value={i.qty} onChange={e => updateItem(i.id, 'qty', parseFloat(e.target.value))} className="w-full bg-slate-800/50 p-2 rounded-lg text-center outline-none text-sm" />
                                        </div>
                                        <div className="col-span-8 md:col-span-3 flex flex-col md:block">
                                            <label className="md:hidden text-[10px] text-slate-500 uppercase font-bold mb-1 text-right">Precio Total</label>
                                            <input type="number" value={i.price} onChange={e => updateItem(i.id, 'price', parseFloat(e.target.value))} className="w-full bg-slate-800/50 p-2 rounded-lg text-right outline-none font-mono text-blue-400 text-sm" />
                                        </div>
                                    </div>
                                ))}
                                {items.length === 0 && <div className="text-center py-10 text-slate-500">No hay items en el presupuesto</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PriceList = ({ prices, setPrices, tenantId }) => {
            const [localPrices, setLocalPrices] = useState(prices);
            const [searchQuery, setSearchQuery] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            useEffect(() => {
                fetchPrices();
            }, []);

            // Sincronizar estado local con precios desde arriba si se actualiza externamente
            useEffect(() => {
                setLocalPrices(prices);
            }, [prices]);

            const fetchPrices = async () => {
                setIsLoading(true);
                try {
                    const { data, error } = await window.supabaseClient
                        .from('precios')
                        .select('*')
                        .order('category', { ascending: true });

                    if (error) throw error;
                    setPrices(data || []);
                } catch (error) {
                    console.error('Error al cargar precios:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            const addRow = async () => {
                try {
                    const { data, error } = await window.supabaseClient
                        .from('precios')
                        .insert([
                            {
                                tenant_id: tenantId,
                                category: 'Materia Prima',
                                description: '',
                                price: 0
                            }
                        ])
                        .select();

                    if (error) throw error;

                    if (data && data.length > 0) {
                        const updated = [...localPrices, data[0]];
                        setLocalPrices(updated);
                        setPrices(updated);
                    }
                } catch (error) {
                    console.error('Error al agregar fila:', error);
                    alert("Error al agregar fila: " + error.message);
                }
            };

            const removeRow = async (id) => {
                if (!confirm('¿Eliminar este producto de la lista?')) return;

                try {
                    const { error } = await window.supabaseClient
                        .from('precios')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    const updated = localPrices.filter(p => p.id !== id);
                    setLocalPrices(updated);
                    setPrices(updated);
                } catch (error) {
                    console.error('Error al eliminar fila:', error);
                    alert("Error al eliminar fila: " + error.message);
                }
            };

            const updateField = (id, field, value) => {
                // Actualiza solo localmente
                setLocalPrices(localPrices.map(p => p.id === id ? { ...p, [field]: value } : p));
            };

            const saveChanges = async () => {
                setIsLoading(true);
                try {
                    // Actualizamos cada ítem modificado
                    for (const item of localPrices) {
                        await window.supabaseClient
                            .from('precios')
                            .update({ category: item.category, description: item.description, price: item.price })
                            .eq('id', item.id);
                    }
                    setPrices([...localPrices]);
                    alert('¡Lista de precios guardada correctamente en Supabase!');
                } catch (error) {
                    console.error('Error al guardar cambios de precios:', error);
                    alert("Error al guardar cambios: " + error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const filteredPrices = localPrices.filter(p =>
                p.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
                p.category.toLowerCase().includes(searchQuery.toLowerCase())
            );

            return (
                <div className="p-4 md:p-8 pb-20">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                        <div>
                            <h2 className="text-2xl md:text-3xl font-bold">Lista de Precios</h2>
                            <p className="text-slate-400 text-sm mt-1">Gestión dinámica de productos y servicios</p>
                        </div>
                        <div className="flex flex-wrap gap-2 w-full md:w-auto">
                            <button onClick={saveChanges} disabled={isLoading} className="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 disabled:opacity-50 p-2 md:p-3 rounded-lg font-bold flex items-center justify-center gap-2 text-sm">
                                <Icon name="save" size={18} /> {isLoading ? 'Guardando...' : 'Guardar Cambios'}
                            </button>
                        </div>
                    </div>

                    <div className="glass p-6 rounded-2xl">
                        <div className="flex flex-col md:flex-row justify-between gap-4 mb-6">
                            <div className="relative w-full md:w-96">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                    <Icon name="search" size={16} />
                                </div>
                                <input
                                    type="text"
                                    placeholder="Buscar producto..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="w-full bg-slate-900/50 border border-slate-700 rounded-lg pl-10 p-2 focus:ring-2 ring-blue-500 outline-none text-sm"
                                />
                            </div>
                            <button onClick={addRow} className="bg-slate-800 hover:bg-slate-700 border border-slate-600 px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 text-sm transition-colors">
                                <Icon name="plus" size={16} /> Agregar Producto
                            </button>
                        </div>

                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse">
                                <thead>
                                    <tr className="border-b border-slate-700 text-xs uppercase text-slate-400">
                                        <th className="p-3 font-semibold w-1/4">Categoría</th>
                                        <th className="p-3 font-semibold w-1/2">Descripción</th>
                                        <th className="p-3 font-semibold w-1/5 text-right">Precio Actual ($)</th>
                                        <th className="p-3 font-semibold w-12 text-center"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredPrices.length === 0 ? (
                                        <tr>
                                            <td colSpan="4" className="p-8 text-center text-slate-500 italic">
                                                No hay productos en la lista. Haz clic en "Agregar Producto".
                                            </td>
                                        </tr>
                                    ) : (
                                        filteredPrices.map((item) => (
                                            <tr key={item.id} className="border-b border-slate-800/50 hover:bg-blue-600/5 group transition-colors">
                                                <td className="p-2">
                                                    <input
                                                        type="text"
                                                        value={item.category}
                                                        onChange={(e) => updateField(item.id, 'category', e.target.value)}
                                                        placeholder="Ej: Materia Prima"
                                                        className="w-full bg-transparent border border-transparent hover:border-slate-700 focus:border-blue-500 rounded p-1 outline-none text-sm text-slate-300 transition-colors"
                                                    />
                                                </td>
                                                <td className="p-2">
                                                    <input
                                                        type="text"
                                                        value={item.description}
                                                        onChange={(e) => updateField(item.id, 'description', e.target.value)}
                                                        placeholder="Ej: Melamina Blanca 18mm"
                                                        className="w-full bg-transparent border border-transparent hover:border-slate-700 focus:border-blue-500 rounded p-1 outline-none text-sm text-slate-200 transition-colors"
                                                    />
                                                </td>
                                                <td className="p-2">
                                                    <div className="flex items-center justify-end font-mono">
                                                        <span className="text-slate-500 mr-1">$</span>
                                                        <input
                                                            type="number"
                                                            value={item.price}
                                                            onChange={(e) => updateField(item.id, 'price', e.target.value === '' ? '' : parseFloat(e.target.value))}
                                                            className="w-full max-w-[120px] bg-transparent border border-transparent hover:border-slate-700 focus:border-blue-500 rounded p-1 outline-none text-sm text-blue-400 text-right transition-colors"
                                                        />
                                                    </div>
                                                </td>
                                                <td className="p-2 text-center">
                                                    <button
                                                        onClick={() => removeRow(item.id)}
                                                        className="p-1.5 text-slate-600 hover:text-red-400 hover:bg-red-500/10 rounded transition-colors"
                                                        title="Eliminar fila"
                                                    >
                                                        <Icon name="trash-2" size={16} />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const SupplierManager = ({ suppliers, setSuppliers, tenantId }) => {
            const [newSupplier, setNewSupplier] = useState({ name: '', phone: '', supplies: '' });
            const [isLoading, setIsLoading] = useState(false);

            useEffect(() => {
                fetchSuppliers();
            }, []);

            const fetchSuppliers = async () => {
                setIsLoading(true);
                try {
                    const { data, error } = await window.supabaseClient
                        .from('proveedores')
                        .select('*')
                        .order('id', { ascending: false });

                    if (error) throw error;
                    setSuppliers(data || []);
                } catch (error) {
                    console.error('Error al cargar proveedores:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            const addSupplier = async () => {
                if (!newSupplier.name) return;
                setIsLoading(true);

                try {
                    const { data, error } = await window.supabaseClient
                        .from('proveedores')
                        .insert([
                            {
                                tenant_id: tenantId,
                                name: newSupplier.name,
                                phone: newSupplier.phone,
                                supplies: newSupplier.supplies
                                // debts array omitted for now since Supabase lacks proper JSON handling in this simple setup
                            }
                        ])
                        .select();

                    if (error) throw error;

                    if (data && data.length > 0) {
                        setSuppliers([...suppliers, data[0]]);
                        setNewSupplier({ name: '', phone: '', supplies: '' });
                    }
                } catch (error) {
                    console.error('Error al agregar proveedor:', error);
                    alert("Error al guardar en Supabase: " + error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="p-4 md:p-8 pb-20">
                    <h2 className="text-2xl md:text-3xl font-bold mb-6 md:mb-8">Agenda de Proveedores</h2>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-1 glass p-6 rounded-2xl h-fit">
                            <h3 className="text-xl font-semibold mb-6">Nuevo Proveedor</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Nombre / Empresa</label>
                                    <input value={newSupplier.name} onChange={e => setNewSupplier({ ...newSupplier, name: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="Maderera San José" />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">WhatsApp / Teléfono</label>
                                    <input value={newSupplier.phone} onChange={e => setNewSupplier({ ...newSupplier, phone: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="+54 9..." />
                                </div>
                                <div>
                                    <label className="text-xs uppercase text-slate-400 block mb-1">Insumos (Qué trae)</label>
                                    <input value={newSupplier.supplies} onChange={e => setNewSupplier({ ...newSupplier, supplies: e.target.value })} className="w-full bg-slate-800 border-none rounded-lg p-2 focus:ring-2 ring-blue-500 outline-none" placeholder="Placas, Herrajes..." />
                                </div>
                                <button onClick={addSupplier} disabled={isLoading} className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 p-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2">
                                    <Icon name="truck" /> {isLoading ? 'Guardando...' : 'Guardar Proveedor'}
                                </button>
                            </div>
                        </div>

                        <div className="lg:col-span-2 space-y-4">
                            {suppliers.length === 0 ? (
                                <div className="glass p-10 rounded-2xl text-center text-slate-500">No hay proveedores registrados</div>
                            ) : (
                                suppliers.map(s => {
                                    const totalDebt = (s.debts || []).reduce((acc, d) => acc + d.amount, 0);

                                    const addDebt = async () => {
                                        const amount = prompt("Ingrese monto a AÑADIR a la deuda (ej. 50000):", "");
                                        if (amount === null || isNaN(amount) || amount === "") return;

                                        const desc = prompt("Descripción de la deuda (opcional):", "Compra de mercadería");
                                        const numAmount = parseFloat(amount);
                                        const newDebt = { id: Date.now(), amount: numAmount, desc: desc || "Deuda", date: new Date().toLocaleDateString() };
                                        const updatedArray = [...(s.debts || []), newDebt];

                                        try {
                                            // 1. Guardar en histórico para Estadísticas
                                            await window.supabaseClient.from('transacciones_proveedores').insert([{
                                                tenant_id: tenantId,
                                                supplier_id: s.id,
                                                tipo: 'DEUDA',
                                                monto: numAmount,
                                                descripcion: desc || "Deuda"
                                            }]);

                                            // 2. Guardar JSONB caché en proveedores para visualización en agenda
                                            const { error } = await window.supabaseClient
                                                .from('proveedores')
                                                .update({ debts: updatedArray })
                                                .eq('id', s.id);

                                            // Fallback gracil por si la BD omite JSONB column, para que no explote
                                            if (error && !error.message.includes('column "debts" of relation "proveedores" does not exist')) {
                                                throw error;
                                            }

                                            const updated = suppliers.map(prov =>
                                                prov.id === s.id ? { ...prov, debts: updatedArray } : prov
                                            );
                                            setSuppliers(updated);
                                        } catch (e) {
                                            alert("Error guardando deuda en BD: " + e.message);
                                        }
                                    };

                                    const addPayment = async () => {
                                        const amount = prompt(`Ingrese monto a PAGAR/DESCONTAR de la deuda:\n(Deuda actual: $${totalDebt.toLocaleString()})`, "");
                                        if (amount === null || isNaN(amount) || amount === "") return;

                                        const numAmount = Math.abs(parseFloat(amount));
                                        const newDebt = { id: Date.now(), amount: -numAmount, desc: "Pago realizado a proveedor", date: new Date().toLocaleDateString() };
                                        const updatedArray = [...(s.debts || []), newDebt];

                                        try {
                                            // 1. Guardar en histórico para Estadísticas
                                            await window.supabaseClient.from('transacciones_proveedores').insert([{
                                                tenant_id: tenantId,
                                                supplier_id: s.id,
                                                tipo: 'PAGO',
                                                monto: numAmount,
                                                descripcion: "Pago a proveedor"
                                            }]);

                                            // 2. Guardar JSONB caché en proveedores
                                            const { error } = await window.supabaseClient
                                                .from('proveedores')
                                                .update({ debts: updatedArray })
                                                .eq('id', s.id);

                                            if (error && !error.message.includes('column "debts" of relation "proveedores" does not exist')) {
                                                throw error;
                                            }

                                            const updated = suppliers.map(prov =>
                                                prov.id === s.id ? { ...prov, debts: updatedArray } : prov
                                            );
                                            setSuppliers(updated);
                                        } catch (e) {
                                            alert("Error guardando pago en BD: " + e.message);
                                        }
                                    };

                                    return (
                                        <div key={s.id} className="glass p-6 rounded-2xl group hover:border-blue-500/50 transition-all space-y-4">
                                            <div className="flex items-center justify-between">
                                                <div className="flex gap-4 items-center">
                                                    <div className="w-12 h-12 rounded-full bg-indigo-500/10 flex items-center justify-center text-indigo-400 font-bold text-xl uppercase">
                                                        {s.name[0]}
                                                    </div>
                                                    <div>
                                                        <h4 className="font-semibold text-lg">{s.name}</h4>
                                                        <div className="flex flex-col sm:flex-row sm:gap-4 text-xs sm:text-sm text-slate-400">
                                                            <span className="flex items-center gap-1 text-slate-300 font-medium"><Icon name="package" size={14} /> {s.supplies}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <a href={`tel:${s.phone.replace(/\D/g, '')}`} className="p-2 glass rounded-lg hover:bg-slate-500/20 text-slate-300" title="Llamar"><Icon name="phone" /></a>
                                                    <a href={`https://wa.me/${s.phone.replace(/\D/g, '')}`} target="_blank" className="p-2 glass rounded-lg hover:bg-green-500/20 text-green-400" title="WhatsApp"><Icon name="message-circle" /></a>
                                                    <button onClick={async () => {
                                                        if (confirm('¿Eliminar proveedor?')) {
                                                            try {
                                                                await window.supabaseClient.from('proveedores').delete().eq('id', s.id);
                                                                setSuppliers(suppliers.filter(prev => prev.id !== s.id));
                                                            } catch (e) { alert("Error eliminando: " + e.message); }
                                                        }
                                                    }} className="p-2 glass rounded-lg hover:bg-red-500/20 text-red-400"><Icon name="trash-2" /></button>
                                                </div>
                                            </div>

                                            {/* Financial / Debt Section */}
                                            <div className="border-t border-slate-700/50 pt-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                                <div>
                                                    <span className="text-[10px] uppercase text-slate-500 font-bold block mb-1">Saldo Adeudado</span>
                                                    <span className={`text-2xl font-mono font-bold ${totalDebt > 0 ? 'text-orange-400' : 'text-emerald-500'}`}>
                                                        ${totalDebt.toLocaleString()}
                                                    </span>
                                                </div>
                                                <div className="flex flex-wrap gap-2 w-full md:w-auto">
                                                    <button onClick={addDebt} className="flex-1 md:flex-none bg-orange-500/20 text-orange-400 hover:bg-orange-500/40 px-4 py-2 rounded-lg text-xs font-bold uppercase transition-colors flex items-center justify-center gap-2">
                                                        <Icon name="trending-up" size={14} /> Sumar Deuda
                                                    </button>
                                                    <button onClick={addPayment} className="flex-1 md:flex-none bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/40 px-4 py-2 rounded-lg text-xs font-bold uppercase transition-colors flex items-center justify-center gap-2">
                                                        <Icon name="trending-down" size={14} /> Registrar Pago
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Optional Debt history list if any */}
                                            {(s.debts && s.debts.length > 0) && (
                                                <div className="mt-4 pt-3 border-t border-slate-800">
                                                    <div className="max-h-32 overflow-y-auto space-y-1 pr-2">
                                                        {s.debts.slice().reverse().map(d => (
                                                            <div key={d.id} className="flex justify-between items-center text-xs p-1.5 hover:bg-slate-800/50 rounded">
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-slate-500 font-mono text-[10px]">{d.date}</span>
                                                                    <span className="text-slate-300">{d.desc}</span>
                                                                </div>
                                                                <span className={`font-mono font-bold ${d.amount > 0 ? 'text-orange-400' : 'text-emerald-400'}`}>
                                                                    {d.amount > 0 ? '+' : ''}{d.amount.toLocaleString()}
                                                                </span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Login Component (Supabase Auth) ---
        const Login = () => {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [successMsg, setSuccessMsg] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccessMsg('');
                setIsLoading(true);

                try {
                    // Iniciar Sesión (Única opción)
                    const { data, error: authError } = await window.supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: pass,
                    });
                    if (authError) throw authError;
                    // App.js manejará el estado a través del onAuthStateChange
                } catch (error) {
                    // Traducción básica de errores comunes
                    let msg = error.message;
                    if (msg.includes("Invalid login credentials")) msg = "Credenciales incorrectas";
                    setError(msg);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 p-4">
                    <div className="glass p-8 rounded-2xl w-full max-w-md shadow-2xl border border-slate-700 relative overflow-hidden">

                        {/* Decoración */}
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 to-indigo-500"></div>

                        <div className="text-center mb-8">
                            <div className="bg-blue-600/20 p-4 rounded-full inline-flex mb-4 border border-blue-500/30">
                                <Icon name="log-in" size={32} className="text-blue-400" />
                            </div>
                            <h2 className="text-2xl font-bold text-white tracking-tight">
                                Iniciar Sesión
                            </h2>
                            <p className="text-slate-400 text-sm mt-2">
                                Ingresa tus datos para acceder a tu panel
                            </p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-5">
                            {error && (
                                <div className="bg-red-500/10 text-red-400 p-3 rounded-lg text-sm text-center border border-red-500/20 flex items-center justify-center gap-2">
                                    <Icon name="alert-circle" size={16} /> {error}
                                </div>
                            )}
                            {successMsg && (
                                <div className="bg-emerald-500/10 text-emerald-400 p-3 rounded-lg text-sm text-center border border-emerald-500/20 flex items-center justify-center gap-2">
                                    <Icon name="check-circle" size={16} /> {successMsg}
                                </div>
                            )}

                            <div>
                                <label className="text-[10px] uppercase text-slate-400 block mb-1.5 font-bold tracking-wider">Email</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500 group-focus-within:text-blue-400 transition-colors">
                                        <Icon name="mail" size={18} />
                                    </div>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full bg-slate-900 border border-slate-700 rounded-xl pl-10 p-3 focus:ring-2 focus:border-transparent ring-blue-500 outline-none text-white transition-all text-sm"
                                        placeholder="tu@correo.com"
                                        required
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] uppercase text-slate-400 block mb-1.5 font-bold tracking-wider">Contraseña</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500 group-focus-within:text-blue-400 transition-colors">
                                        <Icon name="key" size={18} />
                                    </div>
                                    <input
                                        type="password"
                                        value={pass}
                                        onChange={(e) => setPass(e.target.value)}
                                        className="w-full bg-slate-900 border border-slate-700 rounded-xl pl-10 p-3 focus:ring-2 focus:border-transparent ring-blue-500 outline-none text-white transition-all text-sm"
                                        placeholder="••••••••"
                                        minLength="6"
                                        required
                                    />
                                </div>
                            </div>

                            <button type="submit" disabled={isLoading} className="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-50 p-3 rounded-xl font-bold transition-all shadow-[0_0_20px_rgba(37,99,235,0.3)] hover:shadow-[0_0_25px_rgba(37,99,235,0.5)] flex items-center justify-center gap-2 mt-4">
                                {isLoading ? <span className="animate-pulse">Cargando...</span> : (
                                    <><Icon name="log-in" size={20} /> Entrar</>
                                )}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const OperativeCosts = ({ tenantId }) => {
            return (
                <div className="p-4 md:p-8 pb-20">
                    <h2 className="text-2xl md:text-3xl font-bold mb-6 md:mb-8 text-orange-400 flex items-center gap-3">
                        <Icon name="receipt" size={28} /> Costos Operativos
                    </h2>
                    <div className="glass p-10 rounded-2xl text-center">
                        <Icon name="hammer" size={48} className="mx-auto text-slate-500 mb-4 opacity-50" />
                        <h3 className="text-xl font-semibold text-slate-300 mb-2">Sección en Construcción</h3>
                        <p className="text-slate-500 max-w-md mx-auto">
                            Este es el contenedor vacío preparado para la lógica de Costos Operativos que necesites.
                        </p>
                    </div>
                </div>
            );
        };

        const Statistics = ({ tenantId }) => {
            const [stats, setStats] = useState({ owed: 0, collected: 0, toPay: 0, costs: 0 });
            const [chartData, setChartData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            // Visibility Toggles (Ojitos state)
            const [showOwed, setShowOwed] = useState(true);
            const [showCollected, setShowCollected] = useState(true);
            const [showToPay, setShowToPay] = useState(true);

            // Fetch Data
            useEffect(() => {
                if (!tenantId) return;

                const loadDashboardData = async () => {
                    setIsLoading(true);
                    try {
                        const { data: clientsData } = await window.supabaseClient.from('clientes').select('id, budgets:presupuestos(total, paid)').eq('tenant_id', tenantId);
                        let totalOwed = 0;
                        let totalCollected = 0;
                        if (clientsData) {
                            clientsData.forEach(c => {
                                if (c.budgets) {
                                    c.budgets.forEach(b => {
                                        const total = b.total || 0;
                                        const paid = b.paid || 0;
                                        totalCollected += paid;
                                        totalOwed += (total - paid);
                                    });
                                }
                            });
                        }

                        const { data: suppliersData } = await window.supabaseClient.from('proveedores').select('debts').eq('tenant_id', tenantId);
                        let totalToPay = 0;
                        if (suppliersData) {
                            suppliersData.forEach(s => {
                                if (s.debts) {
                                    totalToPay += s.debts.reduce((acc, d) => acc + (d.amount || 0), 0);
                                }
                            });
                        }

                        setStats({ owed: totalOwed, collected: totalCollected, toPay: totalToPay, costs: 0 });

                        const { data: transClientes } = await window.supabaseClient.from('transacciones_clientes').select('*').eq('tenant_id', tenantId);
                        const { data: transProveedores } = await window.supabaseClient.from('transacciones_proveedores').select('*').eq('tenant_id', tenantId);

                        const monthlyData = {};

                        const getMonthYear = (dateString) => {
                            const d = new Date(dateString);
                            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                            return `${months[d.getMonth()]} ${d.getFullYear()}`;
                        };

                        (transClientes || []).forEach(tc => {
                            if (tc.tipo === 'COBRO') {
                                const my = getMonthYear(tc.created_at);
                                if (!monthlyData[my]) monthlyData[my] = { name: my, Entradas: 0, Salidas: 0, Orden: new Date(tc.created_at).getTime() };
                                monthlyData[my].Entradas += Number(tc.monto);
                            }
                        });

                        (transProveedores || []).forEach(tp => {
                            if (tp.tipo === 'PAGO') {
                                const my = getMonthYear(tp.created_at);
                                if (!monthlyData[my]) monthlyData[my] = { name: my, Entradas: 0, Salidas: 0, Orden: new Date(tp.created_at).getTime() };
                                monthlyData[my].Salidas += Math.abs(Number(tp.monto));
                            }
                        });

                        const sortedChartData = Object.values(monthlyData).sort((a, b) => a.Orden - b.Orden);
                        setChartData(sortedChartData);

                    } catch (e) {
                        console.error("Error loading stats", e);
                    } finally {
                        setIsLoading(false);
                    }
                };

                loadDashboardData();
            }, [tenantId]);

            return (
                <div className="p-4 md:p-8 pb-20">
                    <h2 className="text-2xl md:text-3xl font-bold mb-6 md:mb-8 text-blue-400 flex items-center gap-3">
                        <Icon name="bar-chart-2" size={28} /> Estadísticas {isLoading && <Icon name="loader" size={24} className="animate-spin text-slate-500" />}
                    </h2>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        {/* LEFT PANEL: KPIs & Toggles */}
                        <div className="lg:col-span-1 space-y-4">

                            {/* Card 1: Adeudado */}
                            <div className="glass rounded-xl overflow-hidden border border-blue-500/20 group relative">
                                <div className="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-bl-full -z-10"></div>
                                <div className="p-5">
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="text-sm font-bold uppercase text-slate-300">Total Adeudado</h3>
                                        <button onClick={() => setShowOwed(!showOwed)} className={`p-1.5 rounded-lg transition-colors ${showOwed ? 'bg-blue-500/20 text-blue-400' : 'bg-slate-800 text-slate-500 hover:bg-slate-700'}`}>
                                            <Icon name={showOwed ? "eye" : "eye-off"} size={16} />
                                        </button>
                                    </div>
                                    <p className="text-2xl font-mono font-bold text-white mb-1">
                                        {isLoading ? '...' : (showOwed ? `$${stats.owed.toLocaleString()}` : '****')}
                                    </p>
                                    <p className="text-[10px] text-slate-400 uppercase">Suma de deudas de Clientes</p>
                                </div>
                            </div>

                            {/* Card 2: Cobrado */}
                            <div className="glass rounded-xl overflow-hidden border border-blue-500/20 group relative">
                                <div className="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-bl-full -z-10"></div>
                                <div className="p-5">
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="text-sm font-bold uppercase text-slate-300">Total Cobrado</h3>
                                        <button onClick={() => setShowCollected(!showCollected)} className={`p-1.5 rounded-lg transition-colors ${showCollected ? 'bg-blue-500/20 text-blue-400' : 'bg-slate-800 text-slate-500 hover:bg-slate-700'}`}>
                                            <Icon name={showCollected ? "eye" : "eye-off"} size={16} />
                                        </button>
                                    </div>
                                    <p className="text-2xl font-mono font-bold text-white mb-1">
                                        {isLoading ? '...' : (showCollected ? `$${stats.collected.toLocaleString()}` : '****')}
                                    </p>
                                    <p className="text-[10px] text-slate-400 uppercase">Suma cobrada de Clientes</p>
                                </div>
                            </div>

                            {/* Card 3: A Pagar */}
                            <div className="glass rounded-xl overflow-hidden border border-blue-500/20 group relative">
                                <div className="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-bl-full -z-10"></div>
                                <div className="p-5">
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="text-sm font-bold uppercase text-slate-300">Total a Pagar</h3>
                                        <button onClick={() => setShowToPay(!showToPay)} className={`p-1.5 rounded-lg transition-colors ${showToPay ? 'bg-blue-500/20 text-blue-400' : 'bg-slate-800 text-slate-500 hover:bg-slate-700'}`}>
                                            <Icon name={showToPay ? "eye" : "eye-off"} size={16} />
                                        </button>
                                    </div>
                                    <p className="text-2xl font-mono font-bold text-white mb-1">
                                        {isLoading ? '...' : (showToPay ? `$${stats.toPay.toLocaleString()}` : '****')}
                                    </p>
                                    <p className="text-[10px] text-slate-400 uppercase">Suma de deudas a Proveedores</p>
                                </div>
                            </div>

                            {/* Card 4: Costos Repetidor */}
                            <div className="glass bg-blue-900/20 rounded-xl overflow-hidden border border-blue-500/30 group relative mt-8 flex flex-col items-center justify-center p-5">
                                <h3 className="text-sm font-bold uppercase text-blue-300 mb-2">Costos Operativos</h3>
                                <p className="text-xl font-mono font-bold text-blue-100 mb-1">
                                    {isLoading ? '...' : `$${stats.costs.toLocaleString()}`}
                                </p>
                                <p className="text-[10px] text-blue-300/60 uppercase text-center">Suma de todos los costos (Próximamente)</p>
                            </div>

                        </div>

                        {/* RIGHT PANEL: Chart Area */}
                        <div className="lg:col-span-3 glass p-6 rounded-2xl flex flex-col">
                            <h3 className="text-lg font-bold text-slate-200 mb-6 flex items-center gap-2"><Icon name="activity" /> Flujo de Caja Mensual</h3>
                            <div className="flex-grow flex items-center justify-center min-h-[400px]">
                                {isLoading ? (
                                    <div className="text-slate-400 text-center relative w-full h-full flex flex-col items-center justify-center">
                                        <Icon name="loader" size={48} className="mx-auto mb-4 animate-[spin_2s_linear_infinite] opacity-50" />
                                        <span className="animate-pulse">Calculando gráficas Recharts...</span>
                                    </div>
                                ) : (!window.Recharts || !window.Recharts.ResponsiveContainer) ? (
                                    <div className="text-center text-slate-500">
                                        <Icon name="loader" size={48} className="mx-auto opacity-30 mb-4 animate-[spin_2s_linear_infinite]" />
                                        <span className="block text-sm">Cargando módulos de gráficas...</span>
                                    </div>
                                ) : chartData.length === 0 ? (
                                    <div className="text-center text-slate-500">
                                        <Icon name="x-circle" size={48} className="mx-auto opacity-30 mb-4" />
                                        <span className="block text-sm">No hay flujos de pagos o cobros recientes.</span>
                                    </div>
                                ) : (
                                    <window.Recharts.ResponsiveContainer width="100%" height="100%">
                                        <window.Recharts.LineChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>
                                            <window.Recharts.CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                            <window.Recharts.XAxis dataKey="name" stroke="#94a3b8" tick={{ fill: '#94a3b8', fontSize: 12 }} tickLine={false} axisLine={false} />
                                            <window.Recharts.YAxis stroke="#94a3b8" tick={{ fill: '#94a3b8', fontSize: 12 }} tickLine={false} axisLine={false} tickFormatter={(value) => `$${value / 1000}k`} />
                                            <window.Recharts.Tooltip
                                                contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #475569', borderRadius: '8px', color: '#f8fafc' }}
                                                itemStyle={{ fontWeight: 'bold' }}
                                                formatter={(value) => [`$${value.toLocaleString()}`, '']}
                                            />
                                            <window.Recharts.Legend wrapperStyle={{ paddingTop: '20px' }} />
                                            {(showCollected) && <window.Recharts.Line type="monotone" name="Ingresos (Cobrado)" dataKey="Entradas" stroke="#10b981" strokeWidth={3} dot={{ r: 4, fill: '#10b981', strokeWidth: 0 }} activeDot={{ r: 6 }} />}
                                            {(showToPay || showOwed) && <window.Recharts.Line type="monotone" name="Egresos (Pagado)" dataKey="Salidas" stroke="#ef4444" strokeWidth={3} dot={{ r: 4, fill: '#ef4444', strokeWidth: 0 }} activeDot={{ r: 6 }} />}
                                        </window.Recharts.LineChart>
                                    </window.Recharts.ResponsiveContainer>
                                )}
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [session, setSession] = useState(null);
            const [tenantId, setTenantId] = useState(null);
            const [isCheckingSession, setIsCheckingSession] = useState(true);

            const [tab, setTab] = useState('clients');
            // Default open on desktop, closed on mobile
            const [sidebarOpen, setSidebarOpen] = useState(window.innerWidth > 1024);
            const [clients, setClients] = useState(() => {
                try {
                    const saved = localStorage.getItem('fabrizio_clients');
                    return saved ? JSON.parse(saved) : [];
                } catch { return []; }
            });
            const [prices, setPrices] = useState(() => {
                const defaultPrices = [
                    { id: 1, category: 'Materia Prima', description: 'Placa Melamina Blanca 18mm (1.83x2.75)', price: 35000 },
                    { id: 2, category: 'Herrajes', description: 'Bisagra Cazoleta 35mm Codo 0', price: 850 },
                    { id: 3, category: 'Servicios', description: 'Corte por pieza', price: 300 }
                ];
                try {
                    const saved = localStorage.getItem('fabrizio_prices');
                    const parsed = saved ? JSON.parse(saved) : null;
                    return (parsed && Array.isArray(parsed)) ? parsed : defaultPrices;
                } catch { return defaultPrices; }
            });
            const [suppliers, setSuppliers] = useState(() => {
                try {
                    const saved = localStorage.getItem('fabrizio_suppliers');
                    return saved ? JSON.parse(saved) : [];
                } catch { return []; }
            });

            useEffect(() => {
                localStorage.setItem('fabrizio_clients', JSON.stringify(clients));
            }, [clients]);

            useEffect(() => {
                localStorage.setItem('fabrizio_prices', JSON.stringify(prices));
            }, [prices]);

            useEffect(() => {
                localStorage.setItem('fabrizio_suppliers', JSON.stringify(suppliers));
            }, [suppliers]);

            // Subscripción a estado de autenticación de Supabase
            useEffect(() => {
                if (!window.supabaseClient) {
                    setIsCheckingSession(false);
                    return;
                }

                // Estado al cargar por primera vez
                window.supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (!session) setIsCheckingSession(false);
                    else fetchTenantId(session.user.id);
                });

                // Escuchar cambios (login, logout, token refresh)
                const { data: { subscription } } = window.supabaseClient.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if (session) fetchTenantId(session.user.id);
                });

                return () => subscription?.unsubscribe();
            }, []);

            const fetchTenantId = async (uid) => {
                try {
                    const { data, error } = await window.supabaseClient.from('usuarios').select('tenant_id').eq('id', uid).single();
                    if (data && data.tenant_id !== undefined && data.tenant_id !== null) {
                        setTenantId(data.tenant_id);
                        setIsCheckingSession(false);
                    } else {
                        setTimeout(async () => {
                            const { data: retryData } = await window.supabaseClient.from('usuarios').select('tenant_id').eq('id', uid).single();
                            if (retryData) setTenantId(retryData.tenant_id);
                            setIsCheckingSession(false);
                        }, 1000);
                    }
                } catch (e) { console.error(e); setIsCheckingSession(false); }
            };

            const handleLogout = async () => {
                if (confirm('¿Seguro que deseas cerrar sesión?')) {
                    await window.supabaseClient.auth.signOut();
                }
            };

            if (isCheckingSession) {
                return <div className="min-h-screen flex items-center justify-center bg-slate-900 text-slate-400">Verificando sesión...</div>;
            }

            if (!session) {
                return <Login />;
            }

            if (tenantId === null) {
                return <div className="min-h-screen flex items-center justify-center bg-slate-900 text-slate-400">Generando Tenant ID de empresa...</div>;
            }

            return (
                <div className="flex bg-slate-900 min-h-screen relative overflow-x-hidden">
                    <Sidebar currentTab={tab} setTab={setTab} isOpen={sidebarOpen} setIsOpen={setSidebarOpen} onLogout={handleLogout} />

                    <main className={`flex-grow transition-all duration-300 min-h-screen ml-0 lg:ml-64`}>
                        {/* Persistent Header with Toggle */}
                        <div className="flex items-center justify-between p-4 glass sticky top-0 z-30">
                            <div className="flex items-center gap-3">
                                <button
                                    onClick={() => setSidebarOpen(!sidebarOpen)}
                                    className="p-2 glass rounded-lg text-white hover:bg-blue-600/20 transition-colors lg:hidden"
                                    title={sidebarOpen ? "Cerrar menú" : "Abrir menú"}
                                >
                                    <Icon name={sidebarOpen ? "chevron-left" : "menu"} size={24} />
                                </button>
                                <div className="flex items-center gap-2">
                                    <div className="bg-blue-600 p-1.5 rounded-lg">
                                        <Icon name="hammer" size={20} />
                                    </div>
                                    <span className="font-bold tracking-tight text-white hidden sm:inline">Fabrizio Admin</span>
                                </div>
                            </div>

                            <div className="flex items-center gap-2 text-sm text-slate-400">
                                <Icon name="clock" size={14} />
                                {new Date().toLocaleDateString()}
                            </div>
                        </div>

                        {tab === 'clients' && <ClientManager clients={clients} setClients={setClients} tenantId={tenantId} />}
                        {tab === 'quoter' && <Quoter clients={clients} setClients={setClients} tenantId={tenantId} />}
                        {tab === 'prices' && <PriceList prices={prices} setPrices={setPrices} tenantId={tenantId} />}
                        {tab === 'suppliers' && <SupplierManager suppliers={suppliers} setSuppliers={setSuppliers} tenantId={tenantId} />}
                        {tab === 'costs' && <OperativeCosts tenantId={tenantId} />}
                        {tab === 'statistics' && <Statistics tenantId={tenantId} />}

                    </main>
                </div>
            );
        };
        // --- Error Boundary Fallback ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                this.setState({ error: error, errorInfo: errorInfo });
                console.error("React Crash capturado:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="bg-slate-900 text-white min-h-screen p-8">
                            <h2 className="text-red-500 text-3xl font-bold mb-4">La aplicación ha crasheado 🛑</h2>
                            <p className="text-slate-300 mb-4">Por favor envía una captura de esta pantalla al soporte técnico:</p>
                            <div className="bg-slate-800 p-4 rounded text-sm font-mono overflow-auto mb-4 border border-red-500/50">
                                <span className="text-red-400 font-bold block">{this.state.error && this.state.error.toString()}</span>
                                <pre className="text-slate-400 mt-2">{this.state.errorInfo && this.state.errorInfo.componentStack}</pre>
                            </div>
                            <button onClick={() => window.location.reload()} className="bg-blue-600 px-4 py-2 rounded font-bold">
                                Recargar Página
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>

</html>